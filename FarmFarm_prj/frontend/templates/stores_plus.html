{% extends "base_2.html" %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/stores_plus.css' %}" />
{% endblock style %}

{% block script %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8&libraries=services"></script>
<script>
const addressInput = document.getElementById('addressInput');
const latitudeInput = document.getElementById('latitudeInput');
const longitudeInput = document.getElementById('longitudeInput');
const geocoder = new kakao.maps.services.Geocoder();

let map, marker;

// ì§€ë„ ëª¨ë‹¬ ì—´ê¸°
document.getElementById('mapBtn').onclick = function() {
    document.getElementById('mapModal').style.display = 'block';
    setTimeout(function() {
        let initLat = parseFloat(latitudeInput.value) || 37.6509;
        let initLng = parseFloat(longitudeInput.value) || 127.0164;
        const initPos = new kakao.maps.LatLng(initLat, initLng);
        mapInit(initPos);
    }, 100); // ëª¨ë‹¬ì´ ì—´ë¦° ë’¤ì— ì§€ë„ ì´ˆê¸°í™”
};

// ì§€ë„ ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('closeModal').onclick = function() {
    document.getElementById('mapModal').style.display = 'none';
};

// ì§€ë„ ì´ˆê¸°í™”
function mapInit(center) {
    if (!map) {
        map = new kakao.maps.Map(document.getElementById('mapContainer'), {
            center: center,
            level: 3
        });
    } else {
        map.setCenter(center);
    }

    if (!marker) {
        marker = new kakao.maps.Marker({ position: center, map: map });
    } else {
        marker.setPosition(center);
    }

    // ì§€ë„ í´ë¦­ ì‹œ ì£¼ì†Œ/ì¢Œí‘œ ë°˜ì˜
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const latlng = mouseEvent.latLng;
        marker.setPosition(latlng);

        geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK && result[0].address.address_name) {
                addressInput.value = result[0].address.address_name;
                latitudeInput.value = latlng.getLat();
                longitudeInput.value = latlng.getLng();
            } else {
                alert("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨. í•œê¸€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                latitudeInput.value = latlng.getLat();
                longitudeInput.value = latlng.getLng();
            }
        });
    });
}
// ì œë³´ í¼ ìŒì„± ì¸ì‹ ê¸°ëŠ¥
const reportVoiceBtn = document.getElementById('voiceBtn');
const reportVoiceStatus = document.getElementById('voiceStatus');
let mediaRecorderReport = null;
let audioChunksReport = [];
let currentStreamReport = null;

reportVoiceBtn.addEventListener('click', async () => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì…ë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    // ë…¹ìŒ ì¤‘ì´ë©´ ì¤‘ì§€
    if (mediaRecorderReport && mediaRecorderReport.state === "recording") {
        mediaRecorderReport.stop();
        if (currentStreamReport) {
            currentStreamReport.getTracks().forEach(track => track.stop());
            currentStreamReport = null;
        }
        return;
    }

    // ë…¹ìŒ ì‹œì‘
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        currentStreamReport = stream; 
        mediaRecorderReport = new MediaRecorder(stream);
        audioChunksReport = [];

        mediaRecorderReport.ondataavailable = e => audioChunksReport.push(e.data);

        mediaRecorderReport.onstart = () => {
            reportVoiceStatus.textContent = "ğŸ¤ ë…¹ìŒ ì¤‘...";
            reportVoiceBtn.textContent = "â¹ï¸ ë…¹ìŒ ì¤‘ì§€";
        };

        mediaRecorderReport.onstop = async () => {
            if (currentStreamReport) {
                currentStreamReport.getTracks().forEach(track => track.stop());
                currentStreamReport = null;
            }
            const audioBlob = new Blob(audioChunksReport);
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);

            reader.onloadend = async () => {
                const base64Audio = reader.result;
                reportVoiceStatus.textContent = "â³ ì„œë²„ ì²˜ë¦¬ ì¤‘...";
                reportVoiceBtn.textContent = "ğŸ¤ ìŒì„± ì¸ì‹";

                try {
                    const response = await fetch("{% url 'stores:voice_input' %}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ audio: base64Audio, form_type: 'report' })
                    });

                    const data = await response.json();
                    if (!data.form_data) {
                        reportVoiceStatus.textContent = "âš ï¸ ìŒì„± ì²˜ë¦¬ ì‹¤íŒ¨";
                        return;
                    }

                    const formData = data.form_data;

                    // store_name
                    if (formData.store_name) {
                        const storeNameInput = document.getElementById('id_store_name');
                        if (storeNameInput) storeNameInput.value = formData.store_name;
                    }

                    // report_items
                    if (formData.report_items) {
                        const reportItemsInput = document.getElementById('id_report_items');
                        if (reportItemsInput) reportItemsInput.value = formData.report_items;
                    }

                    // time
                    if (formData.time) {
                        const timeInput = document.getElementById('id_time');
                        if (timeInput) timeInput.value = formData.time;
                    }

                    // address
                    if (formData.address) {
                        const addressInput = document.getElementById('addressInput');
                        if (addressInput) addressInput.value = formData.address;
                    }


                    // ìœ„ë„/ê²½ë„ ìë™ ì„¤ì • (Geminiê°€ ì£¼ì†Œë§Œ ì£¼ë©´ geocoderë¡œ ë³€í™˜ ê°€ëŠ¥)
                    if (formData.address) {
                        const geocoder = new kakao.maps.services.Geocoder();
                        geocoder.addressSearch(formData.address, function(result, status) {
                            if (status === kakao.maps.services.Status.OK && result.length > 0) {
                                document.getElementById('latitudeInput').value = result[0].y;
                                document.getElementById('longitudeInput').value = result[0].x;
                            } else {
                                alert("ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§€ë„ì—ì„œ ì§ì ‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
                                document.getElementById('latitudeInput').value = "";
                                document.getElementById('longitudeInput').value = "";
                            }
                        });
                    }

                    // í‚¤ì›Œë“œ ìë™ ì²´í¬ (formData.keywordsê°€ ë°°ì—´ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ)
                    if (formData.keywords) {
                        let keywordsArr = Array.isArray(formData.keywords)
                            ? formData.keywords
                            : String(formData.keywords).split(',').map(s => s.trim());

                        keywordsArr.forEach(keywordText => {
                            document.querySelectorAll('input[name="keywords"]').forEach(checkbox => {
                                const label = checkbox.parentElement;
                                // í•œê¸€ë„ í¬í•¨ ì—¬ë¶€ ì²´í¬ ê°€ëŠ¥!
                                if (
                                    label &&
                                    label.textContent.replace(/\s/g, '').toLowerCase().includes(
                                        keywordText.replace(/\s/g, '').toLowerCase()
                                    )
                                ) {
                                    checkbox.checked = true;
                                }
                            });
                        });
                    }

                    reportVoiceStatus.textContent = "âœ… ìŒì„± ì…ë ¥ ì™„ë£Œ";
                } catch (err) {
                    console.error(err);
                    reportVoiceStatus.textContent = "âŒ ì„œë²„ ì˜¤ë¥˜";
                }
            };
        };

        mediaRecorderReport.start();
    } catch (err) {
        console.error(err);
        reportVoiceStatus.textContent = "âŒ ë§ˆì´í¬ ì ‘ê·¼ ê±°ë¶€ë¨";
    }
});
</script>
<script src="{% static 'js/stores_plus.js' %}"></script>
{% endblock script %}

{% block body %}
<div class="welcome_overlay"></div>

<div class="big_hugger">
  <div class="container">
    <form method="post" enctype="multipart/form-data" id="reportForm">
    {% csrf_token %}
    <img src="{% static 'img/map_deco.png' %}" alt="ìœ„ ë°ì½”" class="deco" />
    <img src="{% static 'img/left_back_neon.png' %}" alt="ë’¤ë¡œê°€ê¸°" class="before_page" onclick="history.back()" />

    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div class="gapsection">
      <label class="section-title">ì´ë¯¸ì§€</label>
      <div class="file_upload">
        <!-- íŒŒì¼ ì—…ë¡œë“œ input -->
        <input type="file" name="image" id="id_image" name="store_photo" accept="image/*" style="display: none;" />

        <!-- ì•„ì´ì½˜ -->
        <label for="id_image" class="upload_label">
          <img src="{% static 'img/add_photo.png' %}" alt="upload" class="upload_icon" />
        </label>

        <!-- ë§í’ì„  -->
        <div class="text_box_text">
          <img src="{% static 'img/textbox/text_box.png' %}" alt="ë§í’ì„ " class="textbox" />
          <span class="texts">ëˆ„ë¥´ë©´ <span style="color:grey;">ê°¤ëŸ¬ë¦¬ë¡œ ì—°ê²°ë¼ìš”!</span></span>
        </div>

        <!-- ì—…ë¡œë“œëœ íŒŒì¼ ì •ë³´ -->
        <div class="file_info_wrap" style="display: none;">
          <span class="file_name"></span>
          <button type="button" class="delete_file_btn">ì‚­ì œ</button>
        </div>
      </div>
    </div>

    <!-- ê°€ê²Œ ì´ë¦„ -->
    <div class="section">
      <label class="section-title">ê°€ê²Œì´ë¦„</label>
      <input type="text" name="store_name" id="id_store_name" class="text-input" value="{{ form.store_name.value|default_if_none:'' }}" placeholder="ì…ë ¥í•˜ì‹œì˜¤..." />
    </div>

    <!-- ìŒì‹ ì¢…ë¥˜ -->
    <div class="section">
      <label class="section-title">ìŒì‹ì¢…ë¥˜</label>
      <input type="text" name="report_items" id="id_report_items" value="{{ form.report_items.value|default_if_none:'' }}" class="text-input" placeholder="ì…ë ¥í•˜ì‹œì˜¤..." />
    </div>
    <!-- ì¥ì†Œ -->
    <div class="section">
      <label class="section-title">ì¥ì†Œ</label>
      <input type="hidden" id="latitudeInput" name="latitude" value="">
      <input type="hidden" id="longitudeInput" name="longitude" value="">
      <input type="text" id="addressInput" name="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì§€ë„ì—ì„œ ì„ íƒ">
      <button type="button" id="mapBtn">ì§€ë„ì—ì„œ ìœ„ì¹˜ ì„ íƒ</button>    
    </div>

    <!-- ì‹œê°„ -->
    <div class="gapsection">
      <label class="section-title">ì‹œê°„</label>
      <input type="text" name="time" id="id_time" value="{{ form.time.value|default_if_none:'' }}" class="text-input" placeholder="ì…ë ¥í•˜ì‹œì˜¤..." />
    </div>

    <!-- í‚¤ì›Œë“œ -->
    <div class="keyword_section">
      <label class="section-title">#í‚¤ì›Œë“œ</label>
      <div class="keyword-list">
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="ì‹ ì„ í•´ìš”" hidden>#ì‹ ì„ í•´ìš”
        </label>
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="ì €ë ´í•´ìš”" hidden>#ì €ë ´í•´ìš”
        </label>
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="ì¹œì ˆí•´ìš”" hidden>#ì¹œì ˆí•´ìš”
        </label>
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="êµ­ë‚´ì‚°" hidden>#êµ­ë‚´ì‚°
        </label>
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="ë§¤ì¼íŒë§¤" hidden>#ë§¤ì¼íŒë§¤
        </label>
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="í• ì¸ìˆì–´ìš”" hidden>#í• ì¸ìˆì–´ìš”
        </label>
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="ì •ì§í•´ìš”" hidden>#ì •ì§í•´ìš”
        </label>
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="í•œì •íŒë§¤" hidden>#í•œì •íŒë§¤
        </label>
        <label class="keyword-option">
          <input type="checkbox" name="keywords" value="ìˆ˜í™•ì§ì†¡" hidden>#ìˆ˜í™•ì§ì†¡
        </label>
      </div>
    </div>
    <!-- ë“±ë¡ ë²„íŠ¼ -->
    <div class="btn_hugger">
      <div class="voice_recognization">
        <div class="voice_texts">
          <img src="{% static 'img/textbox/text_box.png' %}" alt="ë§í’ì„ " class="voice_textbox" />
          <span class="texts">ìŒì„±ë…¹ìŒ <span style="color:grey;">ë“±ë¡ì´ ê°€ëŠ¥í•´ìš”!</span></span>
        </div>
        <button class="circle_btn">
          <img src="{% static 'img/mic.png' %}" alt="ìŒì„±ì¸ì‹ë²„íŠ¼" class="voice_recognization_btn" />
        </button>
      </div>
      <button type="submit" class="register_btn">ë“±ë¡í•˜ê¸°</button>
    </div>
  </form>
  </div>

  
</div>

<!-- ìŒì„± ì¸ì‹ ëª¨ë‹¬ -->
<div class="voice_modal hidden">
  <div class="voice_modal_overlay"></div>
  <div class="voice_modal_content">
    <button class="voice_modal_close">âœ•</button>
    <div class="text_box_area">
      <img src="{% static 'img/textbox/vertical_text_box.png' %}" alt="ë§í’ì„ " class="voice_modal_ann">
      <div class="ann_text">ë²„íŠ¼ì„ ëˆ„ë¥´ê³ , ë§í•˜ì„¸ìš”!</div>
    </div>
    <div class="voice_recognizing_btn">
      <button type="button" id="voiceBtn" data-form-type="report">
        <img src="{% static 'img/mic_neon.png' %}" alt="ìŒì„± ì¸ì‹ ë²„íŠ¼" class="voice_modal_mic">
      </button>
      <span id="voiceStatus" style="margin-left:10px;color:#555;">(ë…¹ìŒ ìƒíƒœ í‘œì‹œ)</span>
    </div>
  </div>
</div>

<!-- ì§€ë„ ëª¨ë‹¬ -->
<div id="mapModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; z-index:1000; border:1px solid #ccc;">
    <div style="text-align:right; padding:5px;">
        <button id="closeModal">ë‹«ê¸°</button>
    </div>
    <div id="mapContainer" style="width:100%; height:90%;"></div>
</div>

<!-- í™˜ì˜ ë©”ì‹œì§€ -->
<div class="welcome_content">
  <p class="welcoming">
    <img src="{% static 'img/smiling_brocoli.png' %}" alt="ì›ƒëŠ” ë¸Œë¡œì½œë¦¬" class="welcoming_brocoli">
    ê°€ê²Œë¥¼
    <span class="green_highlight"> ë“±ë¡</span>
    í•´ì£¼ì…”ì„œ
    <img src="{% static 'img/tongue_face.png' %}" alt="í˜€ë‚´ë¯¼ í‘œì •" class="face">
    <br>
    <span class="green_highlight_">ê°ì‚¬í•©ë‹ˆë‹¤!</span>
    <img src="{% static 'img/welcome_boom.png' %}" alt="ì¶•í•˜ í­ì£½" class="welcome_boom">
  </p>
  <p class="under_texts">
    <span class="sub_text">
      ìš°ë¦¬ ë™ë„¤ ì†ë‹˜ë“¤ê³¼ì˜ ë§Œë‚¨ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤.
    </span>
  </p>
</div>
{% endblock body %}
