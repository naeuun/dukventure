{% extends "base_2.html" %} {% load static %} {% block style %}
<link
  rel="stylesheet"
  href="{% static 'css/consumer_home/reservation_home.css' %}"
/>
{% endblock style %}
{% block body %}
<div class="page">
  <!-- 상단바 -->
  <header class="topbar">
    <a href="{% url 'users:buyer_home' %}" class="back-btn" aria-label="뒤로가기">
      <img src="{% static 'img/cha_exit.png' %}" alt="뒤로가기" />
    </a>
    <div class="leaf-row">
      <img src="{% static 'img/res_gra2.png' %}" alt="장식" />
    </div>
  </header>

  <main class="content">
    {% for r in reservations %}
    <section class="card card--hero">
        <div class="card__image">
        {% with item=r.items.first %} 
            {% if item.image %}
            <img src="{{ item.image.url }}" alt="{{ item.item_name }}" />
            {% else %}
            <img src="https://placehold.co/120x80/2a2a2a/cccccc?text={{ item.item_name|default:'상품' }}" alt="{{ item.item_name }}" />
            {% endif %}
        {% endwith %}
        </div>

        <div class="card__info">
        <ul>
            <li>판매자: {{ r.store.seller.user.username }}</li>
            <li>위치: {{ r.store.address }}</li>
            <li>판매 시간: {{ r.store.sale_hours }}</li>
            <li>가격: {{ r.total_price }}원</li>
            <li>
            개수:
            {% with first_item=r.items.all|first %}
                {{ first_item.unit }}× {{ first_item.quantity }}
            {% endwith %}
            </li>
            <li>요청 픽업 시간 : {{ r.requested_pickup_at|date:"Y-m-d H:i" }}</li>
        </ul>
        </div>
    </section>

    <div class="card-actions-row">
      <!-- 수락 대기 중일 때 -->
      {% if r.status == 'PENDING' %}
        <button type="button" class="btn status-btn">수락 대기중</button>
        <button class="btn action-btn" type="button" disabled aria-disabled="true">픽업 전</button>
      <!-- 판매자가 수락했을 때 -->
      {% elif r.status == 'ACCEPTED' %}
        {% if r.remaining_minutes > 0 %}
            <button type="button" class="btn status-btn">{{ r.remaining_minutes|floatformat:"0" }}분 후 픽업 가능</button>
            <button class="btn action-btn" type="button" disabled aria-disabled="true">픽업 전</button>
        {% else %}
            <button type="button" class="btn status-btn">픽업 가능</button>
            <button type="button" class="btn action-btn pickup-complete-btn" data-pk="{{ r.pk }}">픽업 완료</button>
        {% endif %}
      <!-- 픽업 완료 후 -->
      {% elif r.status == 'PICKED_UP' %}
        <button type="button" class="btn status-btn">픽업 완료</button>
        {% if not r.review %}
          <button type="button" class="btn action-btn write-review-btn" data-pk="{{ r.pk}}" data-store-name="{{ r.store.name }}">리뷰 쓰기</button>
        {% else %}
          <button class="btn action-btn" style="cursor: not-allowed;" disabled aria-disabled="true">리뷰 작성 완료</button>
        {% endif %}
      {% elif r.status == 'REJECTED' %}
        <button type="button" class="btn status-btn">예약이 거절됨</button>
        <button class="btn action-btn" type="button" disabled aria-disabled="true">{{ r.get_rejected_reason_display }}</button>
      {% endif %}



    </div>
    {% endfor %}
    </main>

    <!-- 리뷰 작성 모달 (동적 폼 주입용) -->
    <div id="reviewModal" class="modal" aria-hidden="true">
        <div class="modal-content">
        <div id="review-modal-content"></div>
        </div>
    </div>

<!-- 네비게이션 -->
    <div class="nav_box">
        {% if user.usertype == 'BUYER' %}
        <nav class="bottom_nav">
            <img src="{% static 'img/now_page.png' %}" alt="현재 페이지" class="now_page">
            <div class="btn"><a href="{% url 'stores:map' %}"><img src="{% static 'img/map_page_gray.png' %}" alt="지도페이지" class="map_page"></a></div>
            <div class="btn selected_nav"><a href="{% url 'users:buyer_home' %}"><img src="{% static 'img/home_page_black.png' %}" alt="홈페이지" class="home_page"></a></div>
            <div class="btn"><a href="{% url 'shopping:ai_shopping' %}"><span class="shopping_page">AI</span></a></div>
        </nav>
        {% elif user.usertype == 'SELLER' %}
        <nav class="bottom_nav">
            <img src="{% static 'img/now_page.png' %}" alt="현재 페이지" class="now_page">
            <div class="btn"><a href="{% url 'stores:map' %}"><img src="{% static 'img/map_page_gray.png' %}" alt="지도페이지" class="map_page"></a></div>
            <div class="btn selected_nav"><a href="{% url 'users:seller_home' %}"><img src="{% static 'img/home_page_black.png' %}" alt="홈페이지" class="home_page"></a></div>
            <div class="btn"><a href="{% url 'reservations:seller_list' %}"><span class="shopping_page">예약</span></a></div>
        </nav>
        {% endif %}
        </div>
    </div>
{% endblock body %} {% block script %}
<script src="{% static 'js/consumer_home/reservation_home.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 서버 템플릿에서 CSRF 토큰 주입
  const csrftoken = '{{ csrf_token }}';

  const reviewModal = document.getElementById('reviewModal');
  const reviewModalContent = document.getElementById('review-modal-content');

  // document 레벨로 위임
  document.body.addEventListener('click', async function(event) {
    const target = event.target;

    // 픽업 완료
    if (target.classList.contains('pickup-complete-btn')) {
      const reservationId = target.dataset.pk;
      await handlePickupComplete(reservationId);
      return;
    }

    // 리뷰쓰기
    if (target.classList.contains('write-review-btn')) {
      const reservationId = target.dataset.pk;
      const storeName = target.dataset.storeName || '';
      await openReviewModal(reservationId, storeName);
      return;
    }

    // 모달 닫기 (X 버튼 또는 바깥 영역 클릭)
    if (target.classList.contains('close-modal-btn') || target === reviewModal) {
      closeReviewModal();
      return;
    }
  });

  // 픽업 완료 처리
  async function handlePickupComplete(reservationId) {
    if (!confirm('픽업을 완료하시겠습니까?')) return;

    const url = `/reservations/${reservationId}/change-status/`;
    const formData = new FormData();
    formData.append('to_status', 'PICKED_UP');

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      });

      // JSON 응답 가정
      const result = await response.json();

      if (response.ok && result.status === 'success') {
        alert('픽업이 완료되었습니다!');
        window.location.reload();
      } else {
        alert('오류: ' + (result.message || '상태 변경 실패'));
      }
    } catch (err) {
      console.error(err);
      alert('상태 변경 중 오류가 발생했습니다.');
    }
  }

  // 리뷰 모달 열기 (서버에서 폼 HTML 받아와서 주입)
  async function openReviewModal(reservationId, storeName) {
    try {
      const response = await fetch(`/reviews/create/${reservationId}/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (!response.ok) {
        // 서버가 HTML이 아닌 JSON 에러를 줄 수도 있으므로 대비
        let message = '리뷰 폼을 불러올 수 없습니다.';
        try {
          const errJson = await response.json();
          if (errJson && errJson.message) message = errJson.message;
        } catch(_) {}
        throw new Error(message);
      }

      const formHtml = await response.text();

      reviewModalContent.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
          <strong style="font-size:18px;">리뷰작성 ${storeName ? '(' + storeName + ')' : ''}</strong>
          <span class="close-modal-btn" style="color:#aaa; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
        </div>
        ${formHtml}
      `;

      reviewModal.style.display = 'flex';
      reviewModal.setAttribute('aria-hidden', 'false');
    } catch (error) {
      console.error('Error opening review modal:', error);
      alert(error.message);
    }
  }

  function closeReviewModal() {
    reviewModal.style.display = 'none';
    reviewModal.setAttribute('aria-hidden', 'true');
    reviewModalContent.innerHTML = '';
  }

  // 비어있는 섹션 메시지 처리(선택)
  function updateEmptyMessages() {
    const activeList = document.getElementById('active-reservations-list');
    const pastList = document.getElementById('past-reservations-list');
    const noActiveMsg = document.getElementById('no-active-reservations');
    const noPastMsg = document.getElementById('no-past-reservations');

    if (activeList && noActiveMsg) {
      noActiveMsg.style.display = activeList.children.length === 0 ? 'block' : 'none';
    }
    if (pastList && noPastMsg) {
      noPastMsg.style.display = pastList.children.length === 0 ? 'block' : 'none';
    }
  }

  updateEmptyMessages();
});
</script>
{% endblock script %}
