{% extends "users/base_home.html" %}
{% block role_content %}
<style>
/* (스타일 코드는 기존과 동일하게 유지) */
.modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
.modal-content { background: #fff; border-radius: 14px; padding: 32px 24px; max-width: 400px; width: 90vw; margin: auto; position: relative; top: 10vh; }
.res-card { display: flex; gap: 16px; border:1px solid #eee; padding:16px; margin-bottom:16px; border-radius: 12px; }
.res-card-info { flex-grow: 1; }
.res-card-actions { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
.btn { border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-weight: bold; }
.btn-success { background-color: #28a745; color: white; }
.btn-light { background-color: #f8f9fa; color: #212529; border: 1px solid #dee2e6;}
.no-items-message { text-align:center; color: #888; background: #f5f6fa; border-radius: 10px; padding: 24px 0; font-size: 1.1em; margin: 24px 0; }
</style>

<div class="wrap">
    <div class="header">
        <h2>내 예약 목록</h2>
        <a href="{% url 'stores:store-list' %}" class="btn">새 예약하기</a>
    </div>

    <h3 style="margin-top: 24px;">진행 중인 예약</h3>
    <div id="active-reservations-list">
        {% for r in reservations %}
            {% if r.status != 'PICKED_UP' %}
                {% include 'reservations/reservation_card.html' with reservation=r %}
            {% endif %}
        {% endfor %}
    </div>
    <p id="no-active-reservations" class="no-items-message" style="display: none;">진행 중인 예약이 없습니다.</p>


    <h3 style="margin-top: 36px;">지난 예약</h3>
    <div id="past-reservations-list">
         {% for r in reservations %}
            {% if r.status == 'PICKED_UP' %}
                {% include 'reservations/reservation_card.html' with reservation=r %}
            {% endif %}
        {% endfor %}
    </div>
    <p id="no-past-reservations" class="no-items-message" style="display: none;">지난 예약이 없습니다.</p>

</div>

<!-- 리뷰 작성 모달 -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <h3 id="reviewModalTitle">리뷰 작성</h3>
        <form id="reviewForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ review_form.as_p }}
            <button type="submit">등록</button>
            <button type="button" onclick="closeReviewModal()">닫기</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrftoken = '{{ csrf_token }}';

     // '픽업 완료' 버튼 클릭 이벤트 처리
    document.body.addEventListener('click', function(event) {
        if (event.target.classList.contains('pickup-complete-btn')) {
            const reservationId = event.target.dataset.pk;
            handlePickupComplete(reservationId);
        }
    });

    // '픽업 완료' 서버 요청 및 UI 업데이트 함수
    async function handlePickupComplete(reservationId) {
        const url = `/reservations/change-status/${reservationId}/`;
        const formData = new FormData();
        formData.append('to_status', 'PICKED_UP');

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            });
            const result = await response.json();

            if (response.ok) {
                // 1. '진행 중' 목록에서 기존 카드 찾아서 제거
                const cardToRemove = document.getElementById(`res-card-${reservationId}`);
                if (cardToRemove) cardToRemove.remove();

                // 2. '지난 예약' 목록에 새 카드를 동적으로 생성 (리뷰 버튼 포함)
                const pastList = document.getElementById('past-reservations-list');
                const newCard = cardToRemove.cloneNode(true); // 카드를 복제하여 구조 유지
                
                // 상태 텍스트와 버튼 영역을 '픽업 완료' 상태에 맞게 변경
                newCard.querySelector('.status').textContent = result.new_status;
                const actionsDiv = newCard.querySelector('.res-card-actions');
                actionsDiv.innerHTML = `
                    <p><strong>총 금액:</strong> ${newCard.querySelector('p strong').textContent}</p>
                    <p><strong>상태:</strong> <span class="status">${result.new_status}</span></p>
                    <span style="color: green; font-weight: bold;">픽업 완료</span>
                    <button type="button" class="btn btn-light write-review-btn" data-pk="${reservationId}" data-store-name="${newCard.querySelector('h4').textContent.split('(')[0].trim()}">리뷰쓰기</button>
                `;

                pastList.insertAdjacentElement('afterbegin', newCard);
                
                // 3. 목록이 비었을 때 메시지 처리
                updateEmptyMessages();

            } else {
                alert('오류: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('상태 변경 중 오류가 발생했습니다.');
        }
    }

    // 리뷰 폼 AJAX 제출 처리
    const reviewForm = document.getElementById('reviewForm');
    reviewForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const url = this.action;
        const formData = new FormData(this);

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            });
            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                closeReviewModal();
                const reservationId = url.split('/').slice(-2)[0];
                const reviewButton = document.querySelector(`.write-review-btn[data-pk="${reservationId}"]`);
                if (reviewButton) reviewButton.remove();
            } else {
                alert('오류: ' + (result.message || '리뷰 등록 실패'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('리뷰 등록 중 오류가 발생했습니다.');
        }
    });

    // 모달 제어 함수
    const reviewModal = document.getElementById('reviewModal');
    const reviewModalTitle = document.getElementById('reviewModalTitle');
    function openReviewModal(reservationId, storeName) {
        reviewModalTitle.textContent = `${storeName} 리뷰 작성`;
        reviewForm.action = `/reviews/create/${reservationId}/`;
        reviewModal.style.display = 'block';
    }
    function closeReviewModal() {
        reviewModal.style.display = 'none';
    }
    // 아래처럼 window에 등록!
    window.openReviewModal = openReviewModal;
    window.closeReviewModal = closeReviewModal;

    // 목록 비었는지 확인하고 메시지 표시/숨김 처리하는 함수
    function updateEmptyMessages() {
        const activeList = document.getElementById('active-reservations-list');
        const pastList = document.getElementById('past-reservations-list');
        const noActiveMsg = document.getElementById('no-active-reservations');
        const noPastMsg = document.getElementById('no-past-reservations');

        noActiveMsg.style.display = activeList.children.length === 0 ? 'block' : 'none';
        noPastMsg.style.display = pastList.children.length === 0 ? 'block' : 'none';
    }

    // 페이지 로드 시 한 번 실행
    updateEmptyMessages();

});


</script>
{% endblock %}