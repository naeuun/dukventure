{% extends "base_2.html" %}

{% load static %}
{% block style %}
<link rel="stylesheet" href="{% static 'css/seller_onboardings/seller_onboarding_3.css' %}" />

{% endblock style %}
{% block script %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8&libraries=services"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {

    /** ==========================
     * 1ï¸âƒ£ ì•„ì´í…œ ì¶”ê°€/ì œê±°
     ========================== */
    function removeItem(btn) {
        const div = btn.closest('div');
        if (div) div.remove();
    }

    const addItemBtn = document.getElementById('addItemBtn');
    if (addItemBtn) {
        addItemBtn.onclick = function() {
            const itemList = document.getElementById('itemList');
            const idx = itemList.querySelectorAll('div').length;
            const div = document.createElement('div');
            div.innerHTML = `
                <input type="text" name="item_name_${idx}" id="item_name_${idx}" placeholder="í’ˆëª©ëª…">
                <input type="text" name="item_unit_${idx}" id="item_unit_${idx}" placeholder="ë‹¨ìœ„">
                <input type="number" name="item_price_${idx}" id="item_price_${idx}" placeholder="ê°€ê²©">
                <input type="text" name="item_desc_${idx}" id="item_desc_${idx}" placeholder="ì„¤ëª…">
                <input type="file" name="item_photo_${idx}" accept="image/*">
                <button type="button" onclick="removeItem(this)">ì œê±°</button>
            `;
            itemList.appendChild(div);
        };
    }

    /** ==========================
     * 2ï¸âƒ£ ì§€ë„ & ìœ„ì¹˜ ê´€ë ¨
     ========================== */
    const addressInput = document.getElementById('addressInput');
    const latitudeInput = document.getElementById('latitudeInput');
    const longitudeInput = document.getElementById('longitudeInput');
    const addressSearch = document.getElementById('addressSearch');
    const searchResult = document.getElementById('searchResult');
    const searchModal = document.getElementById('searchModal');
    const closeSearchModal = document.getElementById('closeSearchModal');
    const ps = new kakao.maps.services.Places();
    const geocoder = new kakao.maps.services.Geocoder();

    let map, marker;

    function updateCoordsFromAddress() {
        const address = addressInput.value.trim();
        if (!address) return;

        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK && result.length > 0) {
                const lat = result[0].y;
                const lng = result[0].x;
                latitudeInput.value = lat;
                longitudeInput.value = lng;
                setMarkerAndCenter(lat, lng);
            } else {
                latitudeInput.value = "";
                longitudeInput.value = "";
                alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        });
    }

    function initMap(lat, lng) {
        const center = new kakao.maps.LatLng(lat, lng);
        if (!map) {
            map = new kakao.maps.Map(document.getElementById('mapContainer'), {
                center: center,
                level: 3
            });
        } else {
            map.setCenter(center);
        }

        if (!marker) {
            marker = new kakao.maps.Marker({ position: center });
            marker.setMap(map);
        } else {
            marker.setPosition(center);
        }

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            const latlng = mouseEvent.latLng;
            latitudeInput.value = latlng.getLat();
            longitudeInput.value = latlng.getLng();

            geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK && result[0].address.address_name) {
                    addressInput.value = result[0].address.address_name;
                } else {
                    addressInput.value = "";
                }
                setMarkerAndCenter(latlng.getLat(), latlng.getLng());
            });
        });
    }

    function setMarkerAndCenter(lat, lng) {
        const loc = new kakao.maps.LatLng(lat, lng);
        if (!map) initMap(lat, lng);

        if (!marker) {
            marker = new kakao.maps.Marker({ position: loc, map: map });
        } else {
            marker.setPosition(loc);
        }
        map.setCenter(loc);
    }

    if (addressInput) {
        addressInput.addEventListener('blur', updateCoordsFromAddress);
        addressInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                updateCoordsFromAddress();
            }
        });
    }

    const mapBtn = document.getElementById('mapBtn');
    const mapModal = document.getElementById('mapModal');
    const closeModal = document.getElementById('closeModal');

    if (mapBtn && mapModal) {
        mapBtn.onclick = function() {
            mapModal.style.display = 'block';
            const lat = parseFloat(latitudeInput.value) || 37.6509;
            const lng = parseFloat(longitudeInput.value) || 127.0164;
            setTimeout(() => { initMap(lat, lng); }, 200);
        };
    }

    if (closeModal) {
        closeModal.onclick = function() {
            mapModal.style.display = 'none';
        };
    }

    if (searchBtn && searchModal && searchResult) {
        document.getElementById('searchBtn').onclick = function() {
            const query = addressSearch.value.trim();
            if (!query) return;

            ps.keywordSearch(query, function(data, status) {
                searchResult.innerHTML = '';
                if (status === kakao.maps.services.Status.OK) {
                    data.forEach(place => {
                        const li = document.createElement('li');
                        li.textContent = `${place.place_name} (${place.address_name})`;
                        li.style.cursor = 'pointer';
                        li.style.padding = '5px 0';
                        li.onclick = function() {
                            latitudeInput.value = place.y;
                            longitudeInput.value = place.x;
                            addressInput.value = place.address_name;
                            setMarkerAndCenter(place.y, place.x);
                            searchModal.style.display = 'none';
                        };
                        searchResult.appendChild(li);
                    });
                } else {
                    searchResult.innerHTML = '<li>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                }
                searchModal.style.display = 'block';
            });
        };
    }

    if (closeSearchModal) {
        closeSearchModal.onclick = function() {
            searchModal.style.display = 'none';
        };
    }

    /** ==========================
     * 3ï¸âƒ£ ìŒì„± ì¸ì‹
     ========================== */
    const voiceBtn = document.getElementById('voiceBtn');
    const voiceStatus = document.getElementById('voiceStatus');
    let mediaRecorder = null;
    let audioChunks = [];
    let currentStream = null;

    if (voiceBtn) {
        voiceBtn.addEventListener('click', async () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì…ë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                currentStream = stream;
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                mediaRecorder.onstart = () => {
                    voiceStatus.textContent = "ğŸ¤ ë…¹ìŒ ì¤‘...";
                    voiceBtn.textContent = "â¹ï¸ ë…¹ìŒ ì¤‘ì§€";
                };

                mediaRecorder.onstop = async () => {
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                        currentStream = null;
                    }
                    const audioBlob = new Blob(audioChunks);
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);

                    reader.onloadend = async () => {
                        const base64Audio = reader.result;
                        voiceStatus.textContent = "â³ ì„œë²„ ì²˜ë¦¬ ì¤‘...";
                        voiceBtn.textContent = "ğŸ¤ ìŒì„± ì…ë ¥";

                        try {
                            const response = await fetch("{% url 'stores:voice_input' %}", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ audio: base64Audio, form_type: 'register' })
                            });

                            const data = await response.json();
                            if (!data.form_data) {
                                voiceStatus.textContent = "âš ï¸ ìŒì„± ì²˜ë¦¬ ì‹¤íŒ¨";
                                return;
                            }

                            const formData = data.form_data;

                            // formData ë°˜ì˜ (ê° í•„ë“œ)
                            if (formData.name) document.getElementById('nameInput').value = formData.name;
                            if (formData.address) document.getElementById('addressInput').value = formData.address;
                            if (formData.contact) document.getElementById('contactInput').value = formData.contact;
                            if (formData.sale_days) document.getElementById('saleDaysInput').value = formData.sale_days;
                            if (formData.sale_hours) document.getElementById('saleHoursInput').value = formData.sale_hours;
                            if (formData.payment_methods) document.getElementById('paymentMethodsInput').value = formData.payment_methods;
                            if (formData.description) document.getElementById('descriptionInput').value = formData.description;

                            // íŒë§¤ í’ˆëª©
                            if (formData.items && formData.items.length > 0) {
                                const itemList = document.getElementById('itemList');
                                itemList.querySelectorAll('div').forEach(div => div.remove());
                                formData.items.forEach((item, idx) => {
                                    const div = document.createElement('div');
                                    div.innerHTML = `
                                        <input type="text" name="item_name_${idx}" id="item_name_${idx}" placeholder="í’ˆëª©ëª…" value="${item.name || ''}">
                                        <input type="text" name="item_unit_${idx}" id="item_unit_${idx}" placeholder="ë‹¨ìœ„" value="${item.unit || ''}">
                                        <input type="number" name="item_price_${idx}" id="item_price_${idx}" placeholder="ê°€ê²©" value="${item.price || ''}">
                                        <input type="text" name="item_desc_${idx}" id="item_desc_${idx}" placeholder="ì„¤ëª…" value="${item.description || ''}">
                                        <input type="file" name="item_photo_${idx}" accept="image/*">
                                        <button type="button" onclick="removeItem(this)">ì œê±°</button>
                                    `;
                                    itemList.appendChild(div);
                                });
                            }

                            voiceStatus.textContent = "âœ… ìŒì„± ì…ë ¥ ì™„ë£Œ";
                        } catch (err) {
                            console.error(err);
                            voiceStatus.textContent = "âŒ ì„œë²„ ì˜¤ë¥˜";
                        }
                    };
                };

                mediaRecorder.start();
            } catch (err) {
                console.error(err);
                voiceStatus.textContent = "âŒ ë§ˆì´í¬ ì ‘ê·¼ ê±°ë¶€ë¨";
            }
        });
    }

}); // DOMContentLoaded
</script>

{% endblock script %}

{% block body %}
<div class="big_hugger">
    <div class="container">
        <div class="progress_bar">
            <div class="now_step" style="width: 270px;"></div>
        </div>
        <div class="content">
            <p class="bigger_content">
                <div class="textboxarea">
                    <img src="{% static 'img/textbox/side_vertical_text_box.png' %}" alt="ë§í’ì„ " class="brocoli_says">
                    <img src="{% static 'img/voice_brocoli.png' %}" alt="ë¸Œë¡œì½œë¦¬" class="brocoli">
                    <div class="text">ìŒì„±ë…¹ìŒ <span style="color:grey;">ë“±ë¡ì´ ê°€ëŠ¥í•´ìš”!</span></div>
                </div>
                <span class="title">{% if mode == 'edit' %}ê°€ê²Œ ì •ë³´ ìˆ˜ì •{% else %}ê°€ê²Œ ë“±ë¡{% endif %}</span>
            </p>
            <div class="register_box">
            <div class="scrollable_container">
                <form method="post" enctype="multipart/form-data" id="storeForm">
                    {% csrf_token %}
                    <input type="hidden" id="latitudeInput" name="latitude" value="{{ form.latitude.value|default_if_none:'' }}">
                    <input type="hidden" id="longitudeInput" name="longitude" value="{{ form.longitude.value|default_if_none:'' }}">

                    <!-- 1. ê°€ê²Œ ì´ë¦„ -->
                    <div class="form_row">
                        <label for="nameInput">1. ê°€ê²Œ ì´ë¦„</label>
                        <input type="text" name="name" id="nameInput" value="{{ form.name.value|default_if_none:'' }}" placeholder="ì…ë ¥í•˜ì‹œì˜¤..." />
                    </div>

                    <!-- 2. ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸ -->
                    <div class="form_row">
                        <label for="businessNumberInput">2. ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸</label>
                        <input type="text" name="business_number" id="businessNumberInput" value="{{ request.user.seller.business_number }}" readonly placeholder="ì…ë ¥í•˜ì‹œì˜¤..." />
                    </div>

                    <!-- 3. íŒë§¤ í’ˆëª© -->
                    <div class="form_row">
                        <label>3. íŒë§¤ í’ˆëª©</label>
                        {% if store and store.store_items.all %}
                        {% for store_item in store.store_items.all %}
                        <div>
                            <input type="hidden" name="item_id_{{ forloop.counter0 }}" value="{{ store_item.id }}">
                            <input type="text" name="item_name_{{ forloop.counter0 }}" id="item_name_{{ forloop.counter0 }}" value="{{ store_item.item.name }}" placeholder="í’ˆëª©ëª…">
                            <input type="text" name="item_unit_{{ forloop.counter0 }}" id="item_unit_{{ forloop.counter0 }}" value="{{ store_item.unit }}" placeholder="ë‹¨ìœ„">
                            <input type="number" name="item_price_{{ forloop.counter0 }}" id="item_price_{{ forloop.counter0 }}" value="{{ store_item.price }}" placeholder="ê°€ê²©">
                            <input type="text" name="item_desc_{{ forloop.counter0 }}" id="item_desc_{{ forloop.counter0 }}" value="{{ store_item.description }}" placeholder="ì„¤ëª…">
                            <input type="file" name="item_photo_{{ forloop.counter0 }}" accept="image/*">
                            <button type="button" onclick="removeItem(this)">ì œê±°</button>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div>
                            <input type="text" name="item_name_0" id="item_name_0" placeholder="í’ˆëª©ëª…">
                            <input type="text" name="item_unit_0" id="item_unit_0" placeholder="ë‹¨ìœ„">
                            <input type="number" name="item_price_0" id="item_price_0" placeholder="ê°€ê²©">
                            <input type="text" name="item_desc_0" id="item_desc_0" placeholder="ì„¤ëª…">
                            <input type="file" name="item_photo_0" accept="image/*">
                            <button type="button" onclick="removeItem(this)">ì œê±°</button>
                        </div>
                        {% endif %}                    
                    </div>

                    <!-- 4. íŒë§¤ ì¥ì†Œ -->
                    <div class="form_row">
                        <label>4. íŒë§¤ ì¥ì†Œ</label>
                        <button type="button" id="mapBtn">ì§€ë„ì—ì„œ ìœ„ì¹˜ ì„ íƒ</button>
                        <span style="font-size:0.9em;color:#888;">(ì§€ë„ì—ì„œ ë§ˆì»¤ë¥¼ ì°ì–´ ìœ„ì¹˜ë¥¼ ë“±ë¡í•˜ì„¸ìš”)</span>
                        <br>
                        <input type="text" id="addressSearch" placeholder="ì¥ì†Œ, ìƒí˜¸, ì£¼ì†Œ ë“±ìœ¼ë¡œ ê²€ìƒ‰">
                        <button type="button" id="searchBtn">ê²€ìƒ‰</button>
                        <div id="searchModal" style="display:none; position:fixed; top:20%; left:30%; width:40%; background:#fff; z-index:2000; border:1px solid #ccc; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                            <div style="text-align:right; padding:5px;">
                                <button id="closeSearchModal">ë‹«ê¸°</button>
                            </div>
                            <ul id="searchResult" style="list-style:none; padding:10px; margin:0; max-height:250px; overflow-y:auto;"></ul>
                        </div>
                        <br>
                        <input type="text" id="addressInput" name="address"
                            value="{{ form.address.value|default_if_none:'' }}"
                            placeholder="ì£¼ì†Œë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ì§€ë„ì—ì„œ ì„ íƒí•˜ì„¸ìš”">
                        <span style="font-size:0.9em;color:#888;">(ì£¼ì†Œ ê²€ìƒ‰ì€ ì¹´ì¹´ì˜¤ ì§€ë„ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤)</span>
                    </div>

                    <!-- 5. íŒë§¤ ìš”ì¼ -->
                    <div class="form_row">
                        <label for="saleDaysInput">5. íŒë§¤ ìš”ì¼</label>
                        <input type="text"  name="sale_days" id="saleDaysInput" value="{{ form.sale_days.value|default_if_none:'' }}" placeholder="ì˜ˆ: ì›”,ìˆ˜,ê¸ˆ" />
                    </div>

                    <!-- 6. íŒë§¤ ì‹œê°„ëŒ€ -->
                    <div class="form_row">
                        <label for="saleHoursInput">6. íŒë§¤ ì‹œê°„ëŒ€</label>
                        <input type="text" name="sale_hours" id="saleHoursInput" value="{{ form.sale_hours.value|default_if_none:'' }}" placeholder="ì˜ˆ: 10:00~18:00" />
                    </div>

                    <!-- 7. ê²°ì œ ìˆ˜ë‹¨ -->
                    <div class="form_row">
                        <label for="paymentMethodsInput">7. ê²°ì œ ìˆ˜ë‹¨</label>
                        <input type="text" name="payment_methods" id="paymentMethodsInput" value="{{ form.payment_methods.value|default_if_none:'' }}" placeholder="ì˜ˆ: í˜„ê¸ˆ, ì¹´ë“œ" />
                    </div>

                    <!-- 8. íŒë§¤ì ì—°ë½ ìˆ˜ë‹¨ (ì„ íƒ) -->
                    <div class="form_row">
                        <label for="contactInput">8. íŒë§¤ì ì—°ë½ ìˆ˜ë‹¨ (ì„ íƒ)</label>
                        <input  type="text" name="contact" id="contactInput" value="{{ form.contact.value|default_if_none:'' }}" placeholder="ì˜ˆ: 010-1234-5678" />
                    </div>

                    <!-- 9. ê°€ê²Œ ì‚¬ì§„ ì—…ë¡œë“œ (ì„ íƒ) -->
                    <div class="form_row">
                        <label for="field9">9. ê°€ê²Œ ì‚¬ì§„ ì—…ë¡œë“œ (ì„ íƒ)</label>
                        <div class="file_upload">
                            <input type="file" id="field9"  name="photo" accept="image/*" style="display: none;">
                            <label for="field9">
                                <img src="{% static 'img/add_photo.png' %}" alt="upload" class="upload_icon" />
                            </label>
                        </div>
                    </div>

                    <!-- 10. íŠ¹ì´ì‚¬í•­ ë˜ëŠ” íŒë§¤ ë©”ì‹œì§€ (ì„ íƒ) -->
                    <div class="form_row">
                        <label for="descriptionInput">10. íŠ¹ì´ì‚¬í•­ ë˜ëŠ” íŒë§¤ ë©”ì‹œì§€ (ì„ íƒ)</label>
                        <textarea name="description" id="descriptionInput" rows="2" cols="40" placeholder="ê°„ë‹¨í•œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">{{ form.description.value|default_if_none:'' }}</textarea>
                    </div>
                    <button
                    type="submit"
                    value="ê°€ê²Œ ì •ë³´ ë“±ë¡" 
                    class="register_button"
                    >
                        {% if mode == 'edit' %}ìˆ˜ì • ì™„ë£Œ{% else %}ë“±ë¡í•˜ê¸°{% endif %}
                    </button>
                </form>
            </div>
        </div> 
        <div class="button_hugger">
            <button
            type="button"
            value="ìŒì„± ì¸ì‹ ë²„íŠ¼"
            class="voice_recognition_btn"
            id="voiceBtn"
            data-form-type="register"
            >
                <img src="{% static 'img/mic.png' %}" alt="ìŒì„± ì¸ì‹ ë²„íŠ¼">
            </button>
            <span id="voiceStatus" style="margin-left:10px;color:#555;">(ë…¹ìŒ ìƒíƒœ í‘œì‹œ)</span>
        </div>
        <div class="prev_page" onclick="history.back()">
            <img src="{% static 'img/left_back.png' %}" alt="ë’¤ë¡œ ê°€ê¸°">
        </div>
    </div>
</div>

<div id="mapModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; z-index:1000; border:1px solid #ccc;">
    <div style="text-align:right; padding:5px;">
        <button id="closeModal">ë‹«ê¸°</button>
    </div>
    <div id="mapContainer" style="width:100%; height:90%;"></div>
</div>

<!-- ìŒì„± ì¸ì‹ ëª¨ë‹¬ -->
<div class="voice_modal hidden">
    <div class="voice_modal_overlay"></div>
    <div class="voice_modal_content">
        <button class="voice_modal_close">âœ•</button>
        <div class="text_box_area">
        <img src="{% static 'img/textbox/vertical_text_box.png' %}" alt="ë§í’ì„ " class="voice_modal_ann">
        <div class="ann_text">ë²„íŠ¼ì„ ëˆ„ë¥´ê³ , ë§í•˜ì„¸ìš”!</div>
        </div>
        <div class="voice_recognizing_btn">
        <img src="{% static 'img/mic_neon.png' %}" alt="ìŒì„± ì¸ì‹ ë²„íŠ¼" class="voice_modal_mic">
        </div>
    </div>
</div>

{% endblock body %}
