{% extends "base.html" %}
{% block content %}
<h2>{% if mode == 'edit' %}가게 정보 수정{% else %}가게 등록{% endif %}</h2>
<hr>
<form method="post" enctype="multipart/form-data" id="storeForm">
    {% csrf_token %}
    <div>
        1. <label>가게 이름</label>
        {{ form.name }}
    </div>
    <div>
        2. <label>사업자 등록 번호</label>
        <input type="text" value="{{ request.user.seller.business_number }}" readonly>
    </div>
    <div>
        3. <label>가게 위치 등록</label>
        <button type="button" id="mapBtn">지도에서 위치 선택</button>
        <span style="font-size:0.9em;color:#888;">(지도에서 마커를 찍어 위치를 등록하세요)</span>
        <br>
        <input type="text" id="addressSearch" placeholder="장소, 상호, 주소 등으로 검색">
        <button type="button" id="searchBtn">검색</button>
        <!-- 검색 결과 모달 추가 -->
        <div id="searchModal" style="display:none; position:fixed; top:20%; left:30%; width:40%; background:#fff; z-index:2000; border:1px solid #ccc; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
            <div style="text-align:right; padding:5px;">
                <button id="closeSearchModal">닫기</button>
            </div>
            <ul id="searchResult" style="list-style:none; padding:10px; margin:0; max-height:250px; overflow-y:auto;"></ul>
        </div>
        <br>
        <input type="text" id="addressInput" name="address"
               value="{{ form.address.value|default_if_none:'' }}"
               placeholder="주소를 직접 입력하거나, 지도에서 선택하세요">
        <span style="font-size:0.9em;color:#888;">(주소 검색은 카카오 지도에서 가능합니다)</span>
    </div>
    <div id="itemList">
        <p>4. 판매 품목 및 가격/사진/설명</p>
        {% if store and store.store_items.all %}
            {% for store_item in store.store_items.all %}
                <div>
                    <input type="hidden" name="item_id_{{ forloop.counter0 }}" value="{{ store_item.id }}">
                    <input type="text" name="item_name_{{ forloop.counter0 }}" value="{{ store_item.item.name }}" placeholder="품목명">
                    <input type="text" name="item_unit_{{ forloop.counter0 }}" value="{{ store_item.unit }}" placeholder="단위">
                    <input type="number" name="item_price_{{ forloop.counter0 }}" value="{{ store_item.price }}" placeholder="가격">
                    <input type="text" name="item_desc_{{ forloop.counter0 }}" value="{{ store_item.description }}" placeholder="설명">
                    <input type="file" name="item_photo_{{ forloop.counter0 }}" accept="image/*">
                    <button type="button" onclick="removeItem(this)">제거</button>
                </div>
            {% endfor %}
        {% else %}
            <div>
                <input type="text" name="item_name_0" placeholder="품목명">
                <input type="text" name="item_unit_0" placeholder="단위">
                <input type="number" name="item_price_0" placeholder="가격">
                <input type="text" name="item_desc_0" placeholder="설명">
                <input type="file" name="item_photo_0" accept="image/*">
                <button type="button" onclick="removeItem(this)">제거</button>
            </div>
        {% endif %}
    </div>
    <button type="button" id="addItemBtn">추가</button>

    <div>
        5. <label>판매 요일</label>
        {{ form.sale_days }}
    </div>
    <div>
        6. <label>판매 시간대</label>
        {{ form.sale_hours }}
    </div>
    <div>
        7. <label>결제 수단</label>
        {{ form.payment_methods }}
    </div>
    <div>
        8. <label>연락처</label>
        {{ form.contact }}
    </div>
    <div>
        9. <label>가게 사진</label>
        {{ form.photo }}
    </div>
    <div>
        10. <label>특이 사항/판매 메시지</label>
        <textarea name="description" rows="2" cols="40" placeholder="간단한 메시지를 입력하세요">{{ form.description.value|default_if_none:'' }}</textarea>
    </div>
    <hr>
    <button type="submit">{% if mode == 'edit' %}수정 완료{% else %}등록하기{% endif %}</button>
</form>
<a href="{% url 'users:seller_home' %}">판매자 홈으로 돌아가기</a>

<!-- 지도 모달 -->
<div id="mapModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; z-index:1000; border:1px solid #ccc;">
    <div style="text-align:right; padding:5px;">
        <button id="closeModal">닫기</button>
    </div>
    <div id="mapContainer" style="width:100%; height:90%;"></div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8&libraries=services"></script>
<script>
let itemIdx = 1;
document.getElementById('addItemBtn').onclick = function() {
    const itemList = document.getElementById('itemList');
    const div = document.createElement('div');
    div.innerHTML = `
        <input type="text" name="item_name_${itemIdx}" placeholder="품목명">
        <input type="text" name="item_unit_${itemIdx}" placeholder="단위">
        <input type="number" name="item_price_${itemIdx}" placeholder="가격">
        <input type="text" name="item_desc_${itemIdx}" placeholder="설명">
        <input type="file" name="item_photo_${itemIdx}" accept="image/*">
        <button type="button" onclick="removeItem(this)">제거</button>
    `;
    itemList.appendChild(div);
    itemIdx++;
};

function removeItem(btn) {
    btn.parentElement.remove();
}

// 장소 검색 기능
const addressInput = document.getElementById('addressInput');
const addressSearch = document.getElementById('addressSearch');
const searchResult = document.getElementById('searchResult');
const searchModal = document.getElementById('searchModal');
const closeSearchModal = document.getElementById('closeSearchModal');
const ps = new kakao.maps.services.Places();

document.getElementById('searchBtn').onclick = function() {
    const query = addressSearch.value;
    if (!query) return;
    ps.keywordSearch(query, function(data, status) {
        searchResult.innerHTML = '';
        if (status === kakao.maps.services.Status.OK) {
            data.forEach(function(place) {
                const li = document.createElement('li');
                li.textContent = place.place_name + ' (' + place.address_name + ')';
                li.style.cursor = 'pointer';
                li.style.padding = '8px 0';
                // 장소 검색 결과 선택 시 한글 주소로 변환
                li.onclick = function() {
                    geocoder.coord2Address(place.x, place.y, function(result, status) {
                        if (status === kakao.maps.services.Status.OK && result[0].address.address_name) {
                            addressInput.value = result[0].address.address_name; // 한글 주소
                        } else {
                            // place.address_name이 한글인지 확인 후 입력
                            if (/[\uac00-\ud7a3]/.test(place.address_name)) {
                                addressInput.value = place.address_name; // 한글 주소만 입력
                            } else {
                                addressInput.value = ""; // 영어 주소는 입력하지 않음
                                alert("주소 변환에 실패했습니다. 한글 주소를 직접 입력해주세요.");
                            }
                        }
                    });
                    // 지도 위치 이동
                    const loc = new kakao.maps.LatLng(place.y, place.x);
                    if (!map) {
                        mapInit(loc);
                    } else {
                        map.setCenter(loc);
                        marker.setPosition(loc);
                    }
                    searchModal.style.display = 'none';
                };
                searchResult.appendChild(li);
            });
        } else {
            searchResult.innerHTML = '<li>검색 결과가 없습니다.</li>';
        }
        searchModal.style.display = 'block';
    });
};

closeSearchModal.onclick = function() {
    searchModal.style.display = 'none';
};

// 지도 모달 관련
let map, marker, geocoder;
geocoder = new kakao.maps.services.Geocoder();

document.getElementById('mapBtn').onclick = function() {
    document.getElementById('mapModal').style.display = 'block';
    setTimeout(function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const current = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                mapInit(current);
            }, function() {
                const defaultPos = new kakao.maps.LatLng(37.6509, 127.0164);
                mapInit(defaultPos);
            });
        } else {
            const defaultPos = new kakao.maps.LatLng(37.6509, 127.0164);
            mapInit(defaultPos);
        }
    }, 100);
};

document.getElementById('closeModal').onclick = function() {
    document.getElementById('mapModal').style.display = 'none';
};

function mapInit(center) {
    map = new kakao.maps.Map(document.getElementById('mapContainer'), {
        center: center,
        level: 3
    });
    marker = new kakao.maps.Marker({ position: center });
    marker.setMap(map);

    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const latlng = mouseEvent.latLng;
        marker.setPosition(latlng);
        geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK && result[0].address.address_name) {
                addressInput.value = result[0].address.address_name;
            } else {
                addressInput.value = "";
                alert("주소 변환에 실패했습니다. 한글 주소를 직접 입력해주세요.");
            }
        });
    });
}
</script>
{% endblock %}