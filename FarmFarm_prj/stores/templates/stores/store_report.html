{% extends "base_2.html" %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/stores_plus.css' %}" />
{% endblock style %}

{% block script %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8&libraries=services"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const addressInput = document.getElementById('addressInput');
    const latitudeInput = document.getElementById('latitudeInput');
    const longitudeInput = document.getElementById('longitudeInput');
    const geocoder = new kakao.maps.services.Geocoder();

    let map, marker;

    // ÏßÄÎèÑ Î™®Îã¨ Ïó¥Í∏∞
    document.getElementById('mapBtn').onclick = function() {
        document.getElementById('mapModal').style.display = 'block';
        setTimeout(function() {
            let initLat = parseFloat(latitudeInput.value) || 37.6509;
            let initLng = parseFloat(longitudeInput.value) || 127.0164;
            const initPos = new kakao.maps.LatLng(initLat, initLng);
            mapInit(initPos);
        }, 100);
    };

    // ÏßÄÎèÑ Î™®Îã¨ Îã´Í∏∞
    document.getElementById('closeModal').onclick = function() {
        document.getElementById('mapModal').style.display = 'none';
    };

    // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
    function mapInit(center) {
        const container = document.getElementById('mapContainer');

        if (!map) {
            map = new kakao.maps.Map(container, {
                center: center,
                level: 3
            });
        } else {
            map.setCenter(center);
        }

        if (!marker) {
            marker = new kakao.maps.Marker({ position: center, map: map });
        } else {
            marker.setPosition(center);
        }

        map.relayout(); // Î™®Îã¨ÏóêÏÑú Ïó¥Î¶¥ Îïå ÏßÄÎèÑ Í∞±Ïã†

        // ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïãú Ï£ºÏÜå/Ï¢åÌëú Î∞òÏòÅ
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            const latlng = mouseEvent.latLng;
            marker.setPosition(latlng);

            geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK && result[0].address.address_name) {
                    addressInput.value = result[0].address.address_name;
                    latitudeInput.value = latlng.getLat();
                    longitudeInput.value = latlng.getLng();
                } else {
                    alert("Ï£ºÏÜå Î≥ÄÌôò Ïã§Ìå®. ÌïúÍ∏Ä Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                    latitudeInput.value = latlng.getLat();
                    longitudeInput.value = latlng.getLng();
                }
            });
        });
    }

    // ÏùåÏÑ± Ïù∏Ïãù Í¥ÄÎ†® ÏΩîÎìúÎäî Í∑∏ÎåÄÎ°ú
    const reportVoiceBtn = document.getElementById('voiceBtn');
    const reportVoiceStatus = document.getElementById('voiceStatus');
    let mediaRecorderReport = null;
    let audioChunksReport = [];
    let currentStreamReport = null;

    reportVoiceBtn.addEventListener('click', async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÏùåÏÑ± ÏûÖÎ†•ÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
            return;
        }

        if (mediaRecorderReport && mediaRecorderReport.state === "recording") {
            mediaRecorderReport.stop();
            if (currentStreamReport) {
                currentStreamReport.getTracks().forEach(track => track.stop());
                currentStreamReport = null;
            }
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            currentStreamReport = stream; 
            mediaRecorderReport = new MediaRecorder(stream);
            audioChunksReport = [];

            mediaRecorderReport.ondataavailable = e => audioChunksReport.push(e.data);

            mediaRecorderReport.onstart = () => {
                reportVoiceStatus.textContent = "üé§ ÎÖπÏùå Ï§ë...";
                reportVoiceBtn.textContent = "‚èπÔ∏è ÎÖπÏùå Ï§ëÏßÄ";
            };

            mediaRecorderReport.onstop = async () => {
                if (currentStreamReport) {
                    currentStreamReport.getTracks().forEach(track => track.stop());
                    currentStreamReport = null;
                }
                const audioBlob = new Blob(audioChunksReport);
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);

                reader.onloadend = async () => {
                    const base64Audio = reader.result;
                    reportVoiceStatus.textContent = "‚è≥ ÏÑúÎ≤Ñ Ï≤òÎ¶¨ Ï§ë...";
                    reportVoiceBtn.textContent = "üé§ ÏùåÏÑ± Ïù∏Ïãù";

                    try {
                        const response = await fetch("{% url 'stores:voice_input' %}", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ audio: base64Audio, form_type: 'report' })
                        });

                        const data = await response.json();
                        if (!data.form_data) {
                            reportVoiceStatus.textContent = "‚ö†Ô∏è ÏùåÏÑ± Ï≤òÎ¶¨ Ïã§Ìå®";
                            return;
                        }

                        const formData = data.form_data;

                        if (formData.store_name) {
                            const storeNameInput = document.getElementById('id_store_name');
                            if (storeNameInput) storeNameInput.value = formData.store_name;
                        }

                        if (formData.report_items) {
                            const reportItemsInput = document.getElementById('id_report_items');
                            if (reportItemsInput) reportItemsInput.value = formData.report_items;
                        }

                        if (formData.time) {
                            const timeInput = document.getElementById('id_time');
                            if (timeInput) timeInput.value = formData.time;
                        }

                        if (formData.address) {
                            const addressInput = document.getElementById('addressInput');
                            if (addressInput) addressInput.value = formData.address;
                        }

                        if (formData.address) {
                            const geocoder = new kakao.maps.services.Geocoder();
                            geocoder.addressSearch(formData.address, function(result, status) {
                                if (status === kakao.maps.services.Status.OK && result.length > 0) {
                                    document.getElementById('latitudeInput').value = result[0].y;
                                    document.getElementById('longitudeInput').value = result[0].x;
                                } else {
                                    alert("Ï£ºÏÜåÎ•º Ï¢åÌëúÎ°ú Î≥ÄÌôòÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÏßÄÎèÑÏóêÏÑú ÏßÅÏ†ë ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                                    document.getElementById('latitudeInput').value = "";
                                    document.getElementById('longitudeInput').value = "";
                                }
                            });
                        }

                        if (formData.keywords) {
                            let keywordsArr = Array.isArray(formData.keywords)
                                ? formData.keywords
                                : String(formData.keywords).split(',').map(s => s.trim());

                            keywordsArr.forEach(keywordText => {
                                document.querySelectorAll('input[name="keywords"]').forEach(checkbox => {
                                    const label = checkbox.parentElement;
                                    if (
                                        label &&
                                        label.textContent.replace(/\s/g, '').toLowerCase().includes(
                                            keywordText.replace(/\s/g, '').toLowerCase()
                                        )
                                    ) {
                                        checkbox.checked = true;
                                    }
                                });
                            });
                        }

                        reportVoiceStatus.textContent = "‚úÖ ÏùåÏÑ± ÏûÖÎ†• ÏôÑÎ£å";
                    } catch (err) {
                        console.error(err);
                        reportVoiceStatus.textContent = "‚ùå ÏÑúÎ≤Ñ Ïò§Î•ò";
                    }
                };
            };

            mediaRecorderReport.start();
        } catch (err) {
            console.error(err);
            reportVoiceStatus.textContent = "‚ùå ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑º Í±∞Î∂ÄÎê®";
        }
    });
});
</script>

<script src="{% static 'js/stores_plus.js' %}"></script>

{% endblock script %}

{% block body %}
<div class="welcome_overlay"></div>

<div class="big_hugger">
  <div class="container">
    <form method="post" enctype="multipart/form-data" id="reportForm">
    {% csrf_token %}
    <img src="{% static 'img/map_deco.png' %}" alt="ÏúÑ Îç∞ÏΩî" class="deco" />
    <img src="{% static 'img/left_back_neon.png' %}" alt="Îí§Î°úÍ∞ÄÍ∏∞" class="before_page" onclick="history.back()" />

    <!-- Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú -->
    <div class="gapsection">
      <label class="section-title">Ïù¥ÎØ∏ÏßÄ</label>
      <div class="file_upload">
        <!-- ÌååÏùº ÏóÖÎ°úÎìú input -->
        <input type="file" name="image" id="id_image" accept="image/*" style="display: none;" />

        <!-- ÏïÑÏù¥ÏΩò -->
        <label for="id_image" class="upload_label">
          <img src="{% static 'img/add_photo.png' %}" alt="upload" class="upload_icon" />
        </label>

        <!-- ÎßêÌíçÏÑ† -->
        <div class="text_box_text">
          <img src="{% static 'img/textbox/text_box.png' %}" alt="ÎßêÌíçÏÑ†" class="textbox" />
          <span class="texts">ÎàÑÎ•¥Î©¥ <span style="color:grey;">Í∞§Îü¨Î¶¨Î°ú Ïó∞Í≤∞ÎèºÏöî!</span></span>
        </div>

        <!-- ÏóÖÎ°úÎìúÎêú ÌååÏùº Ï†ïÎ≥¥ -->
        <div class="file_info_wrap" style="display: none;">
          <span class="file_name"></span>
          <button type="button" class="delete_file_btn">ÏÇ≠Ï†ú</button>
        </div>
      </div>
    </div>

    <!-- Í∞ÄÍ≤å Ïù¥Î¶Ñ -->
    <div class="section">
      <label class="section-title">Í∞ÄÍ≤åÏù¥Î¶Ñ</label>
      <input type="text" name="store_name" id="id_store_name" class="text-input" value="{{ form.store_name.value|default_if_none:'' }}" placeholder="ÏûÖÎ†•ÌïòÏãúÏò§..." />
    </div>

    <!-- ÏùåÏãù Ï¢ÖÎ•ò -->
    <div class="section">
      <label class="section-title">ÏùåÏãùÏ¢ÖÎ•ò</label>
      <input type="text" name="report_items" id="id_report_items" value="{{ form.report_items.value|default_if_none:'' }}" class="text-input" placeholder="ÏûÖÎ†•ÌïòÏãúÏò§..." />
    </div>
    <!-- Ïû•ÏÜå -->
    <div class="section">
      <label class="section-title">Ïû•ÏÜå</label>
      <input type="hidden" id="latitudeInput" name="latitude" value="">
      <input type="hidden" id="longitudeInput" name="longitude" value="">
      <input type="text" id="addressInput" name="address" placeholder="Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÏßÄÎèÑÏóêÏÑú ÏÑ†ÌÉù">
      <button type="button" id="mapBtn">ÏßÄÎèÑÏóêÏÑú ÏúÑÏπò ÏÑ†ÌÉù</button>    
    </div>

    <!-- ÏãúÍ∞Ñ -->
    <div class="gapsection">
      <label class="section-title">ÏãúÍ∞Ñ</label>
      <input type="text" name="time" id="id_time" value="{{ form.time.value|default_if_none:'' }}" class="text-input" placeholder="ÏûÖÎ†•ÌïòÏãúÏò§..." />
    </div>

    <!-- ÌÇ§ÏõåÎìú -->
    <div class="keyword_section">
      <label class="section-title">#ÌÇ§ÏõåÎìú</label>
      <div class="keyword-list">
        {% for keyword in form.keywords.field.queryset %}
        <label class="keyword-option">
            <input type="checkbox" name="keywords" value="{{ keyword.id }}"
            {% if form.keywords.value %}
                {% if keyword.id|stringformat:"s" in form.keywords.value %}
                checked
                {% endif %}
            {% endif %}>
            {{ keyword.keyword }}
        </label>
        {% endfor %}

      </div>
    </div>
    <!-- Îì±Î°ù Î≤ÑÌäº -->
    <div class="btn_hugger">
      <div class="voice_recognization">
        <div class="voice_texts">
          <img src="{% static 'img/textbox/text_box.png' %}" alt="ÎßêÌíçÏÑ†" class="voice_textbox" />
          <span class="texts">ÏùåÏÑ±ÎÖπÏùå <span style="color:grey;">Îì±Î°ùÏù¥ Í∞ÄÎä•Ìï¥Ïöî!</span></span>
        </div>
        <button class="circle_btn">
          <img src="{% static 'img/mic.png' %}" alt="ÏùåÏÑ±Ïù∏ÏãùÎ≤ÑÌäº" class="voice_recognization_btn" />
        </button>
      </div>
      <button type="submit" class="register_btn">Îì±Î°ùÌïòÍ∏∞</button>
    </div>
  </form>
  </div>

  
</div>

<!-- ÏùåÏÑ± Ïù∏Ïãù Î™®Îã¨ -->
<div class="voice_modal hidden">
  <div class="voice_modal_overlay"></div>
  <div class="voice_modal_content">
    <button class="voice_modal_close">‚úï</button>
    <div class="text_box_area">
      <img src="{% static 'img/textbox/vertical_text_box.png' %}" alt="ÎßêÌíçÏÑ†" class="voice_modal_ann">
      <div class="ann_text">Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Í≥†, ÎßêÌïòÏÑ∏Ïöî!</div>
    </div>
    <div class="voice_recognizing_btn">
      <button type="button" id="voiceBtn" data-form-type="report">
        <img src="{% static 'img/mic_neon.png' %}" alt="ÏùåÏÑ± Ïù∏Ïãù Î≤ÑÌäº" class="voice_modal_mic">
      </button>
      <span id="voiceStatus" style="margin-left:10px;color:#555;">(ÎÖπÏùå ÏÉÅÌÉú ÌëúÏãú)</span>
    </div>
  </div>
</div>

<!-- ÏßÄÎèÑ Î™®Îã¨ -->
<div id="mapModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; z-index:1000; border:1px solid #ccc;">
    <div style="text-align:right; padding:5px;">
        <button id="closeModal">Îã´Í∏∞</button>
    </div>
    <div id="mapContainer" style="width:100%; height:90%;"></div>
</div>

{% endblock body %}
