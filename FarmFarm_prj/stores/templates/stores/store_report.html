{% extends "base_2.html" %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/stores_report.css' %}" />
<link rel="stylesheet" href="{% static 'css/stores_plus.css' %}" />
{% endblock style %}

{% block script %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8&libraries=services"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const addressInput = document.getElementById('addressInput');
    const latitudeInput = document.getElementById('latitudeInput');
    const longitudeInput = document.getElementById('longitudeInput');
    const geocoder = new kakao.maps.services.Geocoder();

    let map, marker;

    // ì§€ë„ ëª¨ë‹¬ ì—´ê¸°
    document.getElementById('mapBtn').onclick = function() {
        document.getElementById('mapModal').style.display = 'block';
        setTimeout(function() {
            let initLat = parseFloat(latitudeInput.value) || 37.6509;
            let initLng = parseFloat(longitudeInput.value) || 127.0164;
            const initPos = new kakao.maps.LatLng(initLat, initLng);
            mapInit(initPos);
        }, 100);
    };

    // ì§€ë„ ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById('closeModal').onclick = function() {
        document.getElementById('mapModal').style.display = 'none';
    };

    // ì§€ë„ ì´ˆê¸°í™”
    function mapInit(center) {
        const container = document.getElementById('mapContainer');

        if (!map) {
            map = new kakao.maps.Map(container, {
                center: center,
                level: 3
            });
        } else {
            map.setCenter(center);
        }

        // ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
        const imageSrc = "{% static 'img/stores.png' %}"; // ë§ˆì»¤ ì´ë¯¸ì§€ ê²½ë¡œ
        const imageSize = new kakao.maps.Size(20, 20);    // ì´ë¯¸ì§€ í¬ê¸° (ì›í•˜ëŠ” í¬ê¸°ë¡œ ë³€ê²½ ê°€ëŠ¥)
        const imageOption = { offset: new kakao.maps.Point(10, 10) }; // ì¤‘ì‹¬ ì¢Œí‘œ ê¸°ì¤€ ìœ„ì¹˜ ì¡°ì •

        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

        if (!map) initMap(lat, lng);
        if (!marker) {
            marker = new kakao.maps.Marker({
                position: center,
                map: map,
                image: markerImage // ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ ì ìš©
            });
        } else {
            marker.setPosition(center);
            marker.setImage(markerImage); // ì´ë¯¸ ìˆëŠ” ë§ˆì»¤ì—ë„ ì´ë¯¸ì§€ ì ìš©
        }

        map.relayout();

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            const latlng = mouseEvent.latLng;
            marker.setPosition(latlng);

            geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK && result[0].address.address_name) {
                    addressInput.value = result[0].address.address_name;
                    latitudeInput.value = latlng.getLat();
                    longitudeInput.value = latlng.getLng();
                } else {
                    alert("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨. í•œê¸€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    latitudeInput.value = latlng.getLat();
                    longitudeInput.value = latlng.getLng();
                }
            });
        });
    }

    const imageIcon = document.querySelector('.upload_icon');
    const tooltip = document.querySelector('.text_box_text');

    // ì´ˆê¸° ë¡œë“œ ì‹œ 3ì´ˆ ë³´ì—¬ì£¼ê¸°
    tooltip.classList.add("show");
    setTimeout(() => {
        tooltip.classList.remove("show");
    }, 3000);

    // í˜¸ë²„ ì‹œ ë³´ì—¬ì£¼ê¸°
    imageIcon.addEventListener("mouseenter", () => {
        tooltip.classList.add("show");
    });

    imageIcon.addEventListener("mouseleave", () => {
        tooltip.classList.remove("show");
    });

    // ìŒì„± ì¸ì‹ ê´€ë ¨ ì½”ë“œ
    const reportVoiceBtn = document.getElementById('voiceBtn');
    const reportVoiceStatus = document.getElementById('voiceStatus');
    const textbox = document.querySelector('.voice_texts');

    let mediaRecorderReport = null;
    let audioChunksReport = [];
    let currentStreamReport = null;
    let hideTimeout = null;
    let isProcessing = false; // ì„œë²„ ì²˜ë¦¬ ì¤‘ ìƒíƒœ

    // ê³µí†µ í•¨ìˆ˜ - ìš”ì†Œ í‘œì‹œ
    function showElements() {
        textbox.classList.add("show");
        reportVoiceStatus.classList.add("show");
        textbox.style.opacity = 1;
        reportVoiceStatus.style.opacity = 1;
    }

    // ê³µí†µ í•¨ìˆ˜ - ìš”ì†Œ ìˆ¨ê¹€
    function hideElementsAfterDelay(delay=0) {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
            // ë…¹ìŒ ì¤‘ì´ê±°ë‚˜ ì„œë²„ ì²˜ë¦¬ ì¤‘ì¼ ë• ìˆ¨ê¸°ì§€ ì•ŠìŒ
            if (isProcessing || (mediaRecorderReport && mediaRecorderReport.state === "recording")) return;
            textbox.classList.remove("show");
            reportVoiceStatus.classList.remove("show");
            textbox.style.opacity = 0;
            reportVoiceStatus.style.opacity = 0;
        }, delay);
    }

    // âœ… ì´ˆê¸° ë¡œë“œ ì‹œ 3ì´ˆê°„ ë§í’ì„  í‘œì‹œ
    function showInitialTooltip() {
        textbox.classList.add("show");
        reportVoiceStatus.classList.add("show");
        hideElementsAfterDelay(3000);
    }
    showInitialTooltip();

    // âœ… í˜¸ë²„ ì‹œ ë™ì‘ (ë…¹ìŒ ì¤‘/ì²˜ë¦¬ ì¤‘ì´ë©´ ë¬´ì‹œ)
    reportVoiceBtn.addEventListener("mouseenter", () => {
        if (isProcessing) return;
        showElements();
        clearTimeout(hideTimeout); // hover ì‹œ ê¸°ì¡´ ìˆ¨ê¹€ íƒ€ì´ë¨¸ ì œê±°
    });
    reportVoiceBtn.addEventListener("mouseleave", () => {
        hideElementsAfterDelay(30); // hover í•´ì œ í›„ 3ì´ˆ ë’¤ ìˆ¨ê¹€
    });

    // ìŒì„± ë…¹ìŒ ë²„íŠ¼ í´ë¦­ ì‹œ 
    reportVoiceBtn.addEventListener('click', async () => {
        // ë¸Œë¼ìš°ì € ì§€ì› ì—¬ë¶€ ì²´í¬ 
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì…ë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        // ë…¹ìŒ ì¤‘ì´ë©´ ì¢…ë£Œ 
        if (mediaRecorderReport && mediaRecorderReport.state === "recording") {
            mediaRecorderReport.stop();
            currentStreamReport.getTracks().forEach(track => track.stop());
            currentStreamReport = null;          
            return;
        }

        // ìƒˆë¡œìš´ ë…¹ìŒ ì‹œì‘í•˜ê¸° ì „ì— ìƒíƒœ ì´ˆê¸°í™”
        clearTimeout(hideTimeout);                 // ê¸°ì¡´ ìˆ¨ê¹€ íƒ€ì´ë¨¸ ì œê±°
        isProcessing = false;                      // ì„œë²„ ì²˜ë¦¬ ìƒíƒœ ì´ˆê¸°í™”
        reportVoiceStatus.textContent = "ğŸ¤ ì¤€ë¹„ ì¤‘...";
        showElements();

        try {
            //ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° 
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            currentStreamReport = stream; 
            mediaRecorderReport = new MediaRecorder(stream);
            audioChunksReport = [];

            //ë…¹ìŒ ë°ì´í„° ìˆ˜ì§‘
            mediaRecorderReport.ondataavailable = e => audioChunksReport.push(e.data);

            // ë…¹ìŒ ì‹œì‘ 
            mediaRecorderReport.onstart = () => {
                showElements();
                reportVoiceStatus.textContent = "ğŸ¤ ë…¹ìŒ ì¤‘...";
                isProcessing = false;
            };

            // ë…¹ìŒ ì¢…ë£Œ ì´ë²¤íŠ¸ 
            mediaRecorderReport.onstop = async () => {
                currentStreamReport?.getTracks().forEach(track => track.stop());
                currentStreamReport = null;

                const audioBlob = new Blob(audioChunksReport);
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);

                reader.onloadend = async () => {
                    const base64Audio = reader.result;

                    reportVoiceStatus.textContent = "â³ ì„œë²„ ì²˜ë¦¬ ì¤‘...";
                    showElements();
                    isProcessing = true; // ì„œë²„ ì²˜ë¦¬ ì¤‘ ìƒíƒœ


                    try {
                        const response = await fetch("{% url 'stores:voice_input' %}", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ audio: base64Audio, form_type: 'report' })
                        });

                        const data = await response.json();

                        if (!data.form_data) {
                            reportVoiceStatus.textContent = "âš ï¸ ìŒì„± ì²˜ë¦¬ ì‹¤íŒ¨";
                            isProcessing = false; // ì„œë²„ ì²˜ë¦¬ ì™„ë£Œ ìƒíƒœ
                            hideElementsAfterDelay(3000);
                            return;
                        }

                        const formData = data.form_data;

                        if (formData.store_name) document.getElementById('id_store_name').value = formData.store_name;
                        if (formData.report_items) document.getElementById('id_report_items').value = formData.report_items;
                        if (formData.time) document.getElementById('id_time').value = formData.time;

                        if (formData.address) {
                            document.getElementById('addressInput').value = formData.address;
                            const geocoder = new kakao.maps.services.Geocoder();
                            geocoder.addressSearch(formData.address, function(result, status) {
                                if (status === kakao.maps.services.Status.OK && result.length > 0) {
                                    document.getElementById('latitudeInput').value = result[0].y;
                                    document.getElementById('longitudeInput').value = result[0].x;
                                }
                            });
                        }

                        if (formData.keywords) {
                            let keywordsArr = Array.isArray(formData.keywords)
                                ? formData.keywords
                                : String(formData.keywords).split(',').map(s => s.trim());

                            keywordsArr.forEach(keywordText => {
                                document.querySelectorAll('input[name="keywords"]').forEach(checkbox => {
                                    const label = checkbox.parentElement;
                                    const labelText = label.textContent.trim().toLowerCase();
                                    if (labelText.includes(keywordText.toLowerCase())) {
                                        checkbox.checked = true;
                                        label.classList.add('selected');
                                    }
                                });
                            });
                        }

                        reportVoiceStatus.textContent = "âœ… ìŒì„± ì…ë ¥ ì™„ë£Œ";
                    } catch (err) {
                        console.error(err);
                        reportVoiceStatus.textContent = "âŒ ì„œë²„ ì˜¤ë¥˜";
                    } finally {
                        isProcessing = false; // ì„œë²„ ì²˜ë¦¬ ì™„ë£Œ ìƒíƒœ
                        hideElementsAfterDelay(3000);
                    }
                };
            };

            mediaRecorderReport.start();
        } catch (err) {
            console.error(err);
            reportVoiceStatus.textContent = "âŒ ë§ˆì´í¬ ì ‘ê·¼ ê±°ë¶€ë¨";
            hideElementsAfterDelay(3000);
        }
    });

    



    // â˜… í‚¤ì›Œë“œ ì„ íƒ ì²˜ë¦¬ â˜…
    // â˜… í‚¤ì›Œë“œ ì„ íƒ ì²˜ë¦¬ â˜…
const keywordLabels = document.querySelectorAll('.keyword-option');
keywordLabels.forEach(label => {
    const checkbox = label.querySelector('input[type="checkbox"]');

    // ì´ˆê¸° ì²´í¬ ìƒíƒœ ë°˜ì˜
    if (checkbox.checked) label.classList.add('selected');

    // ë¼ë²¨ í´ë¦­ ì‹œ ì²´í¬ë°•ìŠ¤ í† ê¸€
    label.addEventListener('click', e => {
        e.preventDefault(); // ê¸°ë³¸ ì²´í¬ í† ê¸€ ë°©ì§€

        const checkedCount = document.querySelectorAll('.keyword-option input[type="checkbox"]:checked').length;

        if (!checkbox.checked && checkedCount >= 3) {
            alert("ìµœëŒ€ 3ê°œì˜ í‚¤ì›Œë“œë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        checkbox.checked = !checkbox.checked;
        label.classList.toggle('selected', checkbox.checked);
    });
});



    const fileInput = document.getElementById('id_image');
    const fileInfoWrap = document.querySelector('.file_info_wrap');
    const fileNameSpan = document.querySelector('.file_name');
    const uploadIcon = document.querySelector('.upload_icon');
    const textBoxText = document.querySelector('.text_box_text');
    const deleteFileBtn = document.querySelector('.delete_file_btn');

    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
            // íŒŒì¼ëª… í‘œì‹œ
            fileNameSpan.textContent = fileInput.files[0].name;

            // ì—…ë¡œë“œ ì•„ì´ì½˜ê³¼ ë§í’ì„  ìˆ¨ê¸°ê¸°
            uploadIcon.style.display = 'none';
            textBoxText.style.display = 'none';

            // íŒŒì¼ ì •ë³´ ì˜ì—­ í‘œì‹œ
            fileInfoWrap.style.display = 'flex';
        }
    });

    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ˆê¸°í™”
    deleteFileBtn.addEventListener('click', function() {
        fileInput.value = ''; // íŒŒì¼ ì´ˆê¸°í™”
        fileNameSpan.textContent = '';

        // ì—…ë¡œë“œ ì•„ì´ì½˜ê³¼ ë§í’ì„  ë‹¤ì‹œ í‘œì‹œ
        uploadIcon.style.display = 'inline-block';
        textBoxText.style.display = 'block';

        // íŒŒì¼ ì •ë³´ ì˜ì—­ ìˆ¨ê¸°ê¸°
        fileInfoWrap.style.display = 'none';
    });

});

</script>


{% endblock script %}

{% block body %}
<div class="welcome_overlay"></div>

<div class="big_hugger">
  <div class="container">

<!-- ì§€ë„ ëª¨ë‹¬ -->
<div class="maphugger">
<div id="mapModal">
    <div style="text-align:right; padding:5px;">
        <button id="closeModal">Ã—</button>
    </div>
    <div id="mapContainer" ></div>
</div>
</div>

    <form method="post" enctype="multipart/form-data" id="reportForm">
    {% csrf_token %}
    <img src="{% static 'img/map_deco.png' %}" alt="ìœ„ ë°ì½”" class="deco" />
    <img src="{% static 'img/left_back_neon.png' %}" alt="ë’¤ë¡œê°€ê¸°" class="before_page" onclick="history.back()" />


    <!-- ê°€ê²Œ ì´ë¦„ -->
    <div class="gapsection">
      <label class="section-title">ê°€ê²Œì´ë¦„</label>
      <input type="text" name="store_name" id="id_store_name" class="text-input" value="{{ form.store_name.value|default_if_none:'' }}" placeholder="ì…ë ¥í•˜ì‹œì˜¤..." required/>
    </div>

    <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div class="section">
      <p class="section-title">ì´ë¯¸ì§€</p>
      <div class="file_upload">
        <!-- íŒŒì¼ ì—…ë¡œë“œ input -->
        <input type="file" name="image" id="id_image" accept="image/*" style="display: none;" />

        <!-- ì•„ì´ì½˜ -->
        <label for="id_image" class="upload_label">
          <img src="{% static 'img/add_photo.png' %}" alt="upload" class="upload_icon" />
        </label>

        <!-- ë§í’ì„  -->
        <div class="text_box_text">
          <img src="{% static 'img/textbox/text_box.png' %}" alt="ë§í’ì„ " class="textbox" />
          <span class="texts">ëˆ„ë¥´ë©´ <span style="color:grey;">ê°¤ëŸ¬ë¦¬ë¡œ ì—°ê²°ë¼ìš”!</span></span>
        </div>

        <!-- ì—…ë¡œë“œëœ íŒŒì¼ ì •ë³´ -->
        <div class="file_info_wrap" style="display: none;">
          <span class="file_name"></span>
          <button type="button" class="delete_file_btn">ì‚­ì œ</button>
        </div>
      </div>
    </div>


    <!-- ìŒì‹ ì¢…ë¥˜ -->
    <div class="section">
      <label class="section-title">ìŒì‹ì¢…ë¥˜</label>
      <input type="text" name="report_items" id="id_report_items" value="{{ form.report_items.value|default_if_none:'' }}" class="text-input" placeholder="ì…ë ¥í•˜ì‹œì˜¤..." required />
    </div>
    <!-- ì¥ì†Œ -->
    <div class="section">
      <label class="section-title">ì¥ì†Œ</label>
      <input type="hidden" id="latitudeInput" name="latitude" value="">
      <input type="hidden" id="longitudeInput" name="longitude" value="">
      <input type="text" class="text-input" id="addressInput" name="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì§€ë„ì—ì„œ ì„ íƒ" required>
      <button type="button" id="mapBtn">
        +
      </button>    
    </div>

    <!-- ì‹œê°„ -->
    <div class="gapsection">
      <label class="section-title">ì‹œê°„</label>
      <input type="text" name="time" id="id_time" value="{{ form.time.value|default_if_none:'' }}" class="text-input" placeholder="ì…ë ¥í•˜ì‹œì˜¤..." required />
    </div>

    <!-- í‚¤ì›Œë“œ -->
    <div class="keyword_section">
      <label class="section-title">#í‚¤ì›Œë“œ</label>
      <div class="keyword-list">
        {% for keyword in form.keywords.field.queryset %}
        <p class="keyword-option">
            <input type="checkbox" name="keywords" value="{{ keyword.id }}" style="display:none;"
            {% if form.keywords.value %}
                {% if keyword.id|stringformat:"s" in form.keywords.value %}
                checked
                {% endif %}
            {% endif %}>
            {{ keyword.keyword }}
        </p>
        {% endfor %}
      </div>
    </div>
    <!-- ë“±ë¡ ë²„íŠ¼ -->
    <div class="btn_hugger">
      <div class="voice_recognization">

        <div class="voice_texts">
          <img src="{% static 'img/textbox/text_box.png' %}" alt="ë§í’ì„ " class="voice_textbox" />
          <span id="voiceStatus" class="texts">ìŒì„±ë…¹ìŒ <span style="color:gray;">ë“±ë¡ì´ ê°€ëŠ¥í•´ìš”!</span></span>
        </div>

        <button class="circle_btn" type="button" id="voiceBtn" data-form-type="report">
          <img src="{% static 'img/mic.png' %}" alt="ìŒì„±ì¸ì‹ë²„íŠ¼" class="voice_recognization_btn" />
        </button>
      </div>
      <button type="submit" class="register_btn">ë“±ë¡í•˜ê¸°</button>
    </div>
  </form>
  </div>

  
</div>

<!-- ìŒì„± ì¸ì‹ ëª¨ë‹¬
<div class="voice_modal hidden">
  <div class="voice_modal_overlay"></div>
  <div class="voice_modal_content">
    <button class="voice_modal_close">âœ•</button>
    <div class="text_box_area">
      <img src="{% static 'img/textbox/vertical_text_box.png' %}" alt="ë§í’ì„ " class="voice_modal_ann">
      <div class="ann_text">ë²„íŠ¼ì„ ëˆ„ë¥´ê³ , ë§í•˜ì„¸ìš”!</div>
    </div>
    <div class="voice_recognizing_btn">
      <button type="button" id="voiceBtn" data-form-type="report">
        <img src="{% static 'img/mic_neon.png' %}" alt="ìŒì„± ì¸ì‹ ë²„íŠ¼" class="voice_modal_mic">
      </button>
      <span id="voiceStatus" style="margin-left:10px;color:#555;">(ë…¹ìŒ ìƒíƒœ í‘œì‹œ)</span>
    </div>
  </div>
</div> -->

{% endblock body %}
