{% extends "base.html" %}
{% block content %}

<h2>ê°€ê²Œ ì œë³´í•˜ê¸°</h2>
<hr>

<form method="post" enctype="multipart/form-data" id="reportForm">
    {% csrf_token %}
    <div>
        <label>ê°€ê²Œ ë³„ëª…</label>
        {{ form.store_name }}
    </div>


    <div>
        <label>ì´ë¯¸ì§€</label>
        {{ form.image }}
    </div>
    
    <div>
        <label>í’ˆëª©</label>
        {{ form.report_items }}
    </div>
    
    <div>
        <label>ì‹œê°„</label>
        {{ form.time }}
    </div>

    <div>
        <p>í‚¤ì›Œë“œ ì„ íƒ</p>
        {% for keyword in form.keywords.field.queryset %}
            <label>
                <input type="checkbox" name="keywords" value="{{ keyword.id }}"
                {% if keyword in form.keywords.value %}checked{% endif %}>
                {{ keyword.keyword }}
            </label>
        {% endfor %}
    </div>

    <div>
        <label>ì£¼ì†Œ</label>
        <input type="hidden" id="latitudeInput" name="latitude" value="">
        <input type="hidden" id="longitudeInput" name="longitude" value="">
        <input type="text" id="addressInput" name="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì§€ë„ì—ì„œ ì„ íƒ">
        <button type="button" id="mapBtn">ì§€ë„ì—ì„œ ìœ„ì¹˜ ì„ íƒ</button>
    </div>

    <button type="submit">ì œë³´í•˜ê¸°</button>
</form>

<!-- ìŒì„± ì¸ì‹ ë²„íŠ¼ -->
<div>
    <button type="button" id="voiceBtn" data-form-type="report">ğŸ¤ ìŒì„± ì¸ì‹</button>
    <span id="voiceStatus" style="margin-left:10px;color:#555;">(ë…¹ìŒ ìƒíƒœ í‘œì‹œ)</span>
</div>

<!-- ì§€ë„ ëª¨ë‹¬ -->
<div id="mapModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; z-index:1000; border:1px solid #ccc;">
    <div style="text-align:right; padding:5px;">
        <button id="closeModal">ë‹«ê¸°</button>
    </div>
    <div id="mapContainer" style="width:100%; height:90%;"></div>
</div>

<!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8&libraries=services"></script>
<script>
const addressInput = document.getElementById('addressInput');
const latitudeInput = document.getElementById('latitudeInput');
const longitudeInput = document.getElementById('longitudeInput');
const geocoder = new kakao.maps.services.Geocoder();

let map, marker;

// ì§€ë„ ëª¨ë‹¬ ì—´ê¸°
document.getElementById('mapBtn').onclick = function() {
    document.getElementById('mapModal').style.display = 'block';
    setTimeout(function() {
        let initLat = parseFloat(latitudeInput.value) || 37.6509;
        let initLng = parseFloat(longitudeInput.value) || 127.0164;
        const initPos = new kakao.maps.LatLng(initLat, initLng);
        mapInit(initPos);
    }, 100);
};

// ì§€ë„ ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('closeModal').onclick = function() {
    document.getElementById('mapModal').style.display = 'none';
};

// ì§€ë„ ì´ˆê¸°í™”
function mapInit(center) {
    if (!map) {
        map = new kakao.maps.Map(document.getElementById('mapContainer'), {
            center: center,
            level: 3
        });
    } else {
        map.setCenter(center);
    }

    if (!marker) {
        marker = new kakao.maps.Marker({ position: center, map: map });
    } else {
        marker.setPosition(center);
    }

    // ì§€ë„ í´ë¦­ ì‹œ ì£¼ì†Œ/ì¢Œí‘œ ë°˜ì˜
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const latlng = mouseEvent.latLng;
        marker.setPosition(latlng);

        geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK && result[0].address.address_name) {
                addressInput.value = result[0].address.address_name;
                latitudeInput.value = latlng.getLat();
                longitudeInput.value = latlng.getLng();
            } else {
                alert("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨. í•œê¸€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                latitudeInput.value = latlng.getLat();
                longitudeInput.value = latlng.getLng();
            }
        });
    });
}

//ì—¬ê¸°ë¶€í„° ìŒì„±ì¸ì‹ 
const voiceBtn = document.getElementById('voiceBtn');
const voiceStatus = document.getElementById('voiceStatus');

voiceBtn.onclick = async () => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì…ë ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    voiceStatus.textContent = "ğŸ¤ ë…¹ìŒ ì¤‘...";
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        const audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.start();

        voiceBtn.textContent = "â¹ï¸ ë…¹ìŒ ì¤‘ì§€";
        voiceBtn.onclick = () => mediaRecorder.stop();

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64Audio = reader.result;
                voiceStatus.textContent = "â³ ì„œë²„ ì²˜ë¦¬ ì¤‘...";

                try {
                    const response = await fetch("{% url 'stores:voice_input' %}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ audio: base64Audio, form_type: "report" })
                    });

                    const data = await response.json();
                    if (!data.form_data) {
                        voiceStatus.textContent = "âš ï¸ ìŒì„± ì²˜ë¦¬ ì‹¤íŒ¨";
                        return;
                    }

                    const formData = data.form_data;

                    // report í¼ í•„ë“œ ì±„ìš°ê¸° (ìœ„ë„/ê²½ë„ëŠ” ì œì™¸)
                    if (formData.store_name) document.querySelector('input[name="store_name"]').value = formData.store_name;
                    if (formData.address) document.querySelector('input[name="address"]').value = formData.address;
                    if (formData.report_items) document.querySelector('input[name="report_items"]').value = formData.report_items;
                    if (formData.time) document.querySelector('input[name="time"]').value = formData.time;

                    voiceStatus.textContent = "âœ… ìŒì„± ì…ë ¥ ì™„ë£Œ";
                } catch (err) {
                    console.error(err);
                    voiceStatus.textContent = "âŒ ì„œë²„ ì˜¤ë¥˜";
                }

                voiceBtn.textContent = "ğŸ¤ ìŒì„± ì…ë ¥";
                voiceBtn.onclick = voiceBtn.onclick; // ë²„íŠ¼ ì›ë˜ ê¸°ëŠ¥ ë³µì›
            };
        };
    } catch (err) {
        console.error(err);
        voiceStatus.textContent = "âŒ ë§ˆì´í¬ ì ‘ê·¼ ê±°ë¶€ë¨";
    }
};

</script>

{% endblock %}