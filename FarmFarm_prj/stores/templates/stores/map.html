{% extends "base.html" %}

{% block content %}
<!-- 검색창 추가 -->
<div style="margin-bottom: 16px;">
    <input type="text" id="storeSearchInput" placeholder="가게 이름 또는 품목 검색" style="width: 300px; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
    <button id="searchBtn" style="padding: 8px 16px; border-radius: 8px; background: #6d6f6d; color: #fff; border: none;">검색</button>
    <button id="resetBtn" style="padding: 8px 16px; border-radius: 8px; background: #bdbdbd; color: #333; border: none; margin-left: 8px;">초기화</button>
</div>

<hr>

<!-- 지도 영역 -->
<div id="map" style="width:100%; height:400px;"></div>

<!-- 구매자 한정 가게 제보 버튼 -->
{% if request.user.is_authenticated and request.user.usertype == 'BUYER' %}
    <button id="reportStoreBtn">
        가게 제보
    </button>
{% endif %}

{{ stores|json_script:"store-data" }}

<style>
    #map { height: 100vh; }
    .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #000; color: #fff; border-radius: 20px; transition: bottom 0.3s ease-in-out; padding: 20px; max-height: 80vh; overflow-y: auto; }
    .bottom-sheet.active { bottom: 0; }
    .item-card { background: #c5d2bc; color: #000; padding: 1rem; border-radius: 15px; margin-bottom: 1rem; }
</style>

<!-- 하단 모달 -->
<div id="storeModal" style="
    position: fixed;
    left: 0;
    bottom: 0;
    width: 500px;
    height: 60vh;
    background: #fff;
    border-radius: 24px 24px 0 0;
    box-shadow: 0 -2px 12px rgba(0,0,0,0.15);
    z-index: 999;
    display: none;
    overflow-y: auto;
    padding: 24px;
">
    <h3 id="modalStoreName"></h3>    
    <button onclick="closeStoreModal()">닫기</button>
    <p id="modalStoreAddress"></p>
    <div id="modalItemList"></div>

</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8&libraries=services"></script>
<script>
var mapContainer = document.getElementById('map');
var mapOption = {
    center: new kakao.maps.LatLng(37.6509, 127.0164),
    level: 5
};
var map = new kakao.maps.Map(mapContainer, mapOption);

{% if request.user.is_authenticated and request.user.usertype == 'SELLER' and request.user.store %}
    // 판매자: 자신의 가게 좌표로 중심 이동
    var sellerLat = "{{ request.user.store.latitude|default:'37.6509' }}";
    var sellerLng = "{{ request.user.store.longitude|default:'127.0164' }}";
    map.setCenter(new kakao.maps.LatLng(Number(sellerLat), Number(sellerLng)));
{% elif request.user.is_authenticated and request.user.usertype == 'BUYER' %}
    // 구매자: 현재 위치로 중심 이동
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            map.setCenter(new kakao.maps.LatLng(lat, lng));
        });
    }
{% endif %}


var stores = JSON.parse(document.getElementById('store-data').textContent);
var markers = [];

// 마커 생성 함수
function addMarker(store) {
    var geocoder = new kakao.maps.services.Geocoder();
    geocoder.addressSearch(store.address, function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            var marker = new kakao.maps.Marker({
                map: map,
                position: coords
            });
            markers.push(marker);
            var infowindow = new kakao.maps.InfoWindow({
                content: '<div style="padding:5px; min-width:120px;"><b>' + store.name + '</b><br>판매자: ' + store.seller + '<br>' + store.address + '</div>'
            });
            kakao.maps.event.addListener(marker, 'click', function() {
                fetchStoreItems(store.id, store.name);
                showStoreModal(store);
            });
        }
    });
};

// 아래는 품목 및 예약 UI 관련 JS
const storeModal = document.getElementById('storeModal');
const modalItemListEl = document.getElementById('modalItemList');

async function fetchStoreItems(storeId, storeName) {
    const response = await fetch(`/reservations/api/store/${storeId}/items/`);
    const data = await response.json();

    document.getElementById('modalStoreName').textContent = storeName;
    modalItemListEl.innerHTML = '';

    data.items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.innerHTML = `
            <img width="100" src="${item.photo_url}" alt="${item.name}" class="item-image">
            <p><strong>${storeName}</strong> </p>
            <p><strong>품목:</strong> ${item.name} (${item.unit}) ${item.price.toLocaleString()}원</p>
            <p><strong>판매 시간:</strong> ${item.sale_hours || ''}</p>
            <p><strong>위치:</strong> ${item.address || ''}</p>
            <p><strong>설명:</strong> ${item.description || ''}</p>
        `;
        modalItemListEl.appendChild(card);
    });

    storeModal.style.display = 'block';
}

function closeStoreModal() {
    document.getElementById('storeModal').style.display = 'none';
}

modalItemListEl.addEventListener('click', function(e) {
    if (e.target.classList.contains('show-reserve-ui-btn')) {
        const card = e.target.closest('.item-card');
        const ui = card.querySelector('.reservation-ui');
        ui.style.display = 'block';
        e.target.style.display = 'none';
    }
    if (e.target.classList.contains('reserve-btn')) {
        const card = e.target.closest('.item-card');
        const quantity = card.querySelector('.quantity').value;
        const pickupTime = card.querySelector('.pickup-time').value;
        const itemId = e.target.dataset.itemId;
        const reservationData = {
            item_id: itemId,
            quantity: quantity,
            pickup_time: pickupTime
        };
        createReservation(reservationData);
    }
});

async function createReservation(data) {
    const response = await fetch('/reservations/api/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(data),
    });
    // ... 결과 처리 로직 ...
}

var markers = [];

function renderMarkers(filteredStores) {
    // 기존 마커 제거
    markers.forEach(m => m.setMap(null));
    markers = [];
    filteredStores.forEach(function(store) {
        var geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(store.address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });
                markers.push(marker);
                var infowindow = new kakao.maps.InfoWindow({
                    content: '<div style="padding:5px; min-width:120px;"><b>' + store.name + '</b><br>판매자: ' + store.seller + '<br>' + store.address + '</div>'
                });
                kakao.maps.event.addListener(marker, 'click', function() {
                    fetchStoreItems(store.id, store.name);
                    showStoreModal(store);
                });
            }
        });
    });
}

// 최초 전체 마커 렌더링
renderMarkers(stores);


// 검색 기능 수정
function filterStores() {
    var keyword = document.getElementById('storeSearchInput').value.trim().toLowerCase();
    if (!keyword) {
        renderMarkers(stores);
        return;
    }
    var filtered = stores.filter(store => {
        if (store.name.toLowerCase().includes(keyword)) return true;
        if (store.items.some(item => item.name.toLowerCase().includes(keyword))) return true;
        return false;
    });
    renderMarkers(filtered);
    if (filtered.length > 0) {
        showStoresModal(filtered);
    }
}

document.getElementById('searchBtn').addEventListener('click', filterStores);
document.getElementById('storeSearchInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') filterStores();
});
document.getElementById('resetBtn').addEventListener('click', function() {
    document.getElementById('storeSearchInput').value = '';
    renderMarkers(stores);
});


</script>
{% endblock %}
