{% extends "base_2.html" %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/stores.css' %}" />

{% endblock style %}

{% block script %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=99fb650695dceb9f3c38f165656fe2c8&libraries=services"></script>


{% if request.user.is_authenticated and request.user.usertype == 'BUYER' %}
<script>
    const isBuyer = true;
</script>
{% else %}
<script>
    const isBuyer = false;
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- 전역 변수 ---
    const mapContainer = document.getElementById('map');
    const mapOption = { center: new kakao.maps.LatLng(37.6509, 127.0164), level: 5 };
    const map = new kakao.maps.Map(mapContainer, mapOption);
    let markers = [];
    const markerImageSrc = "{% static 'img/stores.png' %}";
    const stores = JSON.parse(document.getElementById('store-data').textContent);
    const reports = JSON.parse(document.getElementById('report-data').textContent);
    const storeModal = document.getElementById('storeModal');
    const modalItemListEl = document.getElementById('modalItemList');
    const reportModal = document.getElementById('reportModal');
    const csrfToken = '{{ csrf_token }}';

    // 사용자 타입

    // --- 지도 중심 설정 ---
    {% if request.user.is_authenticated and request.user.usertype == 'SELLER' and request.user.store %}
        const sellerLat = "{{ request.user.store.latitude|default:'37.6509' }}";
        const sellerLng = "{{ request.user.store.longitude|default:'127.0164' }}";
        map.setCenter(new kakao.maps.LatLng(Number(sellerLat), Number(sellerLng)));
    {% elif request.user.is_authenticated and request.user.usertype == 'BUYER' %}
        {% if request.user.is_authenticated and request.user.store %}
            const centerLat = "{{ request.user.store.latitude|default:'37.6509' }}";
            const centerLng = "{{ request.user.store.longitude|default:'127.0164' }}";
            map.setCenter(new kakao.maps.LatLng(Number(centerLat), Number(centerLng)));
        {% else %}
            map.setCenter(new kakao.maps.LatLng(37.6509, 127.0164));
        {% endif %}
    {% endif %}

    // --- 모달 열기/닫기 ---
    function openStoreModal() { storeModal.style.display = 'block'; }
    function closeStoreModal() { storeModal.style.display = 'none'; }
    function openReportModal() { reportModal.style.display = 'block'; }
    function closeReportModal() { reportModal.style.display = 'none'; }

    window.closeStoreModal = closeStoreModal;
    window.closeReportModal = closeReportModal;

    // --- 판매자 마커 ---
    function createStoreMarker(store) {
        if (!store.latitude || !store.longitude) return;
        const coords = new kakao.maps.LatLng(store.latitude, store.longitude);
        const markerImage = new kakao.maps.MarkerImage(markerImageSrc, new kakao.maps.Size(20,20), { offset: new kakao.maps.Point(20, 40) });
        const marker = new kakao.maps.Marker({ map: map, position: coords, title: store.name, image: markerImage });
        markers.push(marker);
        kakao.maps.event.addListener(marker, 'click', () => fetchStoreItems(store.id, store.name));
    }

    // --- 제보 마커 ---
    function createReportMarker(report){
        if(report.latitude && report.longitude){
            placeReportMarker(new kakao.maps.LatLng(report.latitude, report.longitude), report);
        } else if(report.address){
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(report.address, function(result, status){
                if(status === kakao.maps.services.Status.OK){
                    placeReportMarker(new kakao.maps.LatLng(result[0].y, result[0].x), report);
                }
            });
        }
    }

    function placeReportMarker(coords, report){
        const markerImage = new kakao.maps.MarkerImage(markerImageSrc, new kakao.maps.Size(20, 20), { offset: new kakao.maps.Point(20, 40) });
        const marker = new kakao.maps.Marker({ map: map, position: coords, title: report.store_name, image: markerImage });
        markers.push(marker);

        kakao.maps.event.addListener(marker,'click', function(){ 
            const reportItemListEl = document.getElementById('reportItemList');
            reportItemListEl.innerHTML = '';

            document.getElementById('reportName').innerHTML = `<span class="many_items_store_name">${report.store_name}</span>`;

            // 이미지 카드
            const imgCard = document.createElement('div');
            imgCard.className = 'report-item-card';
            imgCard.innerHTML = `<div class="modal_info_box"><img src="${report.image || 'https://placehold.co/200x150?text=No+Image'}" alt="${report.store_name}" class="report_modal_img"></div>`;
            reportItemListEl.appendChild(imgCard);

            // 품목 + 키워드
            if((report.items && report.items.length>0) || (report.keywords && report.keywords.length>0)){
                report.items?.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'report-item-card';
                    card.innerHTML = `
                    <div>
                    <strong>품목:</strong> ${item.name} (${item.unit||''})
                    </div>
                    <div>
                    <strong>설명:</strong> ${item.description||''}
                    </div>
                    ${report.keywords && report.keywords.length>0 ? `<div><strong>키워드:</strong> ${report.keywords.join(', ')}</div>` : ''}

                    `;
                    reportItemListEl.appendChild(card);
                });
                
            } else {
                const card = document.createElement('div');
                card.className = 'report-item-card';
                card.innerHTML = '<div>등록된 품목이 없습니다.</div>';
                reportItemListEl.appendChild(card);
            }

            openReportModal();
        });
    }

    // --- 판매자 모달 & 예약 ---
    async function fetchStoreItems(storeId, storeName) {
        try {
            const resp = await fetch(`/reservations/api/store/${storeId}/items/`);
            if (!resp.ok) throw new Error('API response not OK');
            const data = await resp.json();

            modalItemListEl.innerHTML = '';
            document.getElementById('modalStoreName').innerHTML = `<span class="many_items_store_name">${storeName}</span>`;

            if(data.items && data.items.length>0){
                data.items.forEach(item=>{
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.dataset.itemId = item.id;

                    card.innerHTML = `
                    <div class="per_stores">
                        <div class="modal_info_box">
                            ${item.photo_url ? `<img src="${item.photo_url}" alt="${item.name}" class="modal_product_img">` : ''}
                            <div class="detail_info">
                                <p class="product_detail"><strong>품목:</strong> ${item.name} (${item.unit||''}) ${item.price.toLocaleString()}원</p>
                                <p><strong>설명:</strong> ${item.description||''}</p>
                            </div>
                        </div>
                    </div>
                    ${isBuyer ? `
                    <div class="reservation-form">
                        <div class="reserve_controls">
                            <div class="quantity_box">
                                <div class="qty-box" style="display:flex; gap:8px; align-items:center;">
                                    <button type="button" class="qty_btn minus-btn">-</button>
                                    <input type="number" class="qty-input quantity" value="1" min="1" style="width:50px; text-align:center;">
                                    <button type="button" class="qty_btn plus-btn">+</button>
                                </div>
                            </div>
                            <div class="time_box">
                                <input type="time" class="pickup-time-input" step="600" required style="margin-bottom:10px;">
                            </div>
                        </div>
                        <div class="resbuttonhugger">
                            <button type="button" class="reserve_btn reserve-now-btn">예약하기</button>
                        </div>
                    </div>` : ''}`;

                    modalItemListEl.appendChild(card);
                });
            } else {
                modalItemListEl.innerHTML = '<p>등록된 품목이 없습니다.</p>';
            }

            openStoreModal();
        } catch(err){
            console.error(err);
            modalItemListEl.innerHTML = '<p>품목 정보를 불러오는 데 실패했습니다.</p>';
            openStoreModal();
        }
    }

    // --- 모달 내 예약 버튼 이벤트 ---
    modalItemListEl.addEventListener('click', function(event){
        const card = event.target.closest('.item-card');
        if(!card) return;

        const qtyInput = card.querySelector('.qty-input');
        let currentQty = parseInt(qtyInput?.value || 1);

        if(event.target.classList.contains('plus-btn')) qtyInput.value = currentQty + 1;
        else if(event.target.classList.contains('minus-btn')) qtyInput.value = Math.max(1, currentQty - 1);
        else if(event.target.classList.contains('reserve-now-btn')){
            const itemId = card.dataset.itemId;
            const quantity = qtyInput.value;
            const pickupTime = card.querySelector('.pickup-time-input').value;
            submitReservation(itemId, quantity, pickupTime);
        }
    });

    async function submitReservation(itemId, quantity, pickupTime){
        if(!pickupTime){ alert('픽업 시간을 선택해주세요.'); return; }
        const payload = { item_id: itemId, quantity, pickup_time: pickupTime };

        try{
            const resp = await fetch("{% url 'reservations:api_create' %}", {
                method:'POST',
                headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(payload)
            });
            const result = await resp.json();
            if(resp.ok){
                alert('예약이 완료되었습니다!');
                closeStoreModal();
                window.location.href = "{% url 'reservations:list' %}";
            } else throw new Error(result.error || '예약 실패');
        } catch(err){
            console.error(err);
            alert(`예약 중 오류 발생: ${err.message}`);
        }
    }

    // --- 초기 마커 렌더링 ---
    stores.forEach(createStoreMarker);
    reports.forEach(createReportMarker);

    // --- 검색 & 초기화 ---
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('storeSearchInput');
    const resetBtn = document.getElementById('resetBtn');

    function filterStores(){
        const keyword = searchInput.value.trim().toLowerCase();
        if(!keyword){ renderMarkers(stores, reports); return; }

        const filteredStores = stores.filter(s => s.name?.toLowerCase().includes(keyword) || s.items?.some(i=>i.name?.toLowerCase().includes(keyword)));
        const filteredReports = reports.filter(r => r.store_name?.toLowerCase().includes(keyword) || r.items?.some(i=>i.name?.toLowerCase().includes(keyword)));
        renderMarkers(filteredStores, filteredReports);
    }

    function renderMarkers(filteredStores, filteredReports){
        markers.forEach(m => m.setMap(null));
        markers = [];
        filteredStores.forEach(createStoreMarker);
        filteredReports.forEach(createReportMarker);
    }

    searchBtn.addEventListener('click', filterStores);
    searchInput.addEventListener('keydown', e => { if(e.key === 'Enter') filterStores(); });
    if(resetBtn) resetBtn.addEventListener('click', () => { searchInput.value=''; renderMarkers(stores, reports); });

});
</script>

{% endblock script %}

{% block body %}
<div class="big_hugger">
    <div class="container">

        <!-- 검색창 -->
        <div class="search_box">
            <img src="{% static 'img/map_deco.png' %}" alt="지도 검색창 위 데코" class="map_deco">
            <div class="searching_">
                <input type="text" class="searchInput" id="storeSearchInput" placeholder="입력하시오..." />
                <button id="searchBtn">
                    <img src="{% static 'img/search.png' %}" alt="검색 아이콘">
                </button>
                <button id="resetBtn" style="display:none;"></button> <!-- 초기화 버튼 (필요시 활성화) -->
            </div>
        </div>

        <!-- 지도 -->
        <div id="map"><div id="errorMessage"></div></div>

        <!-- 구매자 가게 제보 버튼 -->
        {% if request.user.is_authenticated and request.user.usertype == 'BUYER' %}
        <div class="adding_zone">
            <div class="add_store_msg msg">
                <img src="{% static 'img/textbox/text_box.png' %}" alt="말풍선" class="textbox">
                <div class="text">가게<span style="color:grey;">를 추가해주세요!</span></div>
            </div>
            <a href="{% url 'stores:store_report' %}" class="add_store_btn">
                <button type="button" value="가게 추가" id="add_store">+</button>
            </a>
        </div>
        {% endif %}

        {{ stores|json_script:"store-data" }}
        {{ reports|json_script:"report-data" }}

        <!-- 판매자 모달 -->
        <div id="storeModal" class="bottom_sheet" style="display:none;">
            <div class="sheet_content_v2">
                <div class="many_items_store">
                    <h3 id="modalStoreName"></h3>
                    <button onclick="closeStoreModal()" class="closingbtn">×</button>
                    <div id="modalItemList"></div>
                </div>
            </div>
        </div>

        <!-- 제보 모달 -->
        <div id="reportModal" class="bottom_sheet" style="display:none;">
            <div class="sheet_content_v2">
                <div class="many_items_store_r">
                    <h3 id="reportName"></h3>
                    <button onclick="closeReportModal()" class="closingbtn">×</button>
                    <div id="reportItemList"></div>
                </div>
            </div>
        </div>



        <!-- 네비게이션 바 -->
        <div class="nav_box">
        {% if user.usertype == 'BUYER' %}
        <nav class="bottom_nav">
            <img src="{% static 'img/now_page.png' %}" alt="현재 페이지" class="now_page">
            <div class="btn selected_nav">
            <a href="{% url 'stores:map' %}">
                <img src="{% static 'img/map_page_black.png' %}" alt="지도페이지" class="map_page">
            </a>
            </div>
            <div class="btn">
            <a href="{% url 'users:buyer_home' %}">
                <img src="{% static 'img/home_page_gray.png' %}" alt="홈페이지" class="home_page">
            </a>
            </div>
            <div class="btn">
            <a href="{% url 'shopping:ai_shopping' %}">
                <span class="shopping_page">AI</span>
            </a>
            </div>
        </nav>
        {% elif user.usertype == 'SELLER' %}
        <nav class="bottom_nav">
            <img src="{% static 'img/now_page.png' %}" alt="현재 페이지" class="now_page">
            <div class="btn selected_nav">
            <a href="{% url 'stores:map' %}">
                <img src="{% static 'img/map_page_black.png' %}" alt="지도페이지" class="map_page">
            </a>
            </div>
            <div class="btn">
            <a href="{% url 'users:seller_home' %}">
                <img src="{% static 'img/home_page_gray.png' %}" alt="홈페이지" class="home_page">
            </a>
            </div>
            <div class="btn">
            <a href="{% url 'reservations:seller_list' %}">
                <span class="shopping_page">예약</span>
            </a>
            </div>
        </nav>
        {% endif %}
        </div>


    </div>
</div>
{% endblock %}
