{% extends "base_2.html" %} 
{% load static %} 

{% block style %}
<link rel="stylesheet" href="{% static 'css/consumer_home/consumer_main.css' %}"/>
<link rel="stylesheet" href="{% static 'css/consumer_home/consumer_profile.css' %}"/>
{% endblock style %} 

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
//ìºë¦­í„°ë‹‰ë„¤ì„ìˆ˜ì •ê´€ë ¨ 
document.addEventListener("DOMContentLoaded", async function () {
    const nicEl = document.getElementById("character-nic");
    if (!nicEl) return;

    // 1) ë¡œì»¬ì— ì§ì „ ì €ì¥ê°’ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ë°˜ì˜(ì˜µì…˜)
    try {
        const cached = localStorage.getItem("characterNameValue");
        if (cached) nicEl.textContent = cached;
    } catch (_) {}

    // 2) ì„œë²„ì˜ ìµœì‹  ê°’ìœ¼ë¡œ í™•ì • ë°˜ì˜
    try {
        const res = await fetch("{% url 'rewards:get_reward_status' %}");
        if (!res.ok) throw new Error("ë¦¬ì›Œë“œ ì •ë³´ ë¡œë”© ì‹¤íŒ¨");
        const data = await res.json();
        if (data.character_name) {
        nicEl.textContent = data.character_name;
        }
    } catch (e) {
        console.error(e);
    }
});
document.addEventListener("DOMContentLoaded", function() {
    // --- í”„ë¡œí•„ ìˆ˜ì • ê´€ë ¨ ë¡œì§ ---
    const fileInput = document.getElementById('modal_item_photo');
    const fileNamePreview = document.getElementById('fileNamePreview');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if(file) {
                fileNamePreview.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const btn = document.querySelector('.edit-item-btn[data-id="'+modalId.value+'"]');
                    const parent = btn.closest('.information_hugger');
                    const imgTag = parent.querySelector('.product-img');
                    imgTag.src = e.target.result;
                }
                reader.readAsDataURL(file);
            } else {
                fileNamePreview.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const profileEditModal = document.getElementById('profileEditModal');
    const profileEditBtn = document.getElementById('editProfileBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const profileImageEditBtn = document.querySelector('.image-edit-btn');
    const profileImageInput = document.getElementById('profileImageInput');
    const profileEditForm = document.getElementById('profileEditForm');
    
    if (profileEditBtn) {
        profileEditBtn.addEventListener('click', function(e){
            e.preventDefault();
            if(profileEditModal) profileEditModal.style.display = 'flex';
        });
    }
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if(profileEditModal) profileEditModal.style.display = 'none';
        });
    }

    if(profileImageEditBtn && profileImageInput){
        profileImageEditBtn.addEventListener('click', function(e){
            e.preventDefault();
            profileImageInput.click();
        });
    }

    if (profileImageInput) {
        profileImageInput.addEventListener('change', function(){
            var formData = new FormData(profileEditForm);
            formData.append('edit_type', 'image');
            $.ajax({
                url: "{% url 'users:profile_edit' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': csrftoken },
                success: function(response){
                    document.getElementById('profileImage').src = response.new_image_url + "?t=" + new Date().getTime();
                    document.querySelector('.preview_img').src = response.new_image_url + "?t=" + new Date().getTime();
                    location.reload();
                },
                error: function(err){
                    console.log(err);
                    alert("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨");
                }
            });
        });
    }

    const nicknameBtn = profileEditForm ? profileEditForm.querySelector('button[name="edit_type"][value="name"]') : null;
    if (nicknameBtn) {
        nicknameBtn.addEventListener('click', function(e){
            e.preventDefault();
            var formData = new FormData(profileEditForm);
            formData.append('edit_type', 'name');
            $.ajax({
                url: "{% url 'users:profile_edit' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': csrftoken },
                success: function(){
                    alert("ì´ë¦„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                },
                error: function(err){
                    console.log(err);
                    alert("ë‹‰ë„¤ì„ ìˆ˜ì • ì‹¤íŒ¨");
                }
            });
        });
    }

    // --- ë¦¬ì›Œë“œ ë° ìºë¦­í„° ì •ë³´ ë¡œë”© ë¡œì§ ---
    const characterMainImages = {
        0: "{% static 'img/level0.png' %}", // Level 0 ì´ë¯¸ì§€ ì¶”ê°€
        1: "{% static 'img/level1.png' %}",
        2: "{% static 'img/level2.png' %}",
        3: "{% static 'img/level3.png' %}",
    };
    const characterStyles = {
        0: { transform: 'scale(0.5)', marginTop: '40px', marginLeft: '0px' }, // Level 0 ìŠ¤íƒ€ì¼
        1: { transform: 'scale(1.0)', marginTop: '40px', marginLeft: '0px' },
        2: { transform: 'scale(0.9)', marginTop: '30px', marginLeft: '0px' },
        3: { transform: 'scale(1.1)', marginTop: '30px', marginLeft: '0px' }
    };
    const thumbnailStyles = {
        1: { transform: 'scale(1.5)' },
        2: { transform: 'scale(1.0)' },
        3: { transform: 'scale(3.0)', marginTop: '50px' },
    };
    const stampOnImages = [
        "{% static 'img/stamps/stamp_on.png' %}",
        "{% static 'img/stamps/stamp_on2.png' %}",
        "{% static 'img/stamps/stamp_on3.png' %}",
    ];
    // ì˜¤íƒ€ ìˆ˜ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
    const stampOffImages = [
        "{% static 'img/stamps/stamp_off.png' %}",
        "{% static 'img/stamps/stamp_off2.png' %}",
        "{% static 'img/stamps/stamp_off3.png' %}",
    ];
    async function fetchRewardStatus() {
        try {
            const response = await fetch("{% url 'rewards:get_reward_status' %}");
            if (!response.ok) throw new Error('ë¦¬ì›Œë“œ ì •ë³´ ë¡œë”© ì‹¤íŒ¨');
            const data = await response.json();
            updateRewardUI(data);
        } catch (error) {
            console.error('ë¦¬ì›Œë“œ ì •ë³´ ë¡œë”© ì˜¤ë¥˜:', error);
        }
    }

    function updateRewardUI(data) {
        // [ìˆ˜ì •] ì´ ìŠ¤íƒ¬í”„ ê°œìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  UIë¥¼ ì—…ë°ì´íŠ¸
        const medalToStampCount = { 'NONE': 0, 'BRONZE': 4, 'SILVER': 8, 'GOLD': 12 };
        const totalStamps = data.medal_tier === 'GOLD' ? 12 : (medalToStampCount[data.medal_tier] || 0) + data.stamp_count;

        // 1. ì´ ìŠ¤íƒ¬í”„ ê°œìˆ˜ì— ë”°ë¼ í™”ë©´ì— í‘œì‹œí•  ë ˆë²¨ ê²°ì • (0, 1, 2, 3)
        let displayLevel;
        if (totalStamps < 4) {
            displayLevel = 0;
        } else if (totalStamps < 8) {
            displayLevel = 1;
        } else if (totalStamps < 12) {
            displayLevel = 2;
        } else {
            displayLevel = 3;
        }
        
        const levelText = document.getElementById('character-level-text');
        if(levelText) levelText.textContent = data.character_level; // DB ë ˆë²¨ì€ ê·¸ëŒ€ë¡œ í‘œì‹œ

        // 2. ë©”ì¸ ìºë¦­í„° ì´ë¯¸ì§€ ë° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        const mainImage = document.getElementById('character-main-image');
        if (mainImage) {
            mainImage.src = characterMainImages[displayLevel];
            const styles = characterStyles[displayLevel];
            mainImage.style.transform = styles.transform;
            mainImage.style.marginTop = styles.marginTop;
            mainImage.style.marginLeft = styles.marginLeft;
        }
        
        // 3. ì¸ë„¤ì¼ ë° í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
        const arrow = document.getElementById('level-arrow');
        document.querySelectorAll('.level-thumbnail').forEach((thumb) => {
            // HTMLì— data-level="1", data-level="2" ë“±ì„ ì¶”ê°€í•´ì•¼ ì •í™•íˆ ë™ì‘í•©ë‹ˆë‹¤.
            const thumbLevel = parseInt(thumb.id.split('-')[2], 10);
            thumb.style.border = 'none';
            if (thumbLevel === displayLevel) {
                thumb.style.opacity = '1';
                if(arrow) {
                    setTimeout(() => {
                        const arrowOffset = thumb.parentElement.offsetLeft + (thumb.parentElement.offsetWidth / 2) - (arrow.offsetWidth / 2);
                        arrow.style.left = `${arrowOffset}px`;
                        arrow.style.display = 'block';
                    }, 50);
                }
            } else {
                thumb.style.opacity = '0.6';
            }
        });
        // 4. ì„±ì¥ë¥  í¼ì„¼íŠ¸ ì—…ë°ì´íŠ¸
        const growthPercentage = Math.floor((totalStamps / 12) * 100);
        const circleBar = document.getElementById('growth_chart_circle');
        const circleText = document.getElementById('growth_percent_text');
        if (circleBar && circleText) {
            const radius = circleBar.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (growthPercentage / 100) * circumference;
            circleBar.style.strokeDashoffset = offset;
            circleText.textContent = `${growthPercentage}%`;
        }

        // 5. ë¦¬ì›Œë“œ ìŠ¤íƒ¬í”„ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
        const stampsGrid = document.getElementById('stamps-grid-container');
        if (stampsGrid) {
            stampsGrid.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const img = document.createElement('img');
                
                // [ì˜¤ë¥˜ ìˆ˜ì •] ë‹¨ìˆ˜í˜• ë³€ìˆ˜(stampOnImage) ëŒ€ì‹  ë³µìˆ˜í˜• ë°°ì—´(stampOnImages)ì—ì„œ ë¬´ì‘ìœ„ë¡œ ì„ íƒí•˜ëŠ” ë¡œì§ìœ¼ë¡œ ìˆ˜ì •
                if (i < totalStamps) {
                    const randomIndex = Math.floor(Math.random() * stampOnImages.length);
                    img.src = stampOnImages[randomIndex];
                } else {
                    const randomIndex = Math.floor(Math.random() * stampOffImages.length);
                    img.src = stampOffImages[randomIndex];
                }

                img.style.width = '100%';
                img.style.objectFit = 'contain';
                stampsGrid.appendChild(img);
            }
        }
    }
    fetchRewardStatus();
    
    const reviewModal = document.getElementById('review-modal');
    const reviewModalContent = document.getElementById('review-modal-content');

    document.body.addEventListener('click', async function(event) {
        const target = event.target;

        // 'í”½ì—… ì™„ë£Œ' ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        if (target.classList.contains('pickup-complete-btn')) {
            const reservationId = target.dataset.pk;
            if (!confirm('í”½ì—…ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const url = `/reservations/${reservationId}/change-status/`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert(data.message || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
                }
            } catch(error) {
                alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // 'ë¦¬ë·°ì“°ê¸°' ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        if (target.classList.contains('write-review-btn')) {
            const reservationId = target.dataset.pk;
            const storeName = target.dataset.storeName;
            openReviewModal(reservationId, storeName);
        }
        
        // 'ë¦¬ë·° ì‚­ì œ' ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        if (target.classList.contains('delete-review-btn')) {
            const reviewId = target.dataset.reviewId;
            if (confirm('ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                handleReviewDelete(reviewId);
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ë˜ëŠ” ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì²˜ë¦¬
        if (target.classList.contains('close-modal') || target === reviewModal) {
            closeReviewModal();
        }
    });

    // --- ë¦¬ë·° ì‚­ì œë¥¼ ì„œë²„ì— ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ ---
    async function handleReviewDelete(reviewId) {
        const url = `/reviews/${reviewId}/delete/`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById(`review-card-${reviewId}`).remove();
                alert(data.message);
            } else {
                alert('ì˜¤ë¥˜: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ë¦¬ë·° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // --- ë¦¬ë·° ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
    async function openReviewModal(reservationId, storeName) {
        try {
            const response = await fetch(`/reviews/create/${reservationId}/`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ë¦¬ë·° í¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            const formHtml = await response.text();
            
            if (reviewModalContent) {
                 reviewModalContent.innerHTML = `
                    <span class="close-modal" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
                    ${formHtml}
                `;
            }
            if (reviewModal) reviewModal.style.display = 'flex';
        } catch (error) {
            console.error('Error opening review modal:', error);
            alert(error.message);
        }
    }

    function closeReviewModal() {
        if (reviewModal) reviewModal.style.display = 'none';
    }

    // --- ë¦¬ë·° í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ---
    if (reviewModal) {
        reviewModal.addEventListener('submit', async function(event) {
            if (event.target.tagName === 'FORM') {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken }
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message);
                        window.location.reload();
                    } else {
                        throw new Error(result.message || 'ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    alert(`ì˜¤ë¥˜: ${error.message}`);
                }
            }
        });
    }
});
</script>
{% endblock script %} 

{% block body %}
<div class="big_hugger">
    <div class="top-section">
        <div class="profile-section">
            <div class="logo">
                <img src="{% static 'img/background.png' %}" alt="" />
                <img src="{% static 'img/background2.png' %}" alt="" />
            </div>
            <div class="welcome-box">
                <a href="{% url 'users:logout' %}" class="logoutbtn">
                    <img src="{% static 'img/logout_btn.png' %}" alt="ë¡œê·¸ì•„ì›ƒ" />
                </a>
                <div class="backgroundimg">
                    <img src="{% static 'img/Rounded rectangle.svg' %}" alt="" />
                </div>
                <div class="profile-info">
                    <div class="profile-text">
                        <div class="textbox">
                            <span class="nickname-highlight">
                                <span class="nickname">{{ request.user.username }}</span>
                            </span>
                            <span class="welcome-text">ë‹˜ ë°˜ê°€ì›Œìš”!</span>
                            <img src="{% static 'img/emo1.png' %}" alt="" />
                        </div>

                        <div class="textbox1">
                            <div class="firstmsg">
                                ì˜¤ëŠ˜ ë­ ë¨¹ì„ê¹Œ?
                                <img src="{% static 'img/emo2.png' %}" alt="" class="pic" />
                            </div>
                            <div class="desc-text">
                                ê·¼ì²˜ <span class="green_small">ë…¸ì </span>ì—ì„œ
                                <span class="green_small">ì‹ ì„ í•˜ê²Œ</span> ì¥ë´ë´ìš”!
                            </div>
                            <div class="lastmsg">
                                <span class="desc-text">ì§€ê¸ˆ ë‚´ ê·¼ì²˜, ì¥ë³´ëŠ” ê°€ì¥ ë”°ëœ»í•œ ë°©ë²• "</span>
                                <span class="farmfarm">íŒœíŒœ</span>"
                                <img src="{% static 'img/emo3.png' %}" alt="" class="pic" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="profile-box">
                    <img src="{% static 'img/Union.png' %}" alt="" class="profile_hugger" />
                    <div class="profile-edit">
                        <img id="profileImage" src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}/static/img/default_profile.png{% endif %}" alt="í”„ë¡œí•„" />
                    </div>
                    <div class="level-box">
                        <p class="nickname" id="buyer-home-nic">
                            {{ request.user.username }}
                            <img id="editProfileBtn" src="{% static 'img/edit.png' %}" alt="ìˆ˜ì •" style="cursor: pointer" />
                        </p>
                        <p class="level">
                            LV. <span id="character-level-text">1</span>
                            <img src="{% static 'img/level.png' %}" alt="" class="medal"/>

                        </p>
                    </div>
                </div>
            </div>
<div class="modal-overlay" id="profileEditModal" style="display: none;">
    <div class="modal-content">
        <form id="profileEditForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-actions">
                <button type="button" id="closeModalBtn">Ã—</button>
            </div>
            <div class="nickname-row" id="buyer-home-nic">
                <input type="text" id="nicknameInput" value="{{ request.user.username }}" name="username">
                <button type="button" name="edit_type" value="name" style="background: none; border: none; cursor: pointer;">
                    <img class="nickname-edit-btn" src="{% static 'img/edit.png' %}" alt="ë‹‰ë„¤ì„ ìˆ˜ì •">
                </button>
            </div>
            <div class="image-row">
                <div class="image-preview">
                    <input type="file" name="profile_image" id="profileImageInput" style="display:none;">
                    <img src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}/static/img/default_profile.png{% endif %}" alt="í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°" class="preview_img">
                    <img class="image-edit-btn" src="{% static 'img/edit.png' %}" alt="ì´ë¯¸ì§€ ìˆ˜ì •" style="cursor: pointer;">
                </div>
            </div>
        </form>
    </div>
</div>

        </div>
        <div class="line"></div>
    </div>

    <div class="bottom-section">
        
        <div class="cha_section">
            <div class="character">ë§ˆì´ ìºë¦­í„° ğŸ§¸</div>
        </div>
        <div class="information_zone">
            <div class="information-card">
                <div class="info-wrapper">
                    <div class="information_cha">
                        <div class="thumbnail-row">
                            <img id="level-arrow" src="{% static 'img/arrow.png' %}" alt="current level">
                             
                            <div class="thumbnail-wrapper">
                                <img id="level-thumb-1" class="level-thumbnail" src="{% static 'img/level1.png' %}" alt="Lv.1">
                            </div>

                            <div class="thumbnail-wrapper">
                                <img id="level-thumb-2" class="level-thumbnail" src="{% static 'img/level2.png' %}" alt="Lv.2">
                            </div>

                            <div class="thumbnail-wrapper">
                                <img id="level-thumb-3" class="level-thumbnail" src="{% static 'img/level3.png' %}" alt="Lv.3">
                            </div>
                        </div>
                        <div class="main-image-container">
                            <img id="character-main-image" class="main-character" src="{% static 'img/level1.png' %}" alt="ë©”ì¸ ìºë¦­í„°">
                        </div>
                    </div>
                    <div class="information_detail">
                        <div class="cha_name" id="character-name">ì´ë¦„:</div>
                        <div class="cha_nic"  id="character-nic">{{ reward.character_name }}</div>
                        <div class="cha_growth">ì„±ì¥í¼ì„¼íŠ¸:</div>
                        <div class="growth_chart">
                            <svg width="80" height="80" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#5a6051" stroke-width="8"></circle>
                                <circle id="growth_chart_circle" cx="50" cy="50" r="45" fill="none" stroke="#C1FF52" stroke-width="8" stroke-linecap="round" style="stroke-dasharray: 283; stroke-dashoffset: 283;"></circle>
                            </svg>
                            <div id="growth_percent_text" class="growth_percent">0%</div>
                        </div>
                    </div>
                </div>
                <div class="more">
                    <a href="{% url 'rewards:reward_page' %}">
                        <img src="{% static 'img/more.png' %}" alt="ë§ˆì´ìºë¦­í„° ë”ë³´ê¸°" class="cha_more">
                    
                        <img class="rew_gra" src="{% static 'img/cha_gra.png' %}" alt="ì¥ì‹">
                    </a>     
                </div>
                <!-- ë§í’ì„  ëª¨ë‹¬ -->
                <div class="speech-bubble-modal" aria-hidden="true">
                    <div class="speech-bubble">
                        <span class="line1">ê°€ê²Œë“±ë¡ ë˜ëŠ” ë¦¬ë·°ë¥¼ ì“°ë©´</span><br />
                        <span class="line2">ë¦¬ì›Œë“œ</span><span class="line1">ê°€ ì£¼ì–´ì§€ê³ <br />ë¸Œë¡œì½œë¦¬ê°€</span> <span class="line2">ìë¼ìš”!</span></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="rew_section">
            <div class="character">ë¦¬ì›Œë“œ í˜„í™© ğŸ§©</div>
        </div>
        <div class="information2-card">
            <div class="rew_total" id="stamps-grid-container" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 100%; align-content: center; padding: 20px;">
                </div>
            <div class="more">
                <img class="rew_gra" src="{% static 'img/rew_gra.png' %}" alt="ì¥ì‹">
            </div>
        </div>

        <div class="res_section">
            <div class="reservation">ì§„í–‰ì¤‘ì¸ ì˜ˆì•½<img src="{% static 'img/res_icon.png' %}" alt="ì˜ˆì•½ í˜„í™© ì•„ì´ì½˜" class="res_check"></div>
        </div>
        <div class="information_zone">
            <div class="res_res">
                <div class="information3-card">
                    <div class="more">
                        <a href="{% url 'reservations:list' %}"><img src="{% static 'img/res_more.png' %}" alt="ì˜ˆì•½ í˜„í™© ë”ë³´ê¸°" class="res_more"></a>
                    </div>
                    {% for r in active_reservations|dictsortreversed:"created_at"|slice:":3" %}
                    <div class="{% if forloop.counter == 1 %}res_detial{% elif forloop.counter == 2 %}second_detail{% else %}back_detail{% endif %}">
                        {% for item in r.items.all %}
                        <div class="{% if forloop.parentloop.counter == 1 %}detail_img{% else %}details_img{% endif %}">
                            {% if item.image %}
                            <img src="{{ item.image.url }}" alt="{{ item.item_name }}" class="tomato">
                            {% else %}
                            <img src="https://placehold.co/300x150/2a2a2a/cccccc?text={{ item.item_name|default:'ìƒí’ˆ' }}" alt="{{ item.item_name }}" class="tomato">
                            {% endif %}
                        </div>
                        <div class="{% if forloop.parentloop.counter == 1 %}detail_txt{% else %}details_txt{% endif %}">
                            <span>
                                íŒë§¤ì: {{ r.store.name }} <br>
                                ìœ„ì¹˜: {{ r.store.address }} <br>
                                íŒë§¤ ì‹œê°„: {{ r.store.sale_hours }} <br>
                                ê°€ê²©:(ì´ {{ item.quantity }}ê°œ) {{ r.total_price }}ì› <br>
                                ìƒíƒœ: {{ r.get_status_display }} <br>
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% empty %}
                    <p style="color:white;">ì˜ˆì•½ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="buy_section">
            <div class="character1">êµ¬ë§¤ ë‚´ì—­<img src="{% static 'img/buy_icon.png' %}" alt="êµ¬ë§¤ ë‚´ì—­ ì•„ì´ì½˜" class="buy_icon"></div>
            <div class="information_zone">
                <div class="res_res">
                    <section class="information4-card">
                        <div class="history_container">
                            {% for r in past_reservations|slice:":3" %}
                            <article class="history_card card--{{ forloop.counter }} {% if forloop.first %}active{% endif %}">
                                <div class="card_img">
                                    {% with item=r.items.first %}
                                    {% if item.image %}
                                    <img src="{{ item.image.url }}" alt="{{ item.item_name }}">
                                    {% else %}
                                    <img src="https://placehold.co/120x80/2a2a2a/cccccc?text={{ item.item_name|default:'ìƒí’ˆ' }}" alt="{{ item.item_name }}">
                                    {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="panel">
                                    <span class="date">{{ r.created_at|date:"Y.m.d" }}</span>
                                    <h3>[{{ r.store.name }} | {{ r.store.seller.user.username }}]</h3>
                                    <ul>
                                        <li>í’ˆëª©: {% for item in r.items.all %}{{ item.item_name }}{% if not forloop.last %}, {% endif %}{% endfor %}</li>
                                        <li>ìœ„ì¹˜: {{ r.store.address }}</li>
                                        <li>íŒë§¤ ì‹œê°„: {{ r.store.sale_hours }}</li>
                                        <li>ê°€ê²©: {{ r.total_price }}ì›</li>
                                    </ul>
                                </div>
                            </article>
                            {% empty %}
                            <p style="text-align:center; color: #aaa;">ì§€ë‚œ êµ¬ë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            {% endfor %}
                            <div class="card_reflection" aria-hidden="true"></div>
                        </div>
                        <div class="more">
                            <a href="{% url 'reservations:purchase-list' %}">
                                <img src="{% static 'img/res_more.png' %}" alt="êµ¬ë§¤ ë‚´ì—­ ë”ë³´ê¸°" class="res_more">
                                <img src="{% static 'img/rew_gra.png' %}" alt="ë¦¬ì›Œë“œ í˜„í™© ì•„ì´ì½˜" class="rew_gra">
                            </a>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div class="rev_section">
            <div class="character1">ë‚´ê°€ ì“´ ë¦¬ë·°<img src="{% static 'img/rev_icon.png' %}" alt="ë¦¬ë·° ì•„ì´ì½˜" class="rev_icon"></div>
            <div class="review_hugger">
                <img src="{% static 'img/review_deco.png' %}" alt="ë¦¬ë·°ë°ì½”" class="review_deco">
                {% for review in reviews|slice:":6" %}
                <div class="per_review" id="review-card-{{ review.id }}">
                    <div class="reviewer_profile">
                        <img src="{% if review.photo %}{{ review.photo.url }}{% else %}/static/img/smiling_brocoli.png{% endif %}" alt="ë‚´ í”„ë¡œí•„" class="r_profile_p">
                    </div>
                    <div class="stars">
                        {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}
                        <img src="{% static 'img/starscore_filled.png' %}" alt="ë³„ì " class="per_star">
                        {% else %}
                        <img src="{% static 'img/starscore.png' %}" alt="ë¹ˆ ë³„" class="per_star">
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div class="r_store_info">
                        <p><strong>[{{ review.store.name }}]</strong></p>
                        <ul class="r_store_info_small">
                            <li>ìœ„ì¹˜: {{ review.store.address }}</li>
                            <li>íŒë§¤ ì‹œê°„: {{ review.store.sale_hours }}</li>
                        </ul>
                    </div>
                    <div class="review_content">
                        {{ review.content|truncatechars:15 }}
                        <div class="keywords">
                        {% for keyword in review.get_keywords_as_list %}
                        <span>#{{ keyword }}</span>
                    {% endfor %}
                    </div>
                    </div>
                    <div class="date">{{ review.created_at|date:"Y.m.d" }}</div>
                </div>
                {% empty %}
                <p style="text-align:center; color:#999;">ì‘ì„±í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="review-modal" class="modal">
    <div class="modal-content-review">
        <div id="review-modal-content">
            </div>
    </div>
</div>

<div class="nav_box">
    {% if user.usertype == 'BUYER' %}
    <nav class="bottom_nav">
        <img src="{% static 'img/now_page.png' %}" alt="í˜„ì¬ í˜ì´ì§€" class="now_page">
        <div class="btn"><a href="{% url 'stores:map' %}"><img src="{% static 'img/map_page_gray.png' %}" alt="ì§€ë„í˜ì´ì§€" class="map_page"></a></div>
        <div class="btn selected_nav"><a href="{% url 'users:buyer_home' %}"><img src="{% static 'img/home_page_black.png' %}" alt="í™ˆí˜ì´ì§€" class="home_page"></a></div>
        <div class="btn"><a href="{% url 'shopping:ai_shopping' %}"><span class="shopping_page">AI</span></a></div>
    </nav>
    {% elif user.usertype == 'SELLER' %}
    <nav class="bottom_nav">
        <img src="{% static 'img/now_page.png' %}" alt="í˜„ì¬ í˜ì´ì§€" class="now_page">
        <div class="btn"><a href="{% url 'stores:map' %}"><img src="{% static 'img/map_page_gray.png' %}" alt="ì§€ë„í˜ì´ì§€" class="map_page"></a></div>
        <div class="btn selected_nav"><a href="{% url 'users:seller_home' %}"><img src="{% static 'img/home_page_black.png' %}" alt="í™ˆí˜ì´ì§€" class="home_page"></a></div>
        <div class="btn"><a href="{% url 'reservations:seller_list' %}"><span class="shopping_page">ì˜ˆì•½</span></a></div>
    </nav>
    {% endif %}
</div>
{% endblock body %}