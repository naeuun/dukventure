{% extends "users/base_home.html" %}
{% block role_content %}
<hr>
<div class="home-container">

    <div class="my-section">
        <h3>ë§ˆì´ ìºë¦­í„° ğŸ§¸</h3>
        <!-- ìºë¦­í„° ì •ë³´ ë“¤ì–´ê°ˆ ìë¦¬ -->
         <div class="character-display">
            <img id="character-image" src="https://placehold.co/120x120/3e3e3e/e0e0e0?text=Lv.1" alt="ìºë¦­í„°" width="120" height="120">
        </div>
         <div class="growth-progress">
            <div id="growth-progress-bar" class="progress-bar-inner"></div>
        </div>
        <p id="growth-progress-text" style="text-align:center; margin-top:5px; font-weight:bold;">ì„±ì¥ë¥ : 0%</p>
    </div>

    <div class="reward-section">
        <h3>ë¦¬ì›Œë“œ í˜„í™© ğŸ§©</h3>
        <!-- ë¦¬ì›Œë“œ ì •ë³´ ë“¤ì–´ê°ˆ ìë¦¬ -->
         <div class="reward-status">
            <div class="medals">
                <div id="medal-gold">Gold Medal</div>
                <div id="medal-silver">Silver Medal</div>
                <div id="medal-bronze">Bronze Medal</div>
            </div>
            <div class="stamps">
                <!-- JSê°€ ìŠ¤íƒ¬í”„ ê°œìˆ˜ë¥¼ ì±„ì›ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <div class="reservation-section">
        <div class="section-header">
            <h3>ì˜ˆì•½ í˜„í™© ğŸ‘›</h3>
            <a href="{% url 'reservations:list' %}" class="btn">ì˜ˆì•½ ìƒì„¸ í™”ë©´</a>
        </div>
        <div class="reservation-list">
            <p>- ìµœê·¼ ì˜ˆì•½ (ìµœëŒ€ 3ê°œ)</p>
            <div id="active-reservations-list">
                {% for r in active_reservations|slice:":3" %}
                    <div class="res-card" id="res-card-{{ r.pk }}">
                        {% for item in r.items.all %}
                            <div class="res-card-image">
                                {% if item.image %}
                                    <img width="300px" height="150px" src="{{ item.image.url }}" alt="{{ item.item_name }}">
                                {% else %}
                                    <img width="300px" height="150px" src="https://placehold.co/300x150/2a2a2a/cccccc?text={{ item.item_name|default:'ìƒí’ˆ' }}" alt="{{ item.item_name }}">
                                {% endif %}
                            </div>
                            <div class="res-card-info">
                                <p><strong>íŒë§¤ì:</strong> {{ r.store.name }}</p>
                                <p><strong>ìœ„ì¹˜:</strong> {{ r.store.address }}</p>
                                <p><strong>íŒë§¤ ì‹œê°„:</strong> {{ r.store.sale_hours }}</p>
                                <p><strong>ê°€ê²©:</strong> (ì´ {{ item.quantity }}ê°œ) {{ r.total_price }}ì›</p>
                                <p><strong>ìƒíƒœ:</strong> <span class="status-text">{{ r.get_status_display }}</span></p>
                            </div>
                        {% endfor %}
                        <!-- ì˜ˆì•½ ì¹´ë“œ ë‚´ ë²„íŠ¼/ìƒíƒœ ì˜ì—­ -->
                        <div class="res-card-actions">
                            {% if r.status == 'PENDING' %}
                                <span class="btn btn-dark">ìˆ˜ë½ ëŒ€ê¸°ì¤‘</span>
                            {% elif r.status == 'ACCEPTED' %}
                                {% if r.remaining_minutes > 0 %}
                                    <span class="btn btn-dark time-info">{{ r.remaining_minutes|floatformat:"0" }}ë¶„ í›„ í”½ì—… ê°€ëŠ¥</span>
                                {% else %}
                                    <button type="button" class="btn btn-success pickup-complete-btn" data-pk="{{ r.pk }}">í”½ì—… ì™„ë£Œ</button>
                                {% endif %}
                            {% elif r.status == 'PICKED_UP' %}
                                <span style="color: green; font-weight: bold;">í”½ì—… ì™„ë£Œ</span>
                                {% if not r.review %}
                                    <button type="button" class="btn btn-light write-review-btn" data-pk="{{ r.pk }}" data-store-name="{{ r.store.name }}">ë¦¬ë·°ì“°ê¸°</button>
                                {% endif %}
                            {% else %}
                                <span class="btn btn-dark time-info">
                                {% if r.remaining_minutes > 0 %}
                                    {{ r.remaining_minutes|floatformat:"0" }}ë¶„ í›„ í”½ì—… ê°€ëŠ¥
                                {% else %}
                                    í”½ì—… ì‹œê°„ì…ë‹ˆë‹¤
                                {% endif %}
                                </span>
                                <button type="button" class="btn btn-light pickup-before-btn" data-pk="{{ r.pk }}" data-store-name="{{ r.store.name }}">í”½ì—… ì „</button>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <p id="no-active-reservations" style="text-align:center; color: #aaa;">ì§„í–‰ ì¤‘ì¸ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="purchase-section">
        <div class="section-header">
            <h3>êµ¬ë§¤ ë‚´ì—­ ğŸ‡</h3>
            <a href="{% url 'reservations:purchase-list' %}" class="btn btn-light">êµ¬ë§¤ ë‚´ì—­ ì „ì²´ ë³´ê¸°</a>
        </div>
        <div id="past-reservations-list">
            {% for r in past_reservations|slice:":3" %}
                <hr>
                <div class="res-card">
                    <div class="res-card-image">
                        {% with item=r.items.first %}
                            {% if item.image %}
                                <img width="120px" src="{{ item.image.url }}" alt="{{ item.item_name }}">
                            {% else %}
                                <img width="120px" src="https://placehold.co/120x80/2a2a2a/cccccc?text={{ item.item_name|default:'ìƒí’ˆ' }}" alt="{{ item.item_name }}">
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="res-card-info">
                        <p><strong>{{ r.store.name }}</strong> - <strong>{{ r.store.seller.user.username }}</strong></p>
                        <p><strong>í’ˆëª©:</strong>
                            {% for item in r.items.all %}
                                {{ item.item_name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <p><strong>ìœ„ì¹˜:</strong> {{ r.store.address }}</p>
                        <p><strong>íŒë§¤ ì‹œê°„:</strong> {{ r.store.sale_hours }}</p>
                        <p><strong>ê°€ê²©:</strong> {{ r.total_price }}ì›</p>
                        <p><strong>êµ¬ë§¤ì¼:</strong> {{ r.created_at|date:"Y.m.d" }}</p>
                    </div>
                </div>
            {% empty %}
                <p id="no-past-reservations" style="text-align:center; color: #aaa;">ì§€ë‚œ ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}
        </div>
    </div>

    <div class="review-section">
        <div class="section-header">
            <h3>ë‚´ê°€ ì“´ ë¦¬ë·° ğŸ€</h3>
        </div>
        <div class="review-list">
            {% for review in reviews %}
            <hr>
                <div class="res-card">
                    <div style="display: flex; gap: 18px;">
                        <!-- ë‚´ í”„ë¡œí•„ ì‚¬ì§„ -->
                        <div>
                            <img width="48" height="48" style="border-radius:50%; object-fit:cover; border:1px solid #eee;"
                                 src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}/static/img/default_profile.png{% endif %}"
                                 alt="ë‚´ í”„ë¡œí•„">
                            <p style="margin:0; font-size:0.95em; color:#888;">{{ request.user.username }}</p>
                        </div>
                        <!-- ê°€ê²Œ ì •ë³´ -->
                        <div>
                            <p><strong>ê°€ê²Œëª…:</strong> {{ review.store.name }}</p>
                            <p><strong>í’ˆëª©:</strong>
                                {% for item in review.reservation.items.all %}
                                    {{ item.item_name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            <p><strong>ìœ„ì¹˜:</strong> {{ review.store.address }}</p>
                            <p><strong>íŒë§¤ ì‹œê°„:</strong> {{ review.store.sale_hours }}</p>
                            <p><strong>ê°€ê²©:</strong> {{ review.reservation.total_price }}ì›</p>
                        </div>
                    </div>
                    <div class="res-card-info" style="margin-top:10px;">
                        <!-- ë³„ì  -->
                        <p>
                            <span class="review-stars">
                                {% for i in "12345" %}
                                    {% if i|add:0 <= review.rating %}â˜…{% else %}â˜†{% endif %}
                                {% endfor %}
                            </span>
                        </p>
                        <!-- í‚¤ì›Œë“œë“¤ (ì˜ˆ: review.keywordsê°€ ë¦¬ìŠ¤íŠ¸ë¼ë©´) -->
                        {% if review.keywords %}
                            <p>
                                <strong>í‚¤ì›Œë“œ:</strong>
                                {% for kw in review.keywords %}
                                    <span class="badge badge-info">{{ kw }}</span>
                                {% endfor %}
                            </p>
                        {% endif %}
                        <p>{{ review.content|truncatewords:20 }}</p>
                        <p style="font-size: 0.8em; color: #aaa;">{{ review.created_at|date:"Y.m.d" }}</p>
                    </div>
                </div>
            {% empty %}
                <p style="text-align:center; color: #aaa;">ì‘ì„±í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endfor %}
        </div>
    </div>

</div>

<!-- ë¦¬ë·° í¼ì„ ë‹´ì„ ëª¨ë‹¬ (íŒì—…ì°½) -->
<div id="review-modal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);">
  <div class="modal-content" style="background-color:#fff; color: #000; margin:10% auto; padding:20px; border:1px solid #888; width:80%; max-width:500px; border-radius:10px; position:relative;">
    <span class="close-modal" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
    <div id="review-modal-content">
      <!-- ë¦¬ë·° í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- 1. ë¦¬ì›Œë“œ ì •ë³´ ë¡œë”© ë° UI ì—…ë°ì´íŠ¸ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    const characterImages = {
        1: 'https://placehold.co/120x120/4caf50/ffffff?text=Lv.1',
        2: 'https://placehold.co/120x120/ff9800/ffffff?text=Lv.2',
        3: 'https://placehold.co/120x120/f44336/ffffff?text=Lv.3',
    };

    async function fetchRewardStatus() {
        try {
            const response = await fetch('/rewards/status/');
            if (!response.ok) throw new Error('ë¦¬ì›Œë“œ ì •ë³´ ë¡œë”© ì‹¤íŒ¨');
            const data = await response.json();
            updateRewardUI(data);
        } catch (error) {
            console.error('ë¦¬ì›Œë“œ ì •ë³´ ë¡œë”© ì˜¤ë¥˜:', error);
        }
    }

function updateRewardUI(data) {
        // ìºë¦­í„° ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
        const characterImage = document.getElementById('character-image');
        if (characterImage) characterImage.src = characterImages[data.character_level] || characterImages[1];

        // [ìˆ˜ì •ëœ ë¶€ë¶„] ë©”ë‹¬ ë“±ê¸‰ì— ë”°ë¥¸ ì„±ì¥ë¥  í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
        const medalToPercentage = {
            'NONE': 25,
            'BRONZE': 50,
            'SILVER': 75,
            'GOLD': 100
        };
        const growthPercentage = medalToPercentage[data.medal_tier] || 25; // ê¸°ë³¸ê°’ 25%

        const progressBar = document.getElementById('growth-progress-bar');
        const progressText = document.getElementById('growth-progress-text');

        if (progressBar && progressText) {
            progressBar.style.width = growthPercentage + '%';
            progressText.textContent = `ì„±ì¥ë¥ : ${growthPercentage}%`;
        }

        // ë©”ë‹¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        const goldMedal = document.getElementById('medal-gold');
        const silverMedal = document.getElementById('medal-silver');
        const bronzeMedal = document.getElementById('medal-bronze');
        if (goldMedal) {
            goldMedal.textContent = 'ê¸ˆë©”ë‹¬'; silverMedal.textContent = 'ì€ë©”ë‹¬'; bronzeMedal.textContent = 'ë™ë©”ë‹¬';
            goldMedal.style.fontWeight = 'normal'; silverMedal.style.fontWeight = 'normal'; bronzeMedal.style.fontWeight = 'normal';
            if (data.medal_tier === 'GOLD') goldMedal.style.fontWeight = 'bold';
            if (data.medal_tier === 'SILVER') silverMedal.style.fontWeight = 'bold';
            if (data.medal_tier === 'BRONZE') bronzeMedal.style.fontWeight = 'bold';
        }

        // ìŠ¤íƒ¬í”„ ìƒíƒœ ì—…ë°ì´íŠ¸
        const stampsContainer = document.querySelector('.stamps');
        if (stampsContainer) {
            let stampsHTML = 'ìŠ¤íƒ¬í”„: ';
            for (let i = 0; i < 4; i++) {
                stampsHTML += (i < data.stamp_count) ? 'â—' : 'â—‹';
            }
            stampsContainer.textContent = stampsHTML;
        }
    }
    fetchRewardStatus(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰

    // --- 2. ëª¨ë“  í´ë¦­ ì´ë²¤íŠ¸ë¥¼ í•œ ê³³ì—ì„œ ì²˜ë¦¬ ---
    const modal = document.getElementById('review-modal');
    const modalContent = document.getElementById('review-modal-content');
    const closeModalBtn = document.querySelector('.close-modal');

    document.body.addEventListener('click', async function(e) {
        // 'í”½ì—… ì™„ë£Œ' ë²„íŠ¼ í´ë¦­
        if (e.target.classList.contains('pickup-complete-btn')) {
            const reservationId = e.target.dataset.pk;
            if (!confirm('í”½ì—…ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const response = await fetch(`/reservations/${reservationId}/pickup/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert(data.message || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
            }
        }

        // 'ë¦¬ë·°ì“°ê¸°' ë²„íŠ¼ í´ë¦­
        if (e.target.classList.contains('write-review-btn')) {
            const reservationId = e.target.dataset.pk;
            // ì„œë²„ì—ì„œ ë¦¬ë·° í¼ HTMLì„ ê°€ì ¸ì˜´
            const response = await fetch(`/reviews/create/${reservationId}/`);
            const formHtml = await response.text();
            modalContent.innerHTML = formHtml;
            modal.style.display = 'block';
        }

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        if (e.target === closeModalBtn || e.target === modal) {
            modal.style.display = 'none';
        }
    });

    // --- 3. ë¦¬ë·° í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ---
    modal.addEventListener('submit', async function(e) {
        // ë¦¬ë·° í¼ì´ ì œì¶œë˜ì—ˆì„ ë•Œë§Œ ì‘ë™
        if (e.target.tagName === 'FORM') {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value }
            });
            
            const data = await response.json();

            if (data.status === 'success') {
                alert(data.message);
                // [í•µì‹¬!] ë¦¬ë·° ì‘ì„±ì´ ì„±ê³µí•˜ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
                window.location.reload();
            } else {
                alert(data.message || 'ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
    });
});
</script>
{% endblock %}