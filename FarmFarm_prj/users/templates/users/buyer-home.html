{% extends "users/base_home.html" %}
{% block role_content %}
<hr>
<div class="home-container">

    <div class="my-section">
        <h3>마이 캐릭터 🧸</h3>
        <!-- 캐릭터 정보 들어갈 자리 -->
    </div>

    <div class="reward-section">
        <h3>리워드 현황 🧩</h3>
        <!-- 리워드 정보 들어갈 자리 -->
    </div>

    <div class="reservation-section">
        <div class="section-header">
            <h3>예약 현황 👛</h3>
            <a href="{% url 'reservations:list' %}" class="btn">예약 상세 화면</a>
        </div>
        <div class="reservation-list">
            <p>- 최근 예약 (최대 3개)</p>
            <div id="active-reservations-list">
                {% for r in active_reservations|slice:":3" %}
                    <div class="res-card" id="res-card-{{ r.pk }}">
                        {% for item in r.items.all %}
                            <div class="res-card-image">
                                {% if item.image %}
                                    <img width="300px" src="{{ item.image.url }}" alt="{{ item.item_name }}">
                                {% else %}
                                    <img width="300px" src="https://placehold.co/300x150/2a2a2a/cccccc?text={{ item.item_name|default:'상품' }}" alt="{{ item.item_name }}">
                                {% endif %}
                            </div>
                            <div class="res-card-info">
                                <p><strong>판매자:</strong> {{ r.store.name }}</p>
                                <p><strong>위치:</strong> {{ r.store.address }}</p>
                                <p><strong>판매 시간:</strong> {{ r.store.sale_hours }}</p>
                                <p><strong>가격:</strong> (총 {{ item.quantity }}개) {{ r.total_price }}원</p>
                                <p><strong>상태:</strong> <span class="status-text">{{ r.get_status_display }}</span></p>
                            </div>
                        {% endfor %}
                        <!-- 예약 카드 내 버튼/상태 영역 -->
                        <div class="res-card-actions">
                            {% if r.status == 'PENDING' %}
                                <span class="btn btn-dark">수락 대기중</span>
                            {% elif r.status == 'ACCEPTED' %}
                                {% if r.remaining_minutes > 0 %}
                                    <span class="btn btn-dark time-info">{{ r.remaining_minutes|floatformat:"0" }}분 후 픽업 가능</span>
                                {% else %}
                                    <button type="button" class="btn btn-success pickup-complete-btn" data-pk="{{ r.pk }}">픽업 완료</button>
                                {% endif %}
                            {% elif r.status == 'PICKED_UP' %}
                                <span style="color: green; font-weight: bold;">픽업 완료</span>
                                {% if not r.review %}
                                    <button type="button" class="btn btn-light write-review-btn" data-pk="{{ r.pk }}" data-store-name="{{ r.store.name }}">리뷰쓰기</button>
                                {% endif %}
                            {% else %}
                                <span class="btn btn-dark time-info">
                                {% if r.remaining_minutes > 0 %}
                                    {{ r.remaining_minutes|floatformat:"0" }}분 후 픽업 가능
                                {% else %}
                                    픽업 시간입니다
                                {% endif %}
                                </span>
                                <button type="button" class="btn btn-light pickup-before-btn" data-pk="{{ r.pk }}" data-store-name="{{ r.store.name }}">픽업 전</button>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <p id="no-active-reservations" style="text-align:center; color: #aaa;">진행 중인 예약이 없습니다.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="purchase-section">
        <div class="section-header">
            <h3>구매 내역 🎇</h3>
            <a href="{% url 'reservations:purchase-list' %}" class="btn btn-light">구매 내역 전체 보기</a>
        </div>
        <div id="past-reservations-list">
            {% for r in past_reservations|slice:":3" %}
                <hr>
                <div class="res-card">
                    <div class="res-card-image">
                        {% with item=r.items.first %}
                            {% if item.image %}
                                <img width="120px" src="{{ item.image.url }}" alt="{{ item.item_name }}">
                            {% else %}
                                <img width="120px" src="https://placehold.co/120x80/2a2a2a/cccccc?text={{ item.item_name|default:'상품' }}" alt="{{ item.item_name }}">
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="res-card-info">
                        <p><strong>{{ r.store.name }}</strong> - <strong>{{ r.store.seller.user.username }}</strong></p>
                        <p><strong>품목:</strong>
                            {% for item in r.items.all %}
                                {{ item.item_name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <p><strong>위치:</strong> {{ r.store.address }}</p>
                        <p><strong>판매 시간:</strong> {{ r.store.sale_hours }}</p>
                        <p><strong>가격:</strong> {{ r.total_price }}원</p>
                        <p><strong>구매일:</strong> {{ r.created_at|date:"Y.m.d" }}</p>
                    </div>
                </div>
            {% empty %}
                <p id="no-past-reservations" style="text-align:center; color: #aaa;">지난 예약 내역이 없습니다.</p>
            {% endfor %}
        </div>
    </div>

    <div class="review-section">
        <div class="section-header">
            <h3>내가 쓴 리뷰 🎀</h3>
        </div>
        <div class="review-list">
            {% for review in reviews %}
            <hr>
                <div class="res-card">
                    <div style="display: flex; gap: 18px;">
                        <!-- 내 프로필 사진 -->
                        <div>
                            <img width="48" height="48" style="border-radius:50%; object-fit:cover; border:1px solid #eee;"
                                 src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}/static/img/default_profile.png{% endif %}"
                                 alt="내 프로필">
                            <p style="margin:0; font-size:0.95em; color:#888;">{{ request.user.username }}</p>
                        </div>
                        <!-- 가게 정보 -->
                        <div>
                            <p><strong>가게명:</strong> {{ review.store.name }}</p>
                            <p><strong>품목:</strong>
                                {% for item in review.reservation.items.all %}
                                    {{ item.item_name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                            <p><strong>위치:</strong> {{ review.store.address }}</p>
                            <p><strong>판매 시간:</strong> {{ review.store.sale_hours }}</p>
                            <p><strong>가격:</strong> {{ review.reservation.total_price }}원</p>
                        </div>
                    </div>
                    <div class="res-card-info" style="margin-top:10px;">
                        <!-- 별점 -->
                        <p>
                            <span class="review-stars">
                                {% for i in "12345" %}
                                    {% if i|add:0 <= review.rating %}★{% else %}☆{% endif %}
                                {% endfor %}
                            </span>
                        </p>
                        <!-- 키워드들 (예: review.keywords가 리스트라면) -->
                        {% if review.keywords %}
                            <p>
                                <strong>키워드:</strong>
                                {% for kw in review.keywords %}
                                    <span class="badge badge-info">{{ kw }}</span>
                                {% endfor %}
                            </p>
                        {% endif %}
                        <p>{{ review.content|truncatewords:20 }}</p>
                        <p style="font-size: 0.8em; color: #aaa;">{{ review.created_at|date:"Y.m.d" }}</p>
                    </div>
                </div>
            {% empty %}
                <p style="text-align:center; color: #aaa;">작성한 리뷰가 없습니다.</p>
            {% endfor %}
        </div>
    </div>

</div>
<script>
document.body.addEventListener('click', function(e) {
    if (e.target.classList.contains('pickup-complete-btn')) {
        const reservationId = e.target.dataset.pk;
        fetch(`/reservations/${reservationId}/pickup/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = "{% url 'users:buyer_home' %}";
            } else {
                alert(data.message || '상태 변경 실패');
            }
        });
    }
});
</script>
{% endblock %}

