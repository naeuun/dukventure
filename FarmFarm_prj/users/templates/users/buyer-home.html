{% extends "base_2.html" %} 
{% load static %} 

{% block style %}
<link rel="stylesheet" href="{% static 'css/consumer_home/consumer_main.css' %}"/>
<link rel="stylesheet" href="{% static 'css/consumer_home/consumer_profile.css' %}"/>
{% endblock style %} 

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- ÌîÑÎ°úÌïÑ ÏàòÏ†ï Í¥ÄÎ†® Î°úÏßÅ ---
    const fileInput = document.getElementById('modal_item_photo');
    const fileNamePreview = document.getElementById('fileNamePreview');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if(file) {
                fileNamePreview.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const btn = document.querySelector('.edit-item-btn[data-id="'+modalId.value+'"]');
                    const parent = btn.closest('.information_hugger');
                    const imgTag = parent.querySelector('.product-img');
                    imgTag.src = e.target.result;
                }
                reader.readAsDataURL(file);
            } else {
                fileNamePreview.textContent = "ÏÑ†ÌÉùÎêú ÌååÏùº ÏóÜÏùå";
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const profileEditModal = document.getElementById('profileEditModal');
    const profileEditBtn = document.getElementById('editProfileBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const profileImageEditBtn = document.querySelector('.image-edit-btn');
    const profileImageInput = document.getElementById('profileImageInput');
    const profileEditForm = document.getElementById('profileEditForm');
    
    if (profileEditBtn) {
        profileEditBtn.addEventListener('click', function(e){
            e.preventDefault();
            if(profileEditModal) profileEditModal.style.display = 'flex';
        });
    }
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if(profileEditModal) profileEditModal.style.display = 'none';
        });
    }

    if(profileImageEditBtn && profileImageInput){
        profileImageEditBtn.addEventListener('click', function(e){
            e.preventDefault();
            profileImageInput.click();
        });
    }

    if (profileImageInput) {
        profileImageInput.addEventListener('change', function(){
            var formData = new FormData(profileEditForm);
            formData.append('edit_type', 'image');
            $.ajax({
                url: "{% url 'users:profile_edit' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': csrftoken },
                success: function(response){
                    document.getElementById('profileImage').src = response.new_image_url + "?t=" + new Date().getTime();
                    document.querySelector('.preview_img').src = response.new_image_url + "?t=" + new Date().getTime();
                    location.reload();
                },
                error: function(err){
                    console.log(err);
                    alert("ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ïã§Ìå®");
                }
            });
        });
    }

    const nicknameBtn = profileEditForm ? profileEditForm.querySelector('button[name="edit_type"][value="name"]') : null;
    if (nicknameBtn) {
        nicknameBtn.addEventListener('click', function(e){
            e.preventDefault();
            var formData = new FormData(profileEditForm);
            formData.append('edit_type', 'name');
            $.ajax({
                url: "{% url 'users:profile_edit' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': csrftoken },
                success: function(){
                    alert("Ïù¥Î¶ÑÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.");
                    location.reload();
                },
                error: function(err){
                    console.log(err);
                    alert("ÎãâÎÑ§ÏûÑ ÏàòÏ†ï Ïã§Ìå®");
                }
            });
        });
    }

    // --- Î¶¨ÏõåÎìú Î∞è Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Î°úÎî© Î°úÏßÅ ---
    const characterMainImages = {
        1: "{% static 'img/level1.png' %}",
        2: "{% static 'img/level2.png' %}",
        3: "{% static 'img/level3.png' %}",
    };
    const characterStyles = {
        1: { transform: 'scale(1.0)', marginTop: '40px', marginLeft: '0px' },
        2: { transform: 'scale(0.9)', marginTop: '30px', marginLeft: '0px' },
        3: { transform: 'scale(1.1)', marginTop: '30px', marginLeft: '0px' }
    };
    const thumbnailStyles = {
        1: { transform: 'scale(1.5)' },
        2: { transform: 'scale(1.0)' },
        3: { transform: 'scale(3.0)', marginTop: '50px' },
    };
     const stampOnImages = [
        "{% static 'img/stamps/stamp_on.png' %}",
        "{% static 'img/stamps/stamp_on2.png' %}",
        "{% static 'img/stamps/stamp_on3.png' %}",
    ];
    const stampOffImages =[
        "{% static 'img/stamps/stamp_off.png' %}",
        "{% static 'img/stamps/stamp_off2.png' %}",
        "{% static 'img/stamps/stamp_off3.png' %}",
    ];
    async function fetchRewardStatus() {
        try {
            const response = await fetch("{% url 'rewards:get_reward_status' %}");
            if (!response.ok) throw new Error('Î¶¨ÏõåÎìú Ï†ïÎ≥¥ Î°úÎî© Ïã§Ìå®');
            const data = await response.json();
            updateRewardUI(data);
        } catch (error) {
            console.error('Î¶¨ÏõåÎìú Ï†ïÎ≥¥ Î°úÎî© Ïò§Î•ò:', error);
        }
    }

    function updateRewardUI(data) {
        const levelText = document.getElementById('character-level-text');
        if(levelText) levelText.textContent = data.character_level;
        
        const characterLevel = data.character_level;
        const mainImage = document.getElementById('character-main-image');

        if (mainImage) {
            mainImage.src = characterMainImages[characterLevel] || characterMainImages[1];
            const styles = characterStyles[characterLevel] || characterStyles[1];
            mainImage.style.transform = styles.transform;
            mainImage.style.marginTop = styles.marginTop;
            mainImage.style.marginLeft = styles.marginLeft;
        }
        
        const arrow = document.getElementById('level-arrow');
        document.querySelectorAll('.level-thumbnail').forEach((thumb, index) => {
            const level = index + 1;
            
            const thumbStyle = thumbnailStyles[level] || { transform: 'scale(1.0)' };
            thumb.style.transform = thumbStyle.transform;
            thumb.style.border = 'none';

            if (level === characterLevel) {
                thumb.style.opacity = '1';
                if(arrow) {
                    setTimeout(() => {
                        const arrowOffset = thumb.offsetLeft + (thumb.offsetWidth / 2) - (arrow.offsetWidth / 2);
                        arrow.style.left = `${arrowOffset}px`;
                        arrow.style.display = 'block';
                    }, 50);
                }
            } else {
                thumb.style.opacity = '0.6';
            }
        });

        const basePercentage = { 'NONE': 0, 'BRONZE': 25, 'SILVER': 50, 'GOLD': 75 };
        let growthPercentage = (basePercentage[data.medal_tier] || 0) + (data.stamp_count * 6.25);
        if (data.medal_tier === 'GOLD') {
             growthPercentage = 100;
        }
        growthPercentage = Math.min(Math.floor(growthPercentage) + 25, 100);

        const circleBar = document.getElementById('growth_chart_circle');
        const circleText = document.getElementById('growth_percent_text');
        if (circleBar && circleText) {
            const radius = circleBar.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (growthPercentage / 100) * circumference;
            
            circleBar.style.strokeDashoffset = offset;
            circleText.textContent = `${growthPercentage}%`;
        }

        const stampsGrid = document.getElementById('stamps-grid-container');
        if (stampsGrid) {
            stampsGrid.innerHTML = '';
            const medalToStampCount = { 'NONE': 0, 'BRONZE': 4, 'SILVER': 8, 'GOLD': 12 };
            const totalStamps = data.medal_tier === 'GOLD' ? 12 : (medalToStampCount[data.medal_tier] || 0) + data.stamp_count;

            for (let i = 0; i < 12; i++) {
                const img = document.createElement('img');
                if (i < totalStamps) {
                    // ÌöçÎìùÌïú Ïä§ÌÉ¨ÌîÑÏùº Í≤ΩÏö∞, ON Ïù¥ÎØ∏ÏßÄ Î∞∞Ïó¥ÏóêÏÑú Î¨¥ÏûëÏúÑÎ°ú ÌïòÎÇòÎ•º ÏÑ†ÌÉù
                    const randomIndex = Math.floor(Math.random() * stampOnImages.length);
                    img.src = stampOnImages[randomIndex];
                } else {
                    // ÌöçÎìùÌïòÏßÄ Î™ªÌïú Ïä§ÌÉ¨ÌîÑÏùº Í≤ΩÏö∞, OFF Ïù¥ÎØ∏ÏßÄ Î∞∞Ïó¥ÏóêÏÑú Î¨¥ÏûëÏúÑÎ°ú ÌïòÎÇòÎ•º ÏÑ†ÌÉù
                    const randomIndex = Math.floor(Math.random() * stampOffImages.length);
                    img.src = stampOffImages[randomIndex];
                }
                img.style.width = '100%';
                img.style.objectFit = 'contain';
                stampsGrid.appendChild(img);
            }
        }
    }
    fetchRewardStatus();
    
    const reviewModal = document.getElementById('review-modal');
    const reviewModalContent = document.getElementById('review-modal-content');

    document.body.addEventListener('click', async function(event) {
        const target = event.target;

        // 'ÌîΩÏóÖ ÏôÑÎ£å' Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        if (target.classList.contains('pickup-complete-btn')) {
            const reservationId = target.dataset.pk;
            if (!confirm('ÌîΩÏóÖÏùÑ ÏôÑÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            const url = `/reservations/${reservationId}/change-status/`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert(data.message || 'ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®');
                }
            } catch(error) {
                alert('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // 'Î¶¨Î∑∞Ïì∞Í∏∞' Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        if (target.classList.contains('write-review-btn')) {
            const reservationId = target.dataset.pk;
            const storeName = target.dataset.storeName;
            openReviewModal(reservationId, storeName);
        }
        
        // 'Î¶¨Î∑∞ ÏÇ≠Ï†ú' Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        if (target.classList.contains('delete-review-btn')) {
            const reviewId = target.dataset.reviewId;
            if (confirm('Ï†ïÎßêÎ°ú Ïù¥ Î¶¨Î∑∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                handleReviewDelete(reviewId);
            }
        }

        // Î™®Îã¨ Îã´Í∏∞ Î≤ÑÌäº ÎòêÎäî Î™®Îã¨ Î∞îÍπ• ÏòÅÏó≠ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        if (target.classList.contains('close-modal') || target === reviewModal) {
            closeReviewModal();
        }
    });

    // --- Î¶¨Î∑∞ ÏÇ≠Ï†úÎ•º ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ÌïòÎäî Ìï®Ïàò ---
    async function handleReviewDelete(reviewId) {
        const url = `/reviews/${reviewId}/delete/`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById(`review-card-${reviewId}`).remove();
                alert(data.message);
            } else {
                alert('Ïò§Î•ò: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Î¶¨Î∑∞ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
    }

    // --- Î¶¨Î∑∞ Í¥ÄÎ†® Ìï®ÏàòÎì§ ---
    async function openReviewModal(reservationId, storeName) {
        try {
            const response = await fetch(`/reviews/create/${reservationId}/`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Î¶¨Î∑∞ ÌèºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
            const formHtml = await response.text();
            
            if (reviewModalContent) {
                 reviewModalContent.innerHTML = `
                    <span class="close-modal" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
                    ${formHtml}
                `;
            }
            if (reviewModal) reviewModal.style.display = 'flex';
        } catch (error) {
            console.error('Error opening review modal:', error);
            alert(error.message);
        }
    }

    function closeReviewModal() {
        if (reviewModal) reviewModal.style.display = 'none';
    }

    // --- Î¶¨Î∑∞ Ìèº Ï†úÏ∂ú Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ ---
    if (reviewModal) {
        reviewModal.addEventListener('submit', async function(event) {
            if (event.target.tagName === 'FORM') {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken }
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message);
                        window.location.reload();
                    } else {
                        throw new Error(result.message || 'Î¶¨Î∑∞ Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    alert(`Ïò§Î•ò: ${error.message}`);
                }
            }
        });
    }
});
</script>
{% endblock script %} 

{% block body %}
<div class="big_hugger">
    <div class="top-section">
        <div class="profile-section">
            <div class="logo">
                <img src="{% static 'img/background.png' %}" alt="" />
                <img src="{% static 'img/background2.png' %}" alt="" />
            </div>
            <div class="welcome-box">
                <a href="{% url 'users:logout' %}" class="logoutbtn">
                    <img src="{% static 'img/logout_btn.png' %}" alt="Î°úÍ∑∏ÏïÑÏõÉ" />
                </a>
                <div class="backgroundimg">
                    <img src="{% static 'img/Rounded rectangle.svg' %}" alt="" />
                </div>
                <div class="profile-info">
                    <div class="profile-text">
                        <div class="textbox">
                            <span class="nickname-highlight">
                                <span class="nickname">{{ request.user.username }}</span>
                            </span>
                            <span class="welcome-text">Îãò Î∞òÍ∞ÄÏõåÏöî!</span>
                            <img src="{% static 'img/emo1.png' %}" alt="" />
                        </div>

                        <div class="textbox1">
                            <div class="firstmsg">
                                Ïò§Îäò Î≠ê Î®πÏùÑÍπå?
                                <img src="{% static 'img/emo2.png' %}" alt="" class="pic" />
                            </div>
                            <div class="desc-text">
                                Í∑ºÏ≤ò <span class="green_small">ÎÖ∏Ï†ê</span>ÏóêÏÑú
                                <span class="green_small">Ïã†ÏÑ†ÌïòÍ≤å</span> Ïû•Î¥êÎ¥êÏöî!
                            </div>
                            <div class="lastmsg">
                                <span class="desc-text">ÏßÄÍ∏à ÎÇ¥ Í∑ºÏ≤ò, Ïû•Î≥¥Îäî Í∞ÄÏû• Îî∞ÎúªÌïú Î∞©Î≤ï "</span>
                                <span class="farmfarm">ÌåúÌåú</span>"
                                <img src="{% static 'img/emo3.png' %}" alt="" class="pic" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="profile-box">
                    <img src="{% static 'img/Union.png' %}" alt="" class="profile_hugger" />
                    <div class="profile-edit">
                        <img id="profileImage" src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}/static/img/default_profile.png{% endif %}" alt="ÌîÑÎ°úÌïÑ" />
                    </div>
                    <div class="level-box">
                        <p class="nickname">
                            {{ request.user.username }}
                            <img id="editProfileBtn" src="{% static 'img/edit.png' %}" alt="ÏàòÏ†ï" style="cursor: pointer" />
                        </p>
                        <p class="level">
                            LV. <span id="character-level-text">1</span>
                            <img src="{% static 'img/level.png' %}" alt="" class="medal"/>

                        </p>
                    </div>
                </div>
            </div>
<div class="modal-overlay" id="profileEditModal" style="display: none;">
    <div class="modal-content">
        <form id="profileEditForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-actions">
                <button type="button" id="closeModalBtn">√ó</button>
            </div>
            <div class="nickname-row">
                <input type="text" id="nicknameInput" value="{{ request.user.username }}" name="username">
                <button type="button" name="edit_type" value="name" style="background: none; border: none; cursor: pointer;">
                    <img class="nickname-edit-btn" src="{% static 'img/edit.png' %}" alt="ÎãâÎÑ§ÏûÑ ÏàòÏ†ï">
                </button>
            </div>
            <div class="image-row">
                <div class="image-preview">
                    <input type="file" name="profile_image" id="profileImageInput" style="display:none;">
                    <img src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}/static/img/edit.png{% endif %}" alt="ÌîÑÎ°úÌïÑ ÎØ∏Î¶¨Î≥¥Í∏∞" class="preview_img">
                    <img class="image-edit-btn" src="{% static 'img/edit.png' %}" alt="Ïù¥ÎØ∏ÏßÄ ÏàòÏ†ï" style="cursor: pointer;">
                </div>
            </div>
        </form>
    </div>
</div>

        </div>
        <div class="line"></div>
    </div>

    <div class="bottom-section">
        
        <div class="cha_section">
            <div class="character">ÎßàÏù¥ Ï∫êÎ¶≠ÌÑ∞ üß∏</div>
        </div>
        <div class="information_zone">
            <div class="information-card">
                <div class="info-wrapper">
                    <div class="information_cha">
                        <div class="thumbnail-row">
                            <img id="level-arrow" src="{% static 'img/arrow.png' %}" alt="current level">
                             <div class="thumbnail-wrapper">
                                <img id="level-thumb-1" class="level-thumbnail" src="{% static 'img/level1.png' %}" alt="Lv.1">
                            </div>

                            <div class="thumbnail-wrapper">
                                <img id="level-thumb-2" class="level-thumbnail" src="{% static 'img/level2.png' %}" alt="Lv.2">
                            </div>

                            <div class="thumbnail-wrapper">
                                <img id="level-thumb-3" class="level-thumbnail" src="{% static 'img/level3.png' %}" alt="Lv.3">
                            </div>
                        </div>
                        <div class="main-image-container">
                            <img id="character-main-image" class="main-character" src="{% static 'img/level1.png' %}" alt="Î©îÏù∏ Ï∫êÎ¶≠ÌÑ∞">
                        </div>
                    </div>
                    <div class="information_detail">
                        <div class="cha_name" id="character-name">Ïù¥Î¶Ñ:</div>
                        <div class="cha_nic">{{ user.username }}</div>
                        <div class="cha_growth">ÏÑ±Ïû•ÌçºÏÑºÌä∏:</div>
                        <div class="growth_chart">
                            <svg width="80" height="80" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#5a6051" stroke-width="8"></circle>
                                <circle id="growth_chart_circle" cx="50" cy="50" r="45" fill="none" stroke="#C1FF52" stroke-width="8" stroke-linecap="round" style="stroke-dasharray: 283; stroke-dashoffset: 283;"></circle>
                            </svg>
                            <div id="growth_percent_text" class="growth_percent">0%</div>
                        </div>
                    </div>
                </div>
                <div class="more">
                    <a href="{% url 'rewards:reward_page' %}">
                        <img src="{% static 'img/more.png' %}" alt="ÎßàÏù¥Ï∫êÎ¶≠ÌÑ∞ ÎçîÎ≥¥Í∏∞" class="cha_more">
                    
                        <img class="rew_gra" src="{% static 'img/cha_gra.png' %}" alt="Ïû•Ïãù">
                    </a>     
                </div>
            </div>
        </div>

        <div class="rew_section">
            <div class="character">Î¶¨ÏõåÎìú ÌòÑÌô© üß©</div>
        </div>
        <div class="information2-card">
            <div class="rew_total" id="stamps-grid-container" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 100%; align-content: center; padding: 20px;">
                </div>
            <div class="more">
                <img class="rew_gra" src="{% static 'img/rew_gra.png' %}" alt="Ïû•Ïãù">
            </div>
        </div>

        <div class="res_section">
            <div class="reservation">ÏßÑÌñâÏ§ëÏù∏ ÏòàÏïΩ<img src="{% static 'img/res_icon.png' %}" alt="ÏòàÏïΩ ÌòÑÌô© ÏïÑÏù¥ÏΩò" class="res_check"></div>
        </div>
        <div class="information_zone">
            <div class="res_res">
                <div class="information3-card">
                    <div class="more">
                        <a href="{% url 'reservations:list' %}"><img src="{% static 'img/res_more.png' %}" alt="ÏòàÏïΩ ÌòÑÌô© ÎçîÎ≥¥Í∏∞" class="res_more"></a>
                    </div>
                    {% for r in active_reservations|dictsortreversed:"created_at"|slice:":3" %}
                    <div class="{% if forloop.counter == 1 %}res_detial{% elif forloop.counter == 2 %}second_detail{% else %}back_detail{% endif %}">
                        {% for item in r.items.all %}
                        <div class="{% if forloop.parentloop.counter == 1 %}detail_img{% else %}details_img{% endif %}">
                            {% if item.image %}
                            <img src="{{ item.image.url }}" alt="{{ item.item_name }}" class="tomato">
                            {% else %}
                            <img src="https://placehold.co/300x150/2a2a2a/cccccc?text={{ item.item_name|default:'ÏÉÅÌíà' }}" alt="{{ item.item_name }}" class="tomato">
                            {% endif %}
                        </div>
                        <div class="{% if forloop.parentloop.counter == 1 %}detail_txt{% else %}details_txt{% endif %}">
                            <span>
                                ÌåêÎß§Ïûê: {{ r.store.name }} <br>
                                ÏúÑÏπò: {{ r.store.address }} <br>
                                ÌåêÎß§ ÏãúÍ∞Ñ: {{ r.store.sale_hours }} <br>
                                Í∞ÄÍ≤©:(Ï¥ù {{ item.quantity }}Í∞ú) {{ r.total_price }}Ïõê <br>
                                ÏÉÅÌÉú: {{ r.get_status_display }} <br>
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% empty %}
                    <p style="color:white;">ÏòàÏïΩÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="buy_section">
            <div class="character1">Íµ¨Îß§ ÎÇ¥Ïó≠<img src="{% static 'img/buy_icon.png' %}" alt="Íµ¨Îß§ ÎÇ¥Ïó≠ ÏïÑÏù¥ÏΩò" class="buy_icon"></div>
            <div class="information_zone">
                <div class="res_res">
                    <section class="information4-card">
                        <div class="history_container">
                            {% for r in past_reservations|slice:":3" %}
                            <article class="history_card card--{{ forloop.counter }} {% if forloop.first %}active{% endif %}">
                                <div class="card_img">
                                    {% with item=r.items.first %}
                                    {% if item.image %}
                                    <img src="{{ item.image.url }}" alt="{{ item.item_name }}">
                                    {% else %}
                                    <img src="https://placehold.co/120x80/2a2a2a/cccccc?text={{ item.item_name|default:'ÏÉÅÌíà' }}" alt="{{ item.item_name }}">
                                    {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="panel">
                                    <span class="date">{{ r.created_at|date:"Y.m.d" }}</span>
                                    <h3>[{{ r.store.name }} | {{ r.store.seller.user.username }}]</h3>
                                    <ul>
                                        <li>ÌíàÎ™©: {% for item in r.items.all %}{{ item.item_name }}{% if not forloop.last %}, {% endif %}{% endfor %}</li>
                                        <li>ÏúÑÏπò: {{ r.store.address }}</li>
                                        <li>ÌåêÎß§ ÏãúÍ∞Ñ: {{ r.store.sale_hours }}</li>
                                        <li>Í∞ÄÍ≤©: {{ r.total_price }}Ïõê</li>
                                    </ul>
                                </div>
                            </article>
                            {% empty %}
                            <p style="text-align:center; color: #aaa;">ÏßÄÎÇú Íµ¨Îß§ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                            {% endfor %}
                            <div class="card_reflection" aria-hidden="true"></div>
                        </div>
                        <div class="more">
                            <a href="{% url 'reservations:purchase-list' %}">
                                <img src="{% static 'img/res_more.png' %}" alt="Íµ¨Îß§ ÎÇ¥Ïó≠ ÎçîÎ≥¥Í∏∞" class="res_more">
                                <img src="{% static 'img/rew_gra.png' %}" alt="Î¶¨ÏõåÎìú ÌòÑÌô© ÏïÑÏù¥ÏΩò" class="rew_gra">
                            </a>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div class="rev_section">
            <div class="character1">ÎÇ¥Í∞Ä Ïì¥ Î¶¨Î∑∞<img src="{% static 'img/rev_icon.png' %}" alt="Î¶¨Î∑∞ ÏïÑÏù¥ÏΩò" class="rev_icon"></div>
            <div class="review_hugger">
                <img src="{% static 'img/review_deco.png' %}" alt="Î¶¨Î∑∞Îç∞ÏΩî" class="review_deco">
                {% for review in reviews|slice:":6" %}
                <div class="per_review" id="review-card-{{ review.id }}">
                    <div class="reviewer_profile">
                        <img src="{% if review.photo %}{{ review.photo.url }}{% else %}/static/img/smiling_brocoli.png{% endif %}" alt="ÎÇ¥ ÌîÑÎ°úÌïÑ" class="r_profile_p">
                    </div>
                    <div class="stars">
                        {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}
                        <img src="{% static 'img/starscore_filled.png' %}" alt="Î≥ÑÏ†ê" class="per_star">
                        {% else %}
                        <img src="{% static 'img/starscore.png' %}" alt="Îπà Î≥Ñ" class="per_star">
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div class="r_store_info">
                        <p><strong>[{{ review.store.name }}]</strong></p>
                        <ul class="r_store_info_small">
                            <li>ÏúÑÏπò: {{ review.store.address }}</li>
                            <li>ÌåêÎß§ ÏãúÍ∞Ñ: {{ review.store.sale_hours }}</li>
                        </ul>
                    </div>
                    <div class="review_content">
                        {{ review.content|truncatewords:20 }}
                        <div class="keywords">
                        {% for keyword in review.get_keywords_as_list %}
                        <span>#{{ keyword }}</span>
                    {% endfor %}
                    </div>
                    </div>
                    <div class="date">{{ review.created_at|date:"Y.m.d" }}</div>
                </div>
                {% empty %}
                <p style="text-align:center; color:#999;">ÏûëÏÑ±Ìïú Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="review-modal" class="modal">
    <div class="modal-content-review">
        <div id="review-modal-content">
            </div>
    </div>
</div>

<div class="nav_box">
    {% if user.usertype == 'BUYER' %}
    <nav class="bottom_nav">
        <img src="{% static 'img/now_page.png' %}" alt="ÌòÑÏû¨ ÌéòÏù¥ÏßÄ" class="now_page">
        <div class="btn"><a href="{% url 'stores:map' %}"><img src="{% static 'img/map_page_gray.png' %}" alt="ÏßÄÎèÑÌéòÏù¥ÏßÄ" class="map_page"></a></div>
        <div class="btn selected_nav"><a href="{% url 'users:buyer_home' %}"><img src="{% static 'img/home_page_black.png' %}" alt="ÌôàÌéòÏù¥ÏßÄ" class="home_page"></a></div>
        <div class="btn"><a href="{% url 'shopping:ai_shopping' %}"><span class="shopping_page">AI</span></a></div>
    </nav>
    {% elif user.usertype == 'SELLER' %}
    <nav class="bottom_nav">
        <img src="{% static 'img/now_page.png' %}" alt="ÌòÑÏû¨ ÌéòÏù¥ÏßÄ" class="now_page">
        <div class="btn"><a href="{% url 'stores:map' %}"><img src="{% static 'img/map_page_gray.png' %}" alt="ÏßÄÎèÑÌéòÏù¥ÏßÄ" class="map_page"></a></div>
        <div class="btn selected_nav"><a href="{% url 'users:seller_home' %}"><img src="{% static 'img/home_page_black.png' %}" alt="ÌôàÌéòÏù¥ÏßÄ" class="home_page"></a></div>
        <div class="btn"><a href="{% url 'reservations:seller_list' %}"><span class="shopping_page">ÏòàÏïΩ</span></a></div>
    </nav>
    {% endif %}
</div>
{% endblock body %}