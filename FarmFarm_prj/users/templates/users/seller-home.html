{% extends "users/base_home.html" %}
{% load static %}
{% block role_content %}
<hr>
<h3>가게 정보 🎇</h3>
{% if store %}
    <div style="display:flex; align-items:center; gap:16px;">
        <div>
            <h4>{{ store.name }}</h4>
            <p><b>판매자 :</b> {{ store.seller.name|default:store.seller.user.username }}</p>
            <a href="{% url 'stores:edit_store' store.id %}">가게 정보 수정</a>
        </div>
    </div>
    {% if store.photo %}
        <img src="{{ store.photo.url }}" alt="가게 사진" style="width:300px; height:auto; display:block; margin-bottom:10px;">
    {% else %}
        <img src="{% static 'img/default_store.png' %}" alt="기본 가게 사진" style="width:300px; height:auto; display:block; margin-bottom:10px;">
    {% endif %}
    {{ store.description }} <br>
    {% for store_item in store.store_items.all %}
        <div style="border:1px solid #eee; padding:16px; margin-bottom:16px; position:relative;">
            {% if store_item.photo %}
                <img src="{{ store_item.photo.url }}" alt="품목 사진" style="width:200px; height:auto; display:block; margin-bottom:10px;">
            {% else %}
                <img src="{% static 'img/default_item.png' %}" alt="기본 품목 사진" style="width:200px; height:auto; display:block; margin-bottom:10px;">
            {% endif %}
            <p><b>품목명:</b> {{ store_item.item.name }}</p>
            <p><b>위치:</b> {{ store.address }}</p>
            <p><b>판매 시간:</b> {{ store.sale_hours }}</p>
            <p><b>가격:</b> {{ store_item.price }}원</p>
            <span>{{ store_item.description }}</span>
            <button type="button" class="edit-item-btn"
                data-id="{{ store_item.id }}"
                data-name="{{ store_item.item.name }}"
                data-price="{{ store_item.price }}"
                data-desc="{{ store_item.description }}"
                data-photo-name="{% if store_item.photo %}{{ store_item.photo.name }}{% else %}{% endif %}">
                ✏️ 품목 수정
            </button>
        </div>
    {% empty %}
        <div>등록된 품목이 없습니다.</div>
    {% endfor %}
{% else %}
    <p>아직 등록된 가게가 없습니다.</p>
    <button type="button"><a href="{% url 'stores:register' %}">가게 등록하기</a></button>
{% endif %}

<!-- 품목 수정 모달 -->
<div id="editItemModal" style="display:none; position:fixed; top:20%; left:35%; width:30%; background:#fff; z-index:3000; border:1px solid #ccc; box-shadow:0 2px 8px rgba(0,0,0,0.2); padding:20px;">
    <form id="editItemForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="item_id" id="modal_item_id">
        <label>품목명</label>
        <input type="text" name="item_name" id="modal_item_name"><br>
        <label>가격</label>
        <input type="number" name="item_price" id="modal_item_price"><br>
        <label>설명</label>
        <input type="text" name="item_desc" id="modal_item_desc"><br>
        <label>사진</label>
        <input type="file" name="item_photo" id="modal_item_photo" accept="image/*"><br>
        <button type="submit">저장</button>
        <button type="button" id="closeEditItemModal">닫기</button>
    </form>
</div>

<script>
document.querySelectorAll('.edit-item-btn').forEach(function(btn) {
    btn.onclick = function() {
        document.getElementById('editItemModal').style.display = 'block';
        document.getElementById('modal_item_id').value = btn.dataset.id;
        document.getElementById('modal_item_name').value = btn.dataset.name;
        document.getElementById('modal_item_price').value = btn.dataset.price;
        document.getElementById('modal_item_desc').value = btn.dataset.desc;
        document.getElementById('editItemForm').action = "/stores/edit_item/" + btn.dataset.id + "/"; // edit_item URL로 지정
        document.getElementById('modal_item_photo_name').textContent =
            btn.dataset.photoName ? btn.dataset.photoName : "";
    };
});
document.getElementById('closeEditItemModal').onclick = function() {
    document.getElementById('editItemModal').style.display = 'none';
};
</script>
{% endblock %}