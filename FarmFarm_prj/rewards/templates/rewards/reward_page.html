{% extends "base_2.html" %}
{% load static %}

{# ---------- STYLE ---------- #}
{% block style %}
<link rel="stylesheet" href="{% static 'css/consumer_home/character_home.css' %}" />
{% endblock style %}

{# ---------- BODY ---------- #}
{% block body %}
<div class="big_hugger">
  <div class="character-home">
    <div class="top-section">
      <!-- 상단 캐릭터 메인 -->
      <a href="{% url 'users:buyer_home' %}">
        <img src="{% static 'img/cha_exit.png' %}" alt="캐릭터 상세화면 나가기" class="cha_exit" />
      </a>
      <img src="{% static 'img/cha_gra2.png' %}" alt="캐릭터 상세화면 상단 데코" class="cha_gra" />
      <img src="{% static 'img/cha_gra22.png' %}" alt="캐릭터 상세화면 상단 데코2" class="cha_gra2" />

      <div class="character-main">
        <div class="character-image">
          <img id="character-main-image" class="main-character"
               src="{% static 'img/cha1.png' %}" alt="마이캐릭터 메인" />
        </div>
        <!-- 오른쪽 정보 -->
        <div class="information_detail">
          <div class="cha_name" id="character-name">이름:</div>
          <div class="cha_nic">{{ user.username }}</div>

          <button type="button" class="name-pop-open" aria-controls="nameEditPopover" aria-expanded="false">
            <img src="{% static 'img/edit.png' %}" alt="이름 수정" class="edit" />
          </button>

          <!-- 이름 수정 팝업 -->
          <!-- .information_detail 내부 어딘가(연필 버튼 근처)에 배치 -->
        {% comment %} <div id="profileEditModal" class="name-edit-popover" role="dialog" aria-modal="true" aria-hidden="true">
          
            <button type="button" class="name-pop-close" id="closeModalBtn">×</button>

            <div class="nickname-row">
                <input type="text" id="nicknameInput" class="name-input"
                    value="{{ request.user.username }}" name="username">
                <button type="button" class="name-pop-save" name="edit_type" value="name">
                    <img class="edit" src="{% static 'img/edit.png' %}" alt="닉네임 저장">
                </button>
            </div>
        </div> {% endcomment %}
        
        <div class="modal-overlay" id="profileEditModal" style="display: none;">
          <div class="modal-content">
            <form id="profileEditForm" method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <!-- ✅ 서버 분기용 hidden 필드 꼭 필요 -->
              <input type="hidden" name="edit_type" value="name" />

              <div class="modal-actions">
                <button type="button" id="closeModalBtn">×</button>
              </div>

              <div class="nickname-row">
                <input type="text" id="nicknameInput" name="username" value="{{ request.user.username }}">
                <!-- ✅ JS가 찾는 id 부여 -->
                <button type="button" id="saveNicknameBtn" style="background:none;border:none;cursor:pointer;">
                  <img class="nickname-edit-btn" src="{% static 'img/edit.png' %}" alt="닉네임 수정">
                </button>
              </div>

              
            </form>
          </div>
        </div>


          <div class="cha_growth">성장퍼센트:</div>
          <div class="growth_chart">
            <svg width="80" height="80" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="#5a6051" stroke-width="8"></circle>
              <circle id="growth_chart_circle" cx="50" cy="50" r="45"
                      fill="none" stroke="#C1FF52" stroke-width="8" stroke-linecap="round"
                      style="stroke-dasharray: 283; stroke-dashoffset: 283;"></circle>
            </svg>
            <div id="growth_percent_text" class="growth_percent">0%</div>
        </div>
      </div>
    </div>

      <div class="line"></div>

      <!-- 리워드 하단 -->
      <div class="bottom-section2">
        <!-- 3등(동) -->
        <div class="cha_3th" style="background-image:url('{% static "img/level1.png" %}');
            background-repeat:no-repeat;
            background-position:-20px center;
            background-size:90% auto;">
          <!-- [수정된 부분] 이미지 경로를 올바르게 수정 -->
          <img src="{% static 'img/3th.png' %}" alt="캐릭터 3등" class="th" />
          <div class="stamps-row" id="stamps-bronze"></div>
          <div class="checkbox">
              <img src="{% static 'img/check.png' %}" alt="체크박스" class="check" id="check-bronze" style="display:none;" />
          </div>
        </div>

        <!-- 2등(은) -->
        <div class="cha_2th" style="background-image:url('{% static "img/level2.png" %}');
            background-repeat:no-repeat;
            background-position:78px center;
            background-size:40% auto;">
          <!-- [수정된 부분] 이미지 경로를 올바르게 수정 -->
          <img src="{% static 'img/2th.png' %}" alt="캐릭터 2등" class="th" />
          <div class="stamps-row" id="stamps-silver"></div>
          <div class="checkbox">
              <img src="{% static 'img/check.png' %}" alt="체크박스" class="check" id="check-silver" style="display:none;" />
          </div>
        </div>

        <!-- 1등(금) -->
        <div class="cha_1th" style="background-image:url('{% static "img/level3.png" %}');
            background-repeat:no-repeat;
            background-position:-9px calc(50% + 20px); 
            background-size:90% auto;">
          <!-- [수정된 부분] 이미지 경로를 올바르게 수정 -->
          <img src="{% static 'img/1th.png' %}" alt="캐릭터 1등" class="th" />
          <div class="stamps-row" id="stamps-gold"></div>
          <div class="checkbox">
              <img src="{% static 'img/check.png' %}" alt="체크박스" class="check" id="check-gold" style="display:none;" />
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- 네비게이션 -->
    <div class="nav_box">
      {% if user.usertype == 'BUYER' %}
      <nav class="bottom_nav">
        <img src="{% static 'img/now_page.png' %}" alt="현재 페이지" class="now_page">
        <div class="btn"><a href="{% url 'stores:map' %}"><img src="{% static 'img/map_page_gray.png' %}" alt="지도페이지" class="map_page"></a></div>
        <div class="btn selected_nav"><a href="{% url 'users:buyer_home' %}"><img src="{% static 'img/home_page_black.png' %}" alt="홈페이지" class="home_page"></a></div>
        <div class="btn"><a href="{% url 'shopping:ai_shopping' %}"><span class="shopping_page">AI</span></a></div>
      </nav>
      {% elif user.usertype == 'SELLER' %}
      <nav class="bottom_nav">
        <img src="{% static 'img/now_page.png' %}" alt="현재 페이지" class="now_page">
        <div class="btn"><a href="{% url 'stores:map' %}"><img src="{% static 'img/map_page_gray.png' %}" alt="지도페이지" class="map_page"></a></div>
        <div class="btn selected_nav"><a href="{% url 'users:seller_home' %}"><img src="{% static 'img/home_page_black.png' %}" alt="홈페이지" class="home_page"></a></div>
        <div class="btn"><a href="{% url 'reservations:seller_list' %}"><span class="shopping_page">예약</span></a></div>
      </nav>
      {% endif %}
    </div>
</div>
{% endblock body %}

{# ---------- SCRIPT ---------- #}
{% block script %}
<script src="{% static 'js/consumer_home/character_home.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("profileEditModal");
  const openBtn = document.querySelector(".name-pop-open");
  const closeBtn = document.getElementById("closeModalBtn");
  const form = document.getElementById("profileEditForm");
  const nicknameInput = document.getElementById("nicknameInput");
  const saveBtn = document.getElementById("saveNicknameBtn");
  const nicDisplay = document.querySelector(".cha_nic");

  function getCsrfToken() {
    const inp = form.querySelector('input[name="csrfmiddlewaretoken"]');
    return inp ? inp.value : "";
  }

  function openModal() {
    if (modal) modal.style.display = "block";
    nicknameInput && nicknameInput.focus();
  }
  function closeModal() {
    if (modal) modal.style.display = "none";
  }

  openBtn && openBtn.addEventListener("click", openModal);
  closeBtn && closeBtn.addEventListener("click", closeModal);
  modal && modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

  async function saveNickname() {
    const username = (nicknameInput?.value || "").trim();
    if (!username) { alert("닉네임을 입력하세요."); nicknameInput?.focus(); return; }
    const fd = new FormData(form);
    fd.set('edit_type', 'name'); // 안전망
    const res = await fetch("{% url 'users:profile_edit' %}", {
      method: "POST",
      headers: { "X-CSRFToken": getCsrfToken() },
      body: fd,
    });
    try {
      const res = await fetch("{% url 'users:profile_edit' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCsrfToken() },
        body: new FormData(form), // includes edit_type=name & username
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        const msg = data.errors ? JSON.stringify(data.errors) : "저장에 실패했습니다.";
        throw new Error(msg);
      }

      // 서버가 내려준 username 우선 사용 (뷰 보완 반영)
      const newName = data.username || username;
      if (nicDisplay) nicDisplay.textContent = newName;

      // (선택) 다른 탭/페이지와 동기화
      try {
        localStorage.setItem("usernameUpdatedAt", Date.now().toString());
        localStorage.setItem("usernameValue", newName);
      } catch (e) {}

      closeModal();
    } catch (err) {
      alert(err.message);
    }
  }

  saveBtn && saveBtn.addEventListener("click", saveNickname);
  nicknameInput && nicknameInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); saveNickname(); }
  });

  // (선택) 다른 탭에서 변경되면 현재 화면도 갱신
  window.addEventListener("storage", (e) => {
    if (e.key === "usernameUpdatedAt") {
      const v = localStorage.getItem("usernameValue");
      if (v && nicDisplay) nicDisplay.textContent = v;
    }
  });
});
document.addEventListener("DOMContentLoaded", function() {
    // --- 리워드 및 캐릭터 정보 로딩 로직 ---
    const characterMainImages = {
        0: "{% static 'img/level0.png' %}",
        1: "{% static 'img/level1.png' %}",
        2: "{% static 'img/level2.png' %}",
        3: "{% static 'img/level3.png' %}",
    };
    const characterStyles = {
        0: { transform: 'scale(0.5)', marginTop: '40px', marginLeft: '0px' },
        1: { transform: 'scale(1.0)', marginTop: '40px', marginLeft: '0px' },
        2: { transform: 'scale(0.9)', marginTop: '30px', marginLeft: '0px' },
        3: { transform: 'scale(1.1)', marginTop: '30px', marginLeft: '0px' }
    };
    const stampOnImages = [
        "{% static 'img/stamps/stamp_on.png' %}",
        "{% static 'img/stamps/stamp_on2.png' %}",
        "{% static 'img/stamps/stamp_on3.png' %}",
    ];
    const stampOffImages =[
        "{% static 'img/stamps/stamp_off.png' %}",
        "{% static 'img/stamps/stamp_off2.png' %}",
        "{% static 'img/stamps/stamp_off3.png' %}",
    ];

    async function fetchRewardStatus() {
        try {
            const response = await fetch("{% url 'rewards:get_reward_status' %}");
            if (!response.ok) throw new Error('리워드 정보 로딩 실패');
            const data = await response.json();
            updateRewardUI(data);
        } catch (error) {
            console.error('리워드 정보 로딩 오류:', error);
        }
    }

    function updateRewardUI(data) {
        // 총 스탬프 개수 계산
        const medalToStampCount = { 'NONE': 0, 'BRONZE': 4, 'SILVER': 8, 'GOLD': 12 };
        const totalStamps = data.medal_tier === 'GOLD' ? 12 : (medalToStampCount[data.medal_tier] || 0) + data.stamp_count;

        // 표시할 레벨 결정
        let displayLevel;
        if (totalStamps < 4) { displayLevel = 0; }
        else if (totalStamps < 8) { displayLevel = 1; }
        else if (totalStamps < 12) { displayLevel = 2; }
        else { displayLevel = 3; }

        // 메인 이미지 및 스타일 업데이트
        const mainImage = document.getElementById('character-main-image');
        if (mainImage) {
            mainImage.src = characterMainImages[displayLevel];
            const styles = characterStyles[displayLevel] || characterStyles[0];
            mainImage.style.transform = styles.transform;
            mainImage.style.marginTop = styles.marginTop;
            mainImage.style.marginLeft = styles.marginLeft;
        }

        // 성장률 퍼센트 업데이트
        const growthPercentage = Math.floor((totalStamps / 12) * 100);
        const circleBar = document.getElementById('growth_chart_circle');
        const circleText = document.getElementById('growth_percent_text');
        if (circleBar && circleText) {
            const radius = circleBar.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (growthPercentage / 100) * circumference;
            circleBar.style.strokeDashoffset = offset;
            circleText.textContent = `${growthPercentage}%`;
        }

        // 메달별 스탬프 및 체크박스 업데이트
        const bronzeStamps = Math.min(totalStamps, 4);
        const silverStamps = Math.min(Math.max(0, totalStamps - 4), 4);
        const goldStamps = Math.min(Math.max(0, totalStamps - 8), 4);

        renderStamps('stamps-bronze', bronzeStamps);
        renderStamps('stamps-silver', silverStamps);
        renderStamps('stamps-gold', goldStamps);

        document.getElementById('check-bronze').style.display = (totalStamps >= 4) ? 'block' : 'none';
        document.getElementById('check-silver').style.display = (totalStamps >= 8) ? 'block' : 'none';
        document.getElementById('check-gold').style.display = (totalStamps >= 12) ? 'block' : 'none';

        // ✅ 배경색 동적 변경: 완료(체크 있음) -> 녹색 / 미완료·진행중 -> 검정
        const bronzeDone = totalStamps >= 4;
        const silverDone = totalStamps >= 8;
        const goldDone   = totalStamps >= 12;

        const bronzeBox = document.querySelector('.cha_3th');
        const silverBox = document.querySelector('.cha_2th');
        const goldBox   = document.querySelector('.cha_1th');

        const GREEN_BG = 'rgba(193, 255, 82, 0.40)'; // 기존 녹색
        const BLACK_BG = '#000000';
        const GREEN_BORDER = '0.7px solid #000000';
        const BLACK_BORDER = '2px solid #C1FF52';

        function applyBoxStyle(box, done) {
          if (!box) return;
          box.style.backgroundColor = done ? GREEN_BG : BLACK_BG;
          box.style.border = done ? GREEN_BORDER : BLACK_BORDER;
        }

        applyBoxStyle(bronzeBox, bronzeDone);
        applyBoxStyle(silverBox, silverDone);
        applyBoxStyle(goldBox, goldDone);
    }

    function renderStamps(containerId, filledCount) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = ""; // 초기화
        for (let i = 0; i < 4; i++) {
            const img = document.createElement('img');
            if (i < filledCount) {
                img.src = stampOnImages[Math.floor(Math.random() * stampOnImages.length)];
            } else {
                img.src = stampOffImages[Math.floor(Math.random() * stampOffImages.length)];
            }
            container.appendChild(img);
        }
    }

    fetchRewardStatus();
});
</script>

{% endblock script %}